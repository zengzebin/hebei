define(["ol","handlebars","html!!mapPopup3","datatables","bootstrap-datetimepickerCN"],function(t,e,a){var n,i,r,o=function(){$dict.init({name:"stcdType",url:$cfg.baseUrl+"/OptionSelect/com-ssxt-op-stcdType/"}),$dict.init({name:"addvcd",url:$cfg.baseUrl+"/addvcd/loadAll/"}),$dict.init({name:"maintainer",url:$cfg.baseUrl+"/users/loadAll/?isOperation=1"}),$dict.init({name:"serviceType",url:$cfg.baseUrl+"/OptionSelect/com-ssxt-op-serviceType/"}),$dict.init({name:"station",url:$cfg.baseUrl+"/stinfo/loadAll/"}),$dict.init({name:"priority",url:$cfg.baseUrl+"/OptionSelect/com-ssxt-op-priority/"})},c=function(){$("#c_startTime").datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:!0,todayBtn:!0,pickerPosition:"bottom-left"}),$("#c_endTime").datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:!0,todayBtn:!0,pickerPosition:"bottom-left"});var t,e=[];t=$dict.initOptions({s2s:!0,elem:"#c_addvcd",dict:"addvcd",propText:"addvnm",propId:"addvcd",append:[{id:"-1",text:"全部"}],filter:function(t,e){var a=$.userData.addvcd;return"0000"===a.slice(-4)||"00"===a.slice(-2)&&t.addvcd.slice(0,-2)===a.slice(0,-2)||a===t.addvcd}}),e.push(t),$.when.apply($,e).done(function(){$("#c_startTime").attr("disabled","true"),$("#c_endTime").attr("disabled","true"),$("#c_startTime").val(moment().format("YYYY-MM-DD")).change(),$("#c_endTime").val(moment().format("YYYY-MM-DD")).change(),d()}),$("#c_time").on("change",function(){var t=$(this).val().toString();$("#c_startTime").attr("disabled","true"),$("#c_endTime").attr("disabled","true"),"1"===t?($("#c_startTime").val(moment().format("YYYY-MM-DD")).change(),$("#c_endTime").val(moment().format("YYYY-MM-DD")).change()):"2"===t?($("#c_startTime").val(moment().add(-6,"d").format("YYYY-MM-DD")).change(),$("#c_endTime").val(moment().format("YYYY-MM-DD")).change()):"3"===t?($("#c_startTime").val(moment().add(1,"d").add(-1,"M").format("YYYY-MM-DD")).change(),$("#c_endTime").val(moment().format("YYYY-MM-DD")).change()):"4"===t&&($("#c_startTime").val("").change(),$("#c_endTime").val("").change(),$("#c_startTime").removeAttr("disabled").trigger("attr.update"),$("#c_endTime").removeAttr("disabled").trigger("attr.update"))}),$("#b_refresh,#b_search").on("click",function(){d()})},d=function(){var t=$("#c_startTime").val(),e=$("#c_endTime").val();if(!t||!e)return void $toast.warning("开始时间或结束时间不能为空");i=t,r=e;var a=$.extend({},$opt.paramFilter({startTime:t,endTime:e,addvcd:$("#c_addvcd").val()})),o=$api.get({url:$cfg.baseUrl+"/report/assessment",data:a});$.when(o).done(function(t){if(t.success){n&&n.fnDestroy();var e=$.extend({},$plugin.datatable_local,{data:t.data,aaSorting:[[0,"desc"]],columns:[{title:"姓名",data:"name",class:"text-center"},{title:"排名",data:"ranking",class:"text-center"},{title:"所属区域",data:"addvcd",class:"text-center",fnCreatedCell:function(t,e,a,n,i){$dict.get("addvcd").then(function(a){$.each(a,function(a,n){n.addvcd===e&&$(t).html(n.addvnm)})})}},{title:"职位",data:"position",class:"text-center"},{title:"维修数量",data:"dealNum",class:"text-center"},{title:"请假次数",data:"vacation",class:"text-center"},{title:"维修质量",data:"maintenanceRate",class:"text-center",render:function(t,e,a){return(100*parseFloat(t)).toFixed(0)+"%"}},{title:"维修工作时长",data:"wordTime",class:"text-center"},{title:"操作",data:"userId",bSortable:!1,fnCreatedCell:function(t,e,a,n,i){var r=$('<a class="btn btn-info btn-xs ml-5"><i class="fa fa-file-o mr-5"></i>人员业绩查询</a>');r.on("click",function(){s(t,e,a,n,i)}),$(t).html("").append(r)}}]});n=$("#t_rating").dataTable(e)}else $toast.warning(t.msg)}).fail(function(t){$toast.error(t)})},s=function(t,e,a,n,o){var c=$msg.dialog("peopleratingAdd",function(t,e){},{title:"人员业绩查询 ("+i+" ~ "+r+")",modalClassName:"modal-lg",buttons:{success:{label:"确定",className:"btn-info"}}}),d=$api.get({url:$cfg.baseUrl+"/maintGps/RepairMileage/",data:{startTime:i,endTime:r,repairUserId:e}});$.when(c,d).then(function(t,n){var o=t.find("form.info-left"),c=t.find("form.info-right");o.formData($.extend({},a,{attendance:(100*parseFloat(a.attendance)).toFixed(0)+"%",maintenanceRate:(100*parseFloat(a.maintenanceRate)).toFixed(0)+"%",repairMileage:n.data+"公里"})),o.formDisable(!0);var d=$.extend({},$plugin.datatable_server,{fnServerData:function(t,a,n){var o=$.extend({},$opt.paramConvert(a),$opt.paramFilter({startTime:i,endTime:r,maintUserId:e,taskStatus:60})),c=$api.get({url:$cfg.baseUrl+"/task/history",data:o});$.when(c).done(function(t){t.success?n($opt.dataConvert(t)):$toast.warning(t.msg)}).fail(function(t){$toast.error(t)})},aaSorting:[[0,"desc"]],columns:[{title:"维修单单编号",data:"taskNo",class:"text-center"},{title:"测站名称",data:"stionId",class:"text-center",fnCreatedCell:function(t,e,a,n,i){$dict.get("station").then(function(a){$.each(a,function(a,n){n.stionId===e&&$(t).html(n.stnm)})})}},{title:"业务类型",data:"stionId",class:"text-center",fnCreatedCell:function(t,e,a,n,i){$.when($dict.get("station"),$dict.get("serviceType")).then(function(a){$.each(a,function(a,n){if(n.stionId===e){var i=$dict.getItem("serviceType","trueValue",n.serviceType);$(t).html(i.showValue)}})})}},{title:"维修区域",data:"addvcd",class:"text-center",fnCreatedCell:function(t,e,a,n,i){$dict.get("addvcd").then(function(a){$.each(a,function(a,n){n.addvcd===e&&$(t).html(n.addvnm)})})}},{title:"优先级",data:"priorityStatus",class:"text-center",fnCreatedCell:function(t,e,a,n,i){var r={1:"mt-5 badge bg-dutch",2:"mt-5 badge bg-orange",3:"mt-5 badge bg-red"};$dict.get("priority").then(function(a){$.each(a,function(a,n){n.trueValue===(e||"").toString()&&$(t).html('<div class="'+r[n.trueValue]+'">'+n.showValue+"</div>")})})}},{title:"创建时间",data:"createTime",class:"text-center"},{title:"操作",data:"maintUserId",bSortable:!1,fnCreatedCell:function(t,e,a,n,i){var r=$('<a class="btn btn-info btn-xs ml-5"><i class="fa fa-file-o mr-5"></i>路线查看</a>');r.on("click",function(){l(t,e,a,n,i)}),$(t).html("").append(r)}}]});c.find(".table").dataTable(d)})},l=function(n,i,r,o,c){var d=r.reciveTime,s=r.finishTime,l=i,m=$msg.dialog("mapLocation",function(t,e){},{title:"路线查看 ("+d+" ~ "+s+")",modalClassName:"modal-lg",buttons:{success:{label:"确定",className:"btn-info"}}}),u=$api.get({url:$cfg.baseUrl+"/maintGps/historyRoute/",data:{startTime:d,endTime:s,repairUserId:l}});$.when(m,u).then(function(n,i){if(i.success&&i.data.length>0){var r,o=t.proj.fromLonLat([parseFloat(116.39739),parseFloat(39.40886)]),c=new t.View({center:o,zoom:7,minZoom:5}),d=new t.Map({controls:t.control.defaults({attributionOptions:{collapsible:!1}}),target:"p_map",logo:!1,view:c}),s=new t.layer.Tile({zIndex:1,source:$opt.getBmapOptions()});d&&d.addLayer(s);var l=[],m=$.map(i.data,function(e,a){return l.push(t.proj.fromLonLat([e.longitude,e.latitude])),{type:"Feature",geometry:{type:"Point",coordinates:t.proj.fromLonLat([e.longitude,e.latitude])},properties:$.extend({},e,{pointType:"Point",isStart:0===a,isEnd:a===i.data.length-1})}}),u=$.map(i.data,function(e,a){if(0===a)return null;var n=i.data[a-1];return{type:"Feature",geometry:{type:"LineString",coordinates:[t.proj.fromLonLat([n.longitude,n.latitude]),t.proj.fromLonLat([e.longitude,e.latitude])]},properties:$.extend({},e,{pointType:"LineString"})}}),f={type:"FeatureCollection",crs:{type:"name",properties:{name:"EPSG:3857"}},features:m.concat(u).concat([{type:"Feature",geometry:{type:"Polygon",coordinates:[l]},properties:{pointType:"setView"}}])},p={StartPoint:new t.style.Style({image:new t.style.Icon({anchor:[.5,1],scale:.7,src:"assets/img/map/p_start.png"})}),endPoint:new t.style.Style({image:new t.style.Icon({anchor:[.5,1],scale:.7,src:"assets/img/map/p_end.png"})}),Point:new t.style.Style({image:new t.style.Circle({radius:5,fill:new t.style.Fill({color:"rgba(255,0,0,0.3)"}),stroke:new t.style.Stroke({color:"red",width:1})})}),LineString:new t.style.Style({stroke:new t.style.Stroke({color:"blue",lineDash:[10,10],width:2})})},g=function(t){var e=t.getGeometry().getType();if("Point"===e){var a=t.getProperties();if(a.isStart)return p.StartPoint;if(a.isEnd)return p.endPoint}return p[e]},v=new t.source.Vector({features:(new t.format.GeoJSON).readFeatures(f)}),y=new t.layer.Vector({zIndex:2,source:v,style:g});d&&d.addLayer(y);var h=function(){var t=v.getFeatures();$.map(t,function(t){"setView"===t.get("pointType")&&c.fit(t.getGeometry(),{padding:[50,50,50,50],constrainResolution:!1})})};h(),d.on("pointermove",function(n){var i=d.forEachFeatureAtPixel(n.pixel,function(t,e){return t});if(i){var o=i.getProperties();if("Point"===o.pointType){var c=n.coordinate;r&&(r.remove(),r=void 0);var s={};s=$.extend(s,o),r=$(e.compile(a)(s));var l=new t.Overlay({element:r.get(0),autoPan:!0,autoPanAnimation:{duration:250}});l.setPosition(c),d.addOverlay(l)}else r&&(r.remove(),r=void 0)}else r&&(r.remove(),r=void 0)}),d.on("click",function(t){d.forEachFeatureAtPixel(t.pixel,function(t,e){return t})&&h()})}else i.success?($msg.info("该任务单处理时间段没有位置记录"),n.modal("hide")):($toast.warning(i.msg),n.modal("hide"))})};return{data:{model:[{icon:"fa fa-pencil-square-o",title:"工作考核"},{icon:"",title:"运维人员工作考核"}]},init:function(t){console.log(t+":init"),o(),c()},dispose:function(t){console.log(t+":dispose")}}});