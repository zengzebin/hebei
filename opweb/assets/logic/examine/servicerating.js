define(["handlebars","highcharts","datatables"],function(t){var e,n=function(){$dict.init({name:"priority",url:$cfg.baseUrl+"/OptionSelect/com-ssxt-op-priority/"}),$dict.init({name:"serviceType",url:$cfg.baseUrl+"/OptionSelect/com-ssxt-op-serviceType/"}),$dict.init({name:"addvcd",url:$cfg.baseUrl+"/addvcd/loadAll/"}),$dict.init({name:"device",url:$cfg.baseUrl+"/device/loadAll/"}),$dict.init({name:"station",url:$cfg.baseUrl+"/stinfo/loadAll/"}),$dict.init({name:"stcdType",url:$cfg.baseUrl+"/OptionSelect/com-ssxt-op-stcdType/"}),$dict.init({name:"maintainer",url:$cfg.baseUrl+"/users/loadAll/?isOperation=1"}),$dict.init({name:"statusCode",url:$cfg.baseUrl+"/OptionSelect/statusCode"})},a=function(t){if(!this.attach){var e=t.find(".chart-condition");e.html('<option value="0">近六个月</option>\n<option value="1">近一年</option>\n<option value="2">今年</option>\n<option value="3">汛期</option>').select2().next(".select2").css("position","absolute").css("zIndex","1");var n=this;e.on("change",function(){n.initFunc.apply(n,[t])}),this.attach=!0}var a=t.find(".chart-condition").val(),i=[{startTime:moment().add(-5,"M").startOf("M").format("YYYY-MM-DD"),endTime:moment().endOf("M").format("YYYY-MM-DD")},{startTime:moment().add(-11,"M").startOf("M").format("YYYY-MM-DD"),endTime:moment().endOf("M").format("YYYY-MM-DD")},{startTime:moment().set("M",0).startOf("M").format("YYYY-MM-DD"),endTime:moment().set("M",11).endOf("M").format("YYYY-MM-DD")},{startTime:moment().set("M",3).startOf("M").format("YYYY-MM-DD"),endTime:moment().set("M",8).endOf("M").format("YYYY-MM-DD")}],o=$api.get({loading:!1,url:$cfg.baseUrl+"/statistics/provinceFault",data:i[a]});$.when(o).done(function(e){if(t.trigger("loading.hide"),e.success){var n=$.map(e.data,function(t){return t.date}),a=$.map(e.data,function(t){return t.num});t.find(".chart").highcharts({chart:{type:"line",marginTop:45,height:250},title:{text:""},xAxis:{categories:n},yAxis:{title:""},legend:{enabled:!1},plotOptions:{line:{dataLabels:{enabled:!0},enableMouseTracking:!1}},series:[{name:"series",data:a}]})}else $toast.warning(e.msg)}).fail(function(e){t.trigger("loading.hide"),$toast.error(e)})},i=function(t){if(!this.attach){var e=t.find(".chart-condition");e.html('<option value="0">昨日</option>\n<option value="1">近一周</option>\n<option value="2">近一个月</option>\n<option value="3">汛期</option>').select2().next(".select2").css("position","absolute").css("zIndex","1");var n=this;e.on("change",function(){n.initFunc.apply(n,[t])}),this.attach=!0}var a=t.find(".chart-condition").val(),i=[{startTime:moment().add(-1,"d").format("YYYY-MM-DD"),endTime:moment().add(-1,"d").format("YYYY-MM-DD")},{startTime:moment().add(-1,"d").add(1,"d").add(-7,"d").format("YYYY-MM-DD"),endTime:moment().add(-1,"d").format("YYYY-MM-DD")},{startTime:moment().add(-1,"d").add(1,"d").add(-1,"M").format("YYYY-MM-DD"),endTime:moment().add(-1,"d").format("YYYY-MM-DD")},{startTime:moment().set("M",3).startOf("M").format("YYYY-MM-DD"),endTime:moment().set("M",8).endOf("M").format("YYYY-MM-DD")}],o=$api.get({loading:!1,url:$cfg.baseUrl+"/statistics/unobstructed",data:i[a]});return $.when(o).done(function(e){if(t.trigger("loading.hide"),e.success){var n=e.data,a=$.map(n,function(t){return t.addvnm}),i=$.map(n,function(t){return t.normal}),o=$.map(n,function(t){return t.bad});t.find(".chart").highcharts({colors:["#df2d05","#00ae34"],chart:{type:"column",height:250},title:{text:""},xAxis:{categories:a},yAxis:{min:0,title:{text:""},stackLabels:{formatter:function(){var t=n[this.x].unobstructed;return(100*(null===t?1:t)).toFixed(0)+"%"},enabled:!0,style:{fontWeight:"bold",color:"#124c98"}}},legend:{align:"right",x:0,y:0,verticalAlign:"top",floating:!1,backgroundColor:"white",borderColor:"#CCC",borderWidth:1,shadow:!1},tooltip:{headerFormat:"<b>{point.x}</b><br/>",pointFormat:"{series.name}: {point.y}<br/>Total: {point.stackTotal}"},plotOptions:{column:{stacking:"normal",dataLabels:{formatter:function(){return 0===this.y?"":this.y},enabled:!0,color:"#fff"}}},series:[{maxPointWidth:30,name:"未上报",data:o},{maxPointWidth:30,name:"正常",data:i}]}),t.trigger("loading.hide")}else $toast.warning(e.msg)}).fail(function(e){t.trigger("loading.hide"),$toast.error(e)}),o},o=function(t){e&&e.fnDestroy();var n=$.extend({},$plugin.datatable_server,{fnServerData:function(e,n,a){var i=$api.get({loading:!1,url:$cfg.baseUrl+"/statistics/efficiency"});$.when(i).done(function(e){t.trigger("loading.hide"),e.success?a($opt.dataConvert(e)):$toast.warning(e.msg)}).fail(function(e){t.trigger("loading.hide"),$toast.error(e)})},bPaginate:!1,ordering:!1,autoWidth:!1,info:"",columns:[{title:"所属市",data:"addvnm",class:"text-center"},{title:"平均维修时间",data:"addvnm",class:"text-center",render:function(t,e,n){return n.dealNum&&n.dealTime?parseInt(n.dealTime/n.dealNum)+"h":"0h"}},{title:"平均响应时间",data:"addvnm",class:"text-center",render:function(t,e,n){return n.responseTime&&n.responseNum?parseInt(n.responseTime/n.responseNum)+"h":"0h"}},{title:"修复保证率",data:"addvnm",class:"text-center",render:function(t,e,n){return parseFloat(n.cityDealNum/n.cityNum).toFixed(2)+"%"}}]});e=t.find(".table").dataTable(n)},r=function(){var e=[{elem:$("#p_panel_1").get(0),target:$(".panel-content .panel-left").get(0),data:{title:"全省故障站统计趋势分析"},initFunc:a},{elem:$("#p_panel_1").get(0),target:$(".panel-content .panel-right").get(0),data:{title:"各市畅通率统计"},initFunc:i},{elem:$("#p_panel_2").get(0),target:$(".panel-content .panel-left").get(0),data:{title:"运维效率评估"},initFunc:o}],n=$(".panel-content");$.map(e,function(e){e.target&&(n=$(e.target));var a=e.html||e.elem.innerHTML.replace(/\[\[/g,"{{").replace(/]]/g,"}}"),i=t.compile(a)(e.data||{}),o=$(i),r=o.hasClass("panel")?o:o.find(".panel");o.on("refresh",function(){$.isFunction(e.initFunc)&&(r.trigger("loading.show"),e.initFunc.apply(e,[r]))}),n.append(o),$.isFunction(e.initFunc)&&(e.attach=!1,e.initFunc.apply(e,[r]))})};return{data:{model:[{icon:"fa fa-pencil-square-o",title:"工作考核"},{icon:"",title:"管理业务工作考核"}]},init:function(t){console.log(t+":init"),n(),r()},dispose:function(t){console.log(t+":dispose")}}});