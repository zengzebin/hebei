define(["handlebars","datatables","highcharts"],function(t){var e,a,n=function(){$dict.init({name:"stcdType",url:$cfg.baseUrl+"/OptionSelect/com-ssxt-op-stcdType/"}),$dict.init({name:"addvcd",url:$cfg.baseUrl+"/addvcd/loadAll/"}),$dict.init({name:"maintainer",url:$cfg.baseUrl+"/users/loadAll/?isOperation=1"}),$dict.init({name:"user",url:$cfg.baseUrl+"/users/loadAll/"}),$dict.init({name:"serviceType",url:$cfg.baseUrl+"/OptionSelect/com-ssxt-op-serviceType/"}),$dict.init({name:"deviceType",url:$cfg.baseUrl+"/OptionSelect/deviceType/"}),$dict.init({name:"store",url:$cfg.baseUrl+"/WareHouse/loadAll/"})},i=function(){var t=[];r(),$.when.apply($,t).done(function(){c()}),$("#b_refresh,#b_search").on("click",function(){c()})},r=function(){var e=[{elem:$("#p_panel_1").get(0),data:{title:"库存量统计"},initFunc:l}],a=$(".panel-list");a.html(""),$.map(e,function(e){var n=e.html||e.elem.innerHTML.replace(/\[\[/g,"{{").replace(/]]/g,"}}"),i=t.compile(n)(e.data||{}),r=$(i);r.on("refresh",function(){$.isFunction(e.initFunc)&&(r.trigger("loading.show"),e.initFunc.apply(e,[r]))}),a.append(r),$.isFunction(e.initFunc)&&(e.attach=!1,e.initFunc.apply(e,[r]))})},c=function(){e&&e.fnDestroy();var t=$.extend({},$plugin.datatable_server,{fnServerData:function(t,e,a){var n=$.extend({},$opt.paramConvert(e),$opt.paramFilter({})),i=$api.get({url:$cfg.baseUrl+"/WareHouse/select",data:n});$.when(i).done(function(t){t.success?a($opt.dataConvert(t)):$toast.warning(t.msg)}).fail(function(t){$toast.error(t)})},aaSorting:[[0,"desc"]],columns:[{title:"仓库名称",data:"name",class:"text-center"},{title:"所属政区",data:"addvcd",class:"text-center",fnCreatedCell:function(t,e,a,n,i){$dict.get("addvcd").then(function(a){$.each(a,function(a,n){n.addvcd===e&&$(t).html(n.addvnm)})})}},{title:"所在地址",data:"address",class:"text-center"},{title:"负责人",data:"responsibilityId",class:"text-center",fnCreatedCell:function(t,e,a,n,i){$dict.get("user").then(function(a){$.each(a,function(a,n){n.id===e&&$(t).html(n.name)})})}},{title:"联系电话",data:"responsibilityId",class:"text-center",fnCreatedCell:function(t,e,a,n,i){$dict.get("user").then(function(a){var n="";$.each(a,function(t,a){a.id===e&&a.phone&&(n='<a><i class="fa fa-phone-square text-success ml-5"></i> '+a.phone+"</a>")}),$(t).html(n)})}},{title:"操作",data:"id",bSortable:!1,fnCreatedCell:function(t,e,a,n,i){var r=$('<a class="btn btn-warning btn-xs ml-5"><i class="fa fa-gavel"></i>物品质量评估</a>'),c=$('<a class="btn btn-info btn-xs ml-5"><i class="fa fa-bar-chart"></i>采购分析</a>');r.on("click",function(){o(t,e,a,n,i)}),c.on("click",function(){s(t,e,a,n,i)}),$(t).html("").append(r).append(c)}}]});e=$("#t_store").dataTable(t)},o=function(t,e,a,n,i){var r=$msg.dialog("storeChartAdd",function(t,e){return!1},{title:"物品质量评估",modalClassName:"modal-lg",buttons:{success:{label:"确定",className:"btn-info"}}}),c=$api.get({url:$cfg.baseUrl+"/WareHouse/assessment",data:{wareHouseId:e}});$.when(r,c).then(function(t,e){if(e.success){var n=$.map(e.data,function(t){return t.name}),i={scrap:$.map(e.data,function(t){return t.scrap||0}),good:$.map(e.data,function(t){return t.good||0}),new:$.map(e.data,function(t){return t.new||0}),bad:$.map(e.data,function(t){return t.bad||0})};t.find(".chart").highcharts({colors:["#bfbfbf","#ff5a20","#1cae5f","#dfaf08"],chart:{type:"column",height:500},title:{text:a.name+"物品质量评估"},xAxis:{categories:n},yAxis:{min:0,title:{text:""}},legend:{align:"right",x:0,y:0,verticalAlign:"top",floating:!1,backgroundColor:"white",borderColor:"#CCC",borderWidth:1,shadow:!1},plotOptions:{column:{stacking:"normal",dataLabels:{enabled:!0,color:"#fff"}}},series:[{maxPointWidth:40,name:"报废",data:i.scrap},{maxPointWidth:40,name:"损坏",data:i.bad},{maxPointWidth:40,name:"良好",data:i.good},{maxPointWidth:40,name:"全新",data:i.new}]})}else $toast.warning(e.msg)})},s=function(t,e,a,n,i){var r=$msg.dialog("storeChartAdd",function(t,e){return!1},{title:"采购分析",modalClassName:"modal-lg",buttons:{success:{label:"确定",className:"btn-info"}}}),c=$api.get({url:$cfg.baseUrl+"/WareHouse/analysis",data:{wareHouseId:e}});$.when(r,c).then(function(t,e){if(e.success){var n=$.map(e.data,function(t){return t.name}),i={demandNum:$.map(e.data,function(t){return t.demandNum||0}),surplusNum:$.map(e.data,function(t){return t.surplusNum||0})};t.find(".chart").highcharts({colors:["#1cae5f","#ff5a20"],chart:{type:"column",height:500},title:{text:a.name+"采购分析"},xAxis:{categories:n},yAxis:{min:0,title:{text:""}},legend:{align:"right",x:0,y:0,verticalAlign:"top",floating:!1,backgroundColor:"white",borderColor:"#CCC",borderWidth:1,shadow:!1},plotOptions:{column:{dataLabels:{enabled:!0,color:"#1d1d1d"}}},series:[{maxPointWidth:40,name:"剩余良品",data:i.surplusNum},{maxPointWidth:40,name:"更换需求",data:i.demandNum}]})}else $toast.warning(e.msg)})},l=function(t){if(this.attach){a&&a.fnDestroy();var e=$.extend({},$plugin.datatable_server,{iDisplayLength:5,fnServerData:function(e,a,n){var i=$.extend({},$opt.paramConvert(a),$opt.paramFilter({wareHouseId:t.find("#c_store").val(),deviceTypeId:t.find("#c_deviceTypeId").val()})),r=$api.get({loading:!1,url:$cfg.baseUrl+"/WareHouse/surplus",data:i});$.when(r).done(function(e){t.trigger("loading.hide"),e.success?n($opt.dataConvert(e)):$toast.warning(e.msg)}).fail(function(e){t.trigger("loading.hide"),$toast.error(e)})},aaSorting:[[0,"desc"]],bPaginate:!1,ordering:!1,autoWidth:!1,info:"",columns:[{title:"设备类型",data:"deviceTypeId",class:"text-center",fnCreatedCell:function(t,e,a,n,i){$dict.get("deviceType").then(function(a){$.each(a,function(a,n){n.id===e&&$(t).html(n.name)})})}},{title:"型号",data:"model",class:"text-center"},{title:"状态",data:"state",class:"text-center",render:function(t,e,a){return{10:"全新",20:"良好",30:"损坏",40:"报废"}[t]}},{title:"数量",data:"num",class:"text-center"}]});a=t.find(".table").dataTable(e)}else{var n=[],i=$dict.initOptions({elem:"#c_store",dict:"store",propText:"name",propId:"id"});n.push(i),i=$dict.initOptions({elem:"#c_deviceTypeId",dict:"deviceType",propText:"name",propId:"id",append:[{id:"-1",text:"全部"}]}),n.push(i);var r=this;$.when.apply($,n).done(function(){r.attach=!0,r.initFunc.apply(r,[t])}),t.on("click","#btn_refresh",function(){r.initFunc.apply(r,[t])})}};return{data:{model:[{icon:"fa fa-cube",title:"备件管理"},{icon:"",title:"物品管理"}]},init:function(t){console.log(t+":init"),n(),i()},dispose:function(t){console.log(t+":dispose")}}});