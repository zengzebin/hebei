define(["ol","handlebars","lightbox2","html!!mapPopup","html!!mapPopup2","html!!taskLine","highcharts","datatables","imagesloaded"],function(e,t,a,n,i,r){var o,s,d,l,c,p,u,m,f=[],g=[],v={site:"1",siteName:"地下水站点",people:!0},h=function(){$("#map").height($(window).height()-132-40)},y=function(){var e=$("#c_addvcd").find("option:selected").text()||"",t=v.siteName+"";$(".ol-maptitle .title").html(moment().format("YYYY-MM-DD")+" "+e+t+"运维监控")},b=function(){if(!e)return void $toast.error("当前浏览器版本不支持地图显示!<br/>请使用chrome或ie8以上版本浏览器");h(),$(window).on("resize",h),$(window).on("slidebar",function(){o&&o.updateSize()});var a=e.proj.fromLonLat([parseFloat(116.39739),parseFloat(39.40886)]),n=e.control.defaults({attributionOptions:{collapsible:!1}}).extend([new e.control.MapOptPanel({elem:$("#tpl_mapBtnBack").get(0),className:"ol-mapBtnBack",data:{}}),new e.control.MapOptPanel({elem:$("#tpl_mapOptPanel").get(0),className:"ol-mapOptPanel",data:{site:[{name:"全部\n站点",value:-1,class:""},{name:"中小\n河流",value:3,class:"active-blue"},{name:"山洪\n站点",value:2,class:"active-red"},{name:"山洪\n故障县",value:"02",class:"active-red"},{name:"地下水\n站点",value:1,class:"active-purple"},{name:"基本\n站点",value:4,class:"active-green"}],people:[{name:"运维\n人员",class:"active-orange"}]}}),new e.control.MapOptPanel({elem:$("#tpl_mapLegend").get(0),className:"ol-mapLegend",data:{legend:[{url:"assets/img/map/new/ZQ_3.png",title:"中小河流水文站"},{url:"assets/img/map/new/ZQ_2.png",title:"山洪水文站"},{url:"assets/img/map/new/PP_4.png",title:"雨量基本站"},{url:"assets/img/map/new/PP_2.png",title:"山洪雨量站"},{url:"assets/img/map/new/ZG_1.png",title:"地下水站"},{url:"assets/img/map/new/ZZ_2.png",title:"山洪水位站"}]}}),new e.control.MapTitle({title:"站点运行监视",subtitle:"统计视图"}),new e.control.LayerCheckbox({name:"ol-cb-gis",value:!0,title:"显示GIS图层",handle:function(e,t,a){T()}}),new e.control.LayerCheckbox({name:"ol-cb-bmap",value:!0,title:"显示百度底图",handle:function(e,t,a){T()}}),new e.control.LayerCheckbox({name:"ol-cb-sitename",value:!1,title:"显示站点名称",handle:function(e,t,a){k()}}),new e.control.LayerCheckbox({name:"ol-cb-view",value:!0,title:"切换统计视图",handle:function(e,t,a){a.find("input").prop("checked")?$(".ol-maptitle .subtitle").html("统计视图"):$(".ol-maptitle .subtitle").html("站点视图"),y(),T(),k()}})]);o=new e.Map({controls:n,target:"map",logo:!1,view:new e.View({center:a,zoom:7,minZoom:5})}),o.on("click",function(e){var t=o.forEachFeatureAtPixel(e.pixel,function(e,t){return e}),a=e.coordinate;t&&w(t,a)}),o.on("pointermove",function(a){var n=o.forEachFeatureAtPixel(a.pixel,function(e,t){return e});if(n){var r=n.get("data");if("warning"===r.pointType){var s=a.coordinate;l&&(l.remove(),l=void 0);var c={};if(!d){c=$.extend(c,r,{addvnm:($dict.getItem("addvcd","addvcd",r.addvcd)||{}).addvnm,serviceTypeName:($dict.getItem("serviceType","trueValue",r.serviceType)||{}).showValue,sttpName:($dict.getItem("stcdType","trueValue",r.sttp)||{}).showValue,repairName:($dict.getItem("maintainer","id",r.repairId)||{}).name,sendTime:r.sendTime?r.sendTime:"暂无数据",insertTime:r.insertTime?r.insertTime:"暂无数据",observationTime:r.observationTime?r.observationTime:"暂无数据",difference:r.difference||0===r.difference?r.difference+"小时":"从未上报",repairTime:moment(r.nowTime).diff(moment(r.dealTime),"hours")+"小时"}),l=$(t.compile(i)(c));var p=new e.Overlay({element:l.get(0),autoPan:!0,autoPanAnimation:{duration:250}});p.setPosition(s),o.addOverlay(p)}}else l&&(l.remove(),l=void 0)}else l&&(l.remove(),l=void 0)});var r;o.getView().on("change:resolution",function(e){r&&clearTimeout(r),r=setTimeout(function(){var e=$(".ol-cb-sitename").find("input");o.getView().getZoom()>9?e.iCheck("check"):e.iCheck("uncheck")},500)})},w=function(i,r){var s=i.get("data"),c=[];if("station"===s.pointType||"warning"===s.pointType){var p=s.stcd,u=s.serviceType,m=$api.get({loading:!1,url:$cfg.baseUrl+"/stinfo/stcdImage/"+p});c.push(m),m=$api.get({loading:!1,url:$cfg.baseUrl+"/map/stationState",data:{serviceType:u,stcd:p}}),c.push(m)}$.when.apply($,c).done(function(i,c){if("total"===s.pointType){var p=$("#c_addvcd").val()||"";if(!("02"===(v.site||"").toString())||"0000"===p.slice(-4)||"00"!==p.slice(-2)){var u=s.addvcd;$("#c_addvcd").val(u).change()}}else if("station"===s.pointType||"warning"===s.pointType||"people"===s.pointType){var m={};if("station"!==s.pointType&&"warning"!==s.pointType||$cfg.picUrl&&$.each(i.data,function(e,t){t.url=$cfg.picUrl+t.url}),"station"===s.pointType)m=$.extend(m,s,{addvnm:($dict.getItem("addvcd","addvcd",s.addvcd)||{}).addvnm,serviceTypeName:($dict.getItem("serviceType","trueValue",s.serviceType)||{}).showValue,sttpName:($dict.getItem("stcdType","trueValue",s.sttp)||{}).showValue,repairName:($dict.getItem("maintainer","id",s.repairId)||{}).name,images:i.data,datas:c.success?$.map(Object.keys(c.data||[]),function(e){var t=c.data[e];if(t&&0!==t)return{name:e,value:t}}):[]});else if("warning"===s.pointType)m=$.extend(m,s,{addvnm:($dict.getItem("addvcd","addvcd",s.addvcd)||{}).addvnm,serviceTypeName:($dict.getItem("serviceType","trueValue",s.serviceType)||{}).showValue,sttpName:($dict.getItem("stcdType","trueValue",s.sttp)||{}).showValue,repairName:($dict.getItem("maintainer","id",s.repairId)||{}).name,sendTime:s.sendTime?s.sendTime:"暂无数据",insertTime:s.insertTime?s.insertTime:"暂无数据",observationTime:s.observationTime?s.observationTime:"暂无数据",difference:s.difference||0===s.difference?s.difference+"小时":"从未上报",images:i.data,datas:c.success?$.map(Object.keys(c.data||[]),function(e){var t=c.data[e];if(t&&0!==t)return{name:e,value:t}}):[]});else if("people"===s.pointType){var f=$dict.getItems("addvcd","addvcd",s.addvcd.split(",")),g=2;0===s.state&&(g=s.taskNo?1:0);var h=["空闲","任务中","休假"],y=s.imageUrl;y?$cfg.picUrl&&(y=$cfg.picUrl+y):y="assets/img/uikits/photo.png",m=$.extend(m,s,{photo:y,phone:s.phone?s.phone:"无",status:g,statusName:h[g],addvnm:$.map(f,function(e){return e.addvnm})})}l&&(l.remove(),l=void 0),d&&(d.remove(),d=void 0),d=$(t.compile(n)(m)),d.on("click",".ol-popup-closer",function(){d&&(d.remove(),d=void 0)}),d.on("click",".btn-repeat",function(){var e=$.extend({},s);V("","",e,"","")}),d.on("click",".btn-alert",function(){var e=$.extend({},s);B("","",e,"","")}),d.on("click",".btn-history",function(){var e=$.extend({},s);H("","",e,"","")}),d.on("click","a[data-lightbox]",function(){event.preventDefault(),a.option({albumLabel:"第%1张 / 共%2张"}),a.start($(this))});var b=new e.Overlay({element:d.get(0),autoPan:!0,autoPanAnimation:{duration:250}});b.setPosition(r),o.addOverlay(b)}var w=e.proj.fromLonLat([s.longitude,s.latitude]);o.getView().setCenter(w)})},x=function(t,a){var n=[],i=$(".ol-cb-sitename").find("input").prop("checked"),r=t.get("data");if("station"===a){var o=new e.style.Text({offsetY:15,font:"10px 微软雅黑",text:r.stnm,fill:new e.style.Fill({color:"#f00"}),stroke:new e.style.Stroke({color:"#fff",width:3})}),s=new e.style.Icon({anchor:[.5,.5],scale:.7,src:"assets/img/map/new/"+r.sttp+"_"+r.serviceType+".png"});n.push(new e.style.Style({image:s,text:i?o:void 0,zIndex:1}))}else if("total"===a){var d=void 0===r.num?"":r.num,o=[new e.style.Text({offsetY:0,font:"10px 微软雅黑",text:d.toString(),fill:new e.style.Fill({color:"#fff"})}),new e.style.Text({offsetY:25,font:"10px 微软雅黑",text:r.addvnm,fill:new e.style.Fill({color:"#f00"}),stroke:new e.style.Stroke({color:"#fff",width:3})})],s=[];s[0]=r.isCountTotal?new e.style.Circle({radius:18,fill:new e.style.Fill({color:"#f4a52d"}),stroke:new e.style.Stroke({color:"#f4a52d",width:1})}):new e.style.Icon({anchor:[.5,.5],scale:.9,src:"assets/img/map/total-1.png"}),s[1]=r.isCountTotal?new e.style.Circle({radius:18,fill:new e.style.Fill({color:"#ff2000"}),stroke:new e.style.Stroke({color:"#ff2000",width:1})}):new e.style.Icon({anchor:[.5,.5],scale:.9,src:"assets/img/map/total-2.png"}),n.push(new e.style.Style({image:d>20?s[1]:s[0],text:o[0],zIndex:2})),n.push(new e.style.Style({text:o[1],zIndex:3}))}else if("warning"===a){var o=new e.style.Text({offsetY:15,font:"10px 微软雅黑",text:r.stnm,fill:new e.style.Fill({color:"#f00"}),stroke:new e.style.Stroke({color:"#fff",width:3})}),s=new e.style.Icon({anchor:[.5,.5],scale:.7,src:"assets/img/map/new/"+r.sttp+"_"+r.serviceType+".png"});n.push(new e.style.Style({image:s,text:i?o:void 0,zIndex:1}))}else if("people"===a){var s=[];s[0]=new e.style.Icon({anchor:[.5,1],scale:.8,src:"assets/img/map/p1.png"}),s[1]=new e.style.Icon({anchor:[.5,1],scale:.8,src:"assets/img/map/p2.png"}),s[2]=new e.style.Icon({anchor:[.5,1],scale:.8,src:"assets/img/map/p3.png"});var l=2;0===r.state&&(l=r.taskNo?1:0),n.push(new e.style.Style({image:s[l],zIndex:1}))}return n},T=function(){var t=!$(".ol-cb-gis").find("input").prop("checked"),a=!$(".ol-cb-bmap").find("input").prop("checked"),n=$(".ol-cb-view").find("input").prop("checked");o&&f&&f.length>0&&($.map(f,function(e){o.removeLayer(e)}),f=[]);var i=$("#c_addvcd").val()||"";if(n&&"0000"===i.slice(-4)&&(a=!0,setTimeout(function(){$(".ol-cb-bmap").find("input").iCheck("uncheck")},100)),!a){var r=new e.layer.Tile({source:$opt.getBmapOptions()});f.push(r),o&&o.addLayer(r)}if(!t){var s=$cfg.mapUrl,i=$("#c_addvcd").val()||"",d="",l="show:0,1,2,3,4,5,6,7,8,9,10,11";"0000"===i.slice(-4)?(d="",l=n||!a?"show:0,1,2,3,4,7,8,9,10,11":"show:0,1,2,3,4,5,7,8,9,10,11"):"00"===i.slice(-2)?(d="10:CITY_CD='"+i+"'",l=n||!a?"show:0,1,2,3,4,7,8,9,10,11":"show:0,1,2,3,4,5,7,8,9,10,11"):(d="10:CITY_CD='"+i.slice(0,-2)+"00';6:COUN_CD='"+i+"'",l="show:0,1,2,3,4,5,6,7,8,9,10,11");var c=new e.source.TileArcGISRest({crossOrigin:!0,url:s,params:{LAYERS:l,VERSION:"1.1.1",layerDefs:d}}),p=new e.layer.Tile({zIndex:1,source:c});f.push(p),o&&o.addLayer(p)}},k=function(t){if(d&&(d.remove(),d=void 0),l&&(l.remove(),l=void 0),$(".ol-cb-view").find("input").prop("checked")){var a=$("#c_addvcd").val()||"",n=v.site||"",i="02"===n.toString();if("0000"===a.slice(-4)||i){var r,c={serviceType:n},p=!0;i&&"0000"===a.slice(-4)?(c.type="city",r=$api.get({loading:!1,url:$cfg.baseUrl+"/map/24ReportCounty",data:c}),p=!1):i&&"00"===a.slice(-2)?(c.type="countyfault",c.addvcd=a,r=$api.get({loading:!1,url:$cfg.baseUrl+"/map/24ReportCounty",data:c}),p=!1):i?(c.type="countyfault",c.addvcd=a+"0",r=$api.get({loading:!1,url:$cfg.baseUrl+"/map/24ReportCounty",data:c}),p=!1):(c.type="cityInfo",r=$api.get({loading:!1,url:$cfg.baseUrl+"/map/faultSite24",data:c})),r&&$.when(r).done(function(a){if(a.success){var n=a.data;o&&(s&&o.removeLayer(s),$.each(g,function(e,t){o.removeOverlay(t)}),g=[]);var i=new e.source.Vector({});s=new e.layer.Vector({zIndex:2,visible:!0,source:i}),$.each(n,function(t,a){var n=a;n.pointType="total",n.isCountTotal=p;var r=new e.geom.Point(e.proj.fromLonLat([n.longitude,n.latitude])),o=new e.Feature({data:n,geometry:r});i.addFeature(o),o.setId(n.addvcd),o.setStyle(x(o,"total"))}),o&&o.addLayer(s),t&&t()}else $toast.warning(a.msg)}).fail(function(e){$toast.error(e)})}else{var c={serviceType:n,addvcd:a,type:"stinfo"},r=$api.get({loading:!1,url:$cfg.baseUrl+"/map/faultSite24",data:$opt.paramFilter(c)});$.when(r).done(function(a){if(a.success){var n=a.data;o&&(s&&o.removeLayer(s),$.each(g,function(e,t){o.removeOverlay(t)}),g=[]);var i=new e.source.Vector({});s=new e.layer.Vector({zIndex:2,visible:!0,source:i}),$.each(n,function(t,a){var n=a;n.pointType="warning",n.warning=!0;var r=new e.geom.Point(e.proj.fromLonLat([n.longitude,n.latitude])),s=new e.Feature({data:n,geometry:r});i.addFeature(s),s.setId(n.stionId),s.setStyle(x(s,"warning"));var d=new e.Overlay({element:$('<div class="ol-warning"></div>').get(0),positioning:"center-center",zIndex:3});o.addOverlay(d),$(".ol-warning").parents(".ol-overlay-container").css("pointer-events","none"),d.setPosition(e.proj.transform([n.longitude,n.latitude],"EPSG:4326","EPSG:3857")),g.push(d)}),o&&o.addLayer(s),t&&t()}else $toast.warning(a.msg)}).fail(function(e){$toast.error(e)})}}else{var a=$("#c_addvcd").val()||"",n=v.site||"",c={serviceType:n,addvcd:a,type:"stinfo"},r=$api.get({loading:!1,url:$cfg.baseUrl+"/map/faultSite24",data:$opt.paramFilter(c)});$.when(r,$dict.get("station")).done(function(i,r){if(i.success){var d={};$.each(i.data,function(e,t){d[t.stionId]=t}),o&&(s&&o.removeLayer(s),$.each(g,function(e,t){o.removeOverlay(t)}),g=[]);var l=new e.source.Vector({});s=new e.layer.Vector({zIndex:2,visible:!0,source:l});var c=[];c="0000"===a.slice(-4)?$.map(r,function(e){if(e.addvcd&&e.addvcd.slice(0,2)===a.slice(0,2))return e}):"00"===a.slice(-2)?$.map(r,function(e){if(e.addvcd&&e.addvcd.slice(0,4)===a.slice(0,4))return e}):$.map(r,function(e){if(e.addvcd&&e.addvcd===a)return e}),c=$.map(c,function(e){if(e.serviceType===n||"-1"===n.toString())return e}),$.each(c,function(t,a){if(1===a.valid){var n,i=d[a.stionId];i?(n=i,n.pointType="station",n.warning=!0):(n=a,n.pointType="station");var r=new e.geom.Point(e.proj.fromLonLat([n.longitude,n.latitude])),o=new e.Feature({data:n,geometry:r});l.addFeature(o),o.setId(n.stionId),o.setStyle(x(o,"station"))}}),o&&o.addLayer(s),t&&t()}else $toast.warning(i.msg)})}},I=function(){d&&(d.remove(),d=void 0),l&&(l.remove(),l=void 0);var t=$api.get({loading:!1,url:$cfg.baseUrl+"/map/maintLastPosition",data:{addvcd:$("#c_addvcd").val()}});$.when(t).done(function(t){if(t.success){var a=t.data;o&&c&&o.removeLayer(c);var n=new e.source.Vector({});c=new e.layer.Vector({zIndex:4,visible:!0,source:n}),$.each(a,function(t,a){var i=a;i.pointType="people";var r=new e.geom.Point(e.proj.fromLonLat([i.longitude,i.latitude])),o=new e.Feature({data:i,geometry:r});o.setId(i.id),o.setStyle(x(o,"people")),n.addFeature(o)}),o&&o.addLayer(c)}else $toast.warning(t.msg)}).fail(function(e){$toast.error(e)})},C=function(){v.people?(p=setInterval(I,3e5),I()):(clearInterval(p),d&&(d.remove(),d=void 0),l&&(l.remove(),l=void 0),o&&c&&o.removeLayer(c))},_=function(){$dict.init({name:"priority",url:$cfg.baseUrl+"/OptionSelect/com-ssxt-op-priority/"}),$dict.init({name:"serviceType",url:$cfg.baseUrl+"/OptionSelect/com-ssxt-op-serviceType/"}),$dict.init({name:"addvcd",url:$cfg.baseUrl+"/addvcd/loadAll/"}),$dict.init({name:"device",url:$cfg.baseUrl+"/device/loadAll/"}),$dict.init({name:"station",url:$cfg.baseUrl+"/stinfo/loadAll/"}),$dict.init({name:"stcdType",url:$cfg.baseUrl+"/OptionSelect/com-ssxt-op-stcdType/"}),$dict.init({name:"maintainer",url:$cfg.baseUrl+"/users/loadAll/?isOperation=1"}),$dict.init({name:"statusCode",url:$cfg.baseUrl+"/OptionSelect/statusCode"})},S=function(){var t,a=[];t=$dict.initOptions({s2s:!0,elem:"#c_addvcd",dict:"addvcd",propText:"addvnm",propId:"addvcd",filter:function(e,t){var a=$.userData.addvcd;return"0000"===a.slice(-4)||"00"===a.slice(-2)&&e.addvcd.slice(0,-2)===a.slice(0,-2)||a===e.addvcd}}),a.push(t),a.push($dict.get("serviceType")),a.push($dict.get("stcdType")),a.push($dict.get("maintainer")),$.when.apply($,a).done(function(){var t=$.userData;t.role;b(),$('a[prop-key="site"][prop-value="'+v.site+'"]').parents("li").addClass("active"),v.people&&($('a[prop-key="people"]').parents("li").addClass("active"),C()),$(".ol-mapBtnBack").addClass("hide"),T(),y(),k(function(){$("#c_addvcd").on("change",function(){T(),y(),k(),C(),W();var t=$dict.getItem("addvcd","addvcd",$(this).val());if(t.longitude&&t.latitude){var a=e.proj.fromLonLat([t.longitude,t.latitude]);o.getView().setCenter(a)}t.zoom&&o.getView().setZoom(t.zoom),"0000"===$(this).val().slice(-4)?$(".ol-mapBtnBack").addClass("hide"):$(".ol-mapBtnBack").removeClass("hide")}),$(".ol-mapOptPanel").on("click","li>a",function(){var e=$(this),t=e.parents("ul"),a=e.parents("li"),n=e.attr("prop-key");"site"===n?(t.find("li").removeClass("active"),a.addClass("active"),v[n]=e.attr("prop-value"),v.siteName=e.text().replace("\n",""),y(),k(),W()):"people"===n&&(a.toggleClass("active"),v[n]=a.hasClass("active"),C())}),$(".ol-mapBtnBack").on("click",".btn",function(){var e=$("#c_addvcd").find("option").eq(0).attr("value");$("#c_addvcd").val(e).change()}),$("#c_addvcd").val(t.addvcd).change(),"0000"!==t.addvcd.slice(-4)&&$(".ol-mapBtnBack").remove()}),W(),$("#b_refresh").on("click",function(){T(),y(),k(),W(),C()})})},L=function(e){var t=($("#c_addvcd").find("option:selected").text(),{addvcd:$("#c_addvcd").val()}),a=$api.get({loading:!1,url:$cfg.baseUrl+"/statistics/faultSite",data:t}),n=$api.get({loading:!1,url:$cfg.baseUrl+"/statistics/provinceSituation",data:$opt.paramFilter({startTime:moment().add(-1,"d").format("YYYY-MM-DD"),endTime:moment().add(-1,"d").format("YYYY-MM-DD"),serviceType:v.site||"-1"})});$.when(a,n).done(function(t,a){if(e.trigger("loading.hide"),t.success&&a.success){var n=a.data,i='<div class="sum-text faultsite-text"><label class="text-right w-80">全省站点总数:</label><span class="text-gray"> '+((n.normal||0)+(n.error||0))+'</span></div><div class="sum-text faultsite-text"><label class="text-right w-80">今日正常上报:</label><span class="text-green"> '+(n.normal||0)+'</span></div><div class="sum-text faultsite-text"><label class="text-right w-80">今日未上报:</label><span class="text-red"> '+(n.error||0)+'</span></div><div class="sum-text faultsite-text"><label class="text-right w-80">昨日畅通率:</label><span class="text-orange"> '+(100*(null===n.unobstructed?1:n.unobstructed)).toFixed(0)+"%</span></div>";e.find(".station-total").html(i);var r=0,o=$.map(t.data.info,function(e){var t={};return t.name=e.name,t.y=e.num,r+=parseInt(e.num),t});e.find(".chart").highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1,height:120,type:"pie"},title:{floating:!0,text:"圆心显示的标题",style:{fontSize:12,lineHeight:12}},tooltip:{pointFormat:"<b>{point.y}</b><br>( {point.percentage:.1f}% )"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",verticalAlign:"middle",overflow:!0,crop:!1,dataLabels:{enabled:!0,distance:18,format:"{point.name}: {point.y}",style:{color:"black",fontSize:12}}}},series:[{type:"pie",name:"series",colorByPoint:!0,size:80,innerSize:"80%",data:o}]},function(e){var t=(e.series[0].center[0],e.series[0].center[1]),a="延迟总数<br/>"+r+"个",n=parseInt(e.title.styles.fontSize);e.setTitle({text:a,y:t+n/2-10})})}else $toast.warning(t.msg||a.msg)}).fail(function(t){e.trigger("loading.hide"),$toast.error(t)})},U=function(e){var t=$api.get({loading:!1,url:$cfg.baseUrl+"/statistics/RepairStatistics",data:$opt.paramFilter({serviceType:v.site||"-1"})});return $.when(t).done(function(t){if(e.trigger("loading.hide"),t.success){var a=t.data,n=$.map(a.taskInfo,function(e){return e.addvnm}),i=$.map(a.taskInfo,function(e){return e.ordinary+e.urgent}),r=$.map(a.taskInfo,function(e){return e.handle}),o=($.map(a.taskInfo,function(e){return e.urgent}),$.map(a.personneInfo,function(e){return e.wait})),s=$.map(a.personneInfo,function(e){return e.execution});e.find(".chart1").highcharts({chart:{type:"column",height:220,marginBottom:50},title:{text:""},xAxis:{categories:n,gridLineWidth:0,tickInterval:1,labels:{style:{fontSize:"11px"}}},yAxis:{min:0,minorTickInterval:10,allowDecimals:!1,title:{text:""},stackLabels:{enabled:!0,style:{fontWeight:"bold",color:Highcharts.theme&&Highcharts.theme.textColor||"gray"}}},legend:{align:"left",x:0,verticalAlign:"top",y:0},tooltip:{formatter:function(){return"<b>"+this.x+"</b><br/>"+this.series.name+"任务: "+this.y+"<br/>维修任务总量: "+this.point.stackTotal}},plotOptions:{column:{stacking:"normal",dataLabels:{formatter:function(){return 0===this.y?"":this.y},enabled:!0,color:Highcharts.theme&&Highcharts.theme.dataLabelsColor||"white",style:{textShadow:"0 0 9px black"}}}},series:[{maxPointWidth:20,name:"待维修",color:"#ffc000",data:i},{maxPointWidth:20,name:"维修中",color:"#ff0000",data:r}]}),e.find(".chart2").highcharts({chart:{type:"column",height:180},title:{text:""},xAxis:{categories:n,tickLength:0,labels:{enabled:!1},gridLineWidth:0},yAxis:{min:0,minorTickInterval:10,allowDecimals:!1,reversed:!0,title:{text:""},stackLabels:{enabled:!0,style:{fontWeight:"bold",color:Highcharts.theme&&Highcharts.theme.textColor||"gray"}}},legend:{align:"left",x:0,verticalAlign:"bottom",y:0},tooltip:{formatter:function(){return"<b>"+this.x+"</b><br/>"+this.series.name+"的人员: "+this.y+"<br/>运维人员总数: "+this.point.stackTotal}},plotOptions:{column:{stacking:"normal",dataLabels:{formatter:function(){return 0===this.y?"":this.y},enabled:!0,color:Highcharts.theme&&Highcharts.theme.dataLabelsColor||"white",style:{textShadow:"0 0 9px black"}}}},series:[{maxPointWidth:20,name:"任务状态",color:"#ff0000",data:s},{maxPointWidth:20,name:"待命状态",color:"#00b0f0",data:o}]})}else $toast.warning(t.msg)}).fail(function(t){e.trigger("loading.hide"),$toast.error(t)}),t},F=function(e){if(!this.attach){e.find(".chart-condition").select2().next(".select2").css("position","absolute").css("zIndex","1");var t=this;e.find(".chart-condition").on("change",function(){t.initFunc.apply(t,[e])}),this.attach=!0}var a=e.find(".chart-condition").val(),n=[{startTime:moment().add(-1,"d").format("YYYY-MM-DD"),endTime:moment().add(-1,"d").format("YYYY-MM-DD")},{startTime:moment().add(-1,"d").add(1,"d").add(-7,"d").format("YYYY-MM-DD"),endTime:moment().add(-1,"d").format("YYYY-MM-DD")},{startTime:moment().add(-1,"d").add(1,"d").add(-1,"M").format("YYYY-MM-DD"),endTime:moment().add(-1,"d").format("YYYY-MM-DD")},{startTime:moment().set("M",3).startOf("M").format("YYYY-MM-DD"),endTime:moment().set("M",8).endOf("M").format("YYYY-MM-DD")}],i=$api.get({loading:!1,url:$cfg.baseUrl+"/statistics/unobstructed",data:$.extend({},n[a],$opt.paramFilter({serviceType:v.site||"-1"}))});return $.when(i).done(function(t){if(e.trigger("loading.hide"),t.success){var a=t.data,n=$.map(a,function(e){return e.addvnm}),i=$.map(a,function(e){return e.normal}),r=$.map(a,function(e){return e.bad});e.find(".chart").highcharts({colors:["#df2d05","#00ae34"],chart:{type:"column",height:250},title:{text:""},xAxis:{categories:n},yAxis:{min:0,title:{text:""},stackLabels:{formatter:function(){var e=a[this.x].unobstructed;return(100*(null===e?1:e)).toFixed(0)+"%"},enabled:!0,style:{fontWeight:"bold",color:"#124c98"}}},legend:{align:"right",x:0,y:0,verticalAlign:"top",floating:!1,backgroundColor:"white",borderColor:"#CCC",borderWidth:1,shadow:!1},tooltip:{headerFormat:"<b>{point.x}</b><br/>",pointFormat:"{series.name}: {point.y}<br/>总数: {point.stackTotal}"},plotOptions:{column:{stacking:"normal",dataLabels:{formatter:function(){return 0===this.y?"":this.y},enabled:!0,color:"#fff"}}},series:[{maxPointWidth:20,name:"未上报",data:r},{maxPointWidth:20,name:"正常",data:i}]}),e.trigger("loading.hide")}else $toast.warning(t.msg)}).fail(function(t){e.trigger("loading.hide"),$toast.error(t)}),i},P=function(e){var t=$("#c_addvcd").find("option:selected").text(),a=$opt.paramFilter({addvcd:$("#c_addvcd").val(),serviceType:v.site||"-1"}),n=$api.get({loading:!1,url:$cfg.baseUrl+"/statistics/cityRunSituation",data:a});$.when(n).done(function(a){if(e.trigger("loading.hide"),a.success){var n=a.data[0],i=n&&n.error?n.error:0,r=n&&n.normal?n.normal:0,o=i+r;e.find(".text-area").html(t),e.find(".text-type").html(v.siteName),e.find(".error-num").html(i),e.find(".normal-num").html(r);var s=[{name:"正常站",y:r},{name:"故障站",y:i}];n&&o&&e.find(".chart").highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1,height:120,type:"pie"},title:{floating:!0,text:"圆心显示的标题",style:{fontSize:12,lineHeight:12}},tooltip:{pointFormat:"<b>{point.y}</b><br>( {point.percentage:.1f}% )"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",verticalAlign:"middle",overflow:!0,crop:!1,dataLabels:{enabled:!0,distance:18,format:"{point.name}: {point.y}",style:{color:"black",fontSize:12}}}},series:[{type:"pie",name:"series",colorByPoint:!0,size:80,innerSize:"70%",data:s}]},function(e){var t=(e.series[0].center[0],e.series[0].center[1]),a="站点总数<br/>"+o+"个",n=parseInt(e.title.styles.fontSize);e.setTitle({text:a,y:t+n/2-10})})}else $toast.warning(a.msg)}).fail(function(t){e.trigger("loading.hide"),$toast.error(t)})},Y=function(t){u&&u.fnDestroy();var a=$.extend({},$plugin.datatable_server,{iDisplayLength:10,fnServerData:function(e,a,n){var i=$.extend({},$opt.paramConvert(a),$opt.paramFilter({difference:24,addvcd:$("#c_addvcd").val(),serviceType:v.site||"-1",page:!0,type:"stinfo"})),r=$api.get({loading:!1,url:$cfg.baseUrl+"/map/faultSite24",data:i});$.when(r).done(function(e){t.trigger("loading.hide"),e.success?n($opt.dataConvert(e)):$toast.warning(e.msg)}).fail(function(e){t.trigger("loading.hide"),$toast.error(e)})},aaSorting:[[5,"asc"]],autoWidth:!1,info:"",columns:[{title:"测站编码",data:"stcd",class:"text-center"},{title:"测站类型",data:"sttp",class:"text-center",width:60,fnCreatedCell:function(e,t,a,n,i){$dict.get("stcdType").then(function(a){$.each(a,function(a,n){n.trueValue===t&&$(e).html(n.showValue)})})}},{title:"测站名称",data:"stnm",class:"text-center",width:60},{title:"地址",data:"stlc",class:"text-center",fnCreatedCell:function(t,a,n,i,r){$.when($dict.get("station")).done(function(){var i=$("#c_addvcd").val()||"",r=v.site||"",s="02"===r.toString(),d=$(".ol-cb-view").find("input").prop("checked");if("00"===i.slice(-2)&&!s&&d){var l=$("<span>"+a+'<a class="fa fa-map-marker text-green ml-5 cursor-pointer"></a></span>');l.find("a").on("click",function(){var t=$dict.getItem("station","stcd",n.stcd),a=e.proj.fromLonLat([t.longitude,t.latitude]);o.getView().setCenter(a),setTimeout(function(){var e=o.getPixelFromCoordinate(a),t=o.forEachFeatureAtPixel(e,function(e,t){var a=e.get("data");if(a.stcd===n.stcd&&a.serviceType===n.serviceType)return e});t&&w(t,a)},100)}),$(t).html("").append(l)}})}},{title:"未报送时长",data:"difference",class:"text-center",width:70,render:function(e,t,a){return e?e+"h":"从未上报"}},{title:"状态",data:"taskStatus",fnCreatedCell:function(e,t,a,n,i){if(a.taskNo){var r,o={0:"btn-red",10:"btn-dutch",20:"btn-blue",30:"btn-orange",40:"btn-amethyst",50:"btn-red",60:"btn-green",70:"btn-gray"};$dict.get("statusCode").then(function(s){$.each(s,function(s,d){if(d.value===a.taskStatus){r=$('<a class="btn btn-xs ml-5 mt-5 '+o[d.value]+'"><i class="fa fa-file-o mr-5"></i>'+d.name+"</a>"),r.on("click",function(){10===a.taskStatus||0===a.taskStatus?z(e,t,a,n,i):A(e,t,a,n,i)});var l=$('<a class="btn btn-warning btn-xs ml-5"><i class="fa fa-bell-o mr-5"></i>报修提醒</a>');l.on("click",function(){B(e,t,a,n,i)}),$(e).html("").append(l).append(r)}})})}else{var s=$('<a class="btn btn-danger btn-xs ml-5"><i class="fa fa-edit mr-5"></i>人工报修</a>');s.on("click",function(){V(e,t,a,n,i)}),$(e).html("").append(s).parents("tr").addClass("text-red")}}}]});u=t.find(".table").dataTable(a)},D=function(e){var t,a=[];t=$dict.initOptions({elem:"#p_maintUserId",dict:"maintainer",propText:"name",propId:"id",append:[{id:"-1",text:"未指派"}]}),a.push(t),t=$dict.initOptions({elem:"#p_helpPersonnel",dict:"maintainer",propText:"name",propId:"id"}),a.push(t),t=$dict.initOptions({elem:"#p_priorityStatus",dict:"priority",propText:"showValue",propId:"trueValue"}),a.push(t),t=$dict.initOptions({s2s:!0,elem:"#p_addvcd",dict:"addvcd",propText:"addvnm",propId:"addvcd",filter:function(e,t){var a=$.userData.addvcd;return"0000"===a.slice(-4)||"00"===a.slice(-2)&&e.addvcd.slice(0,-2)===a.slice(0,-2)||a===e.addvcd}}),a.push(t),t=$dict.initOptions({elem:"#p_taskStatus",dict:"statusCode",propText:"name",propId:"value"}),a.push(t),t=$dict.initOptions({elem:"#p_serviceType",dict:"serviceType",propText:"showValue",propId:"trueValue"}),a.push(t),$.when.apply($,a).done(function(){$.isFunction(e)&&e()})},N=function(e){var t=$api.get({loading:!1,url:$cfg.baseUrl+"/maintGps/distance/",data:{stionId:e.stionId}});$.when(t).done(function(t){if(t.success){var a=$.map(t.data,function(t){if(t.id===e.repairId)return $.extend({type:"自动指派",state:t.state,taskNo:t.taskNo},$dict.getItem("maintainer","id",t.id))}),n=[],i=[];$.each(t.data,function(e,t){1===t.exist&&t.distance<10?n.push($.extend({type:"距故障站<10km",state:t.state,taskNo:t.taskNo},$dict.getItem("maintainer","id",t.id))):i.push($.extend({type:"其他",state:t.state,taskNo:t.taskNo},$dict.getItem("maintainer","id",t.id)))}),$dict.add("gps_maint",a.concat(n).concat(i)),$dict.initOptions({s2s:"user",elem:"#p_maintUserId",dict:"gps_maint",propText:"name",propId:"id",templateResult:function(e){if(e.data){var t=3;0===e.data.state&&(t=e.data.taskNo?2:1);var a='<span class="select2-results-item"><img src="assets/img/map/p'+t+'.png"><b>'+e.text+"</b></span>";return $(a).get(0)}return e.text},propData:function(e){return e}}),$("#p_maintUserId").val(e.maintUserId).change()}else $toast.warning(t.msg)}).fail(function(e){$toast.error(e)})},O={},M={ignore:".ignore",errorPlacement:function(e,t){e.appendTo(t.parents(".form-group"))},rules:{priorityStatus:{required:!0}},messages:{priorityStatus:{required:"请选择优先级"}}},V=function(e,t,a,n,i){var r=$msg.dialog("manualAdd",function(e,t){return $(t).find("form").submit(),!1},{title:"新增报修单"});$.when(r).then(function(e){var t=e.find("form");D(function(){t.formData($.extend({},O,a)),$.updateTextFields();var n=$.extend({},M,{submitHandler:function(n){var i={},r=t.formData();$.extend(i,r,{stionId:a.stionId,taskStatus:"-1"!==r.maintUserId?10:"-1"});var o=$api.post({url:$cfg.baseUrl+"/task/addTask",data:$opt.paramFilter(i)});$.when(o).done(function(t){t.success?($toast.success(t.msg),e.modal("hide"),$("#b_refresh").trigger("click")):$toast.warning(t.msg)}).fail(function(e){$toast.error(e)})}});t.validate(n),t.formDisable(!1),$("#p_stcd").attr("disabled","true"),$("#p_stnm").attr("disabled","true"),N(a)})})},z=function(e,t,a,n,i){var r={ignore:".ignore",errorPlacement:function(e,t){e.appendTo(t.parents(".form-group"))},rules:{maintUserId:{required:!0},priorityStatus:{required:!0}},messages:{maintUserId:{required:"请选择维修人员"},priorityStatus:{required:"请选择优先级"}}},o=$api.get({loading:!1,url:$cfg.baseUrl+"/task/load/"+a.taskNo}),s=$msg.dialog("dispatchAdd",function(e,t){return $(t).find("form").submit(),!1},{title:"运维派单"});$.when(s,o,$dict.get("station")).then(function(e,t){if(t.success){var n=e.find("form");D(function(){var i=$dict.getItem("station","stionId",t.data.stionId);n.formData($.extend({},O,t.data,{serviceType:i.serviceType,stcd:i.stcd,helpPersonnel:(t.data.helpPersonnel||"").split(","),stnm:i.stnm})),$.updateTextFields();var o=$.extend({},r,{submitHandler:function(t){var i={},r=n.formData();$.extend(i,r,{taskStatus:10});var o=$api.put({url:$cfg.baseUrl+"/task/update/"+a.taskNo,data:$opt.paramFilter(i)});$.when(o).done(function(t){t.success?($toast.success(t.msg),e.modal("hide"),u.fnUpdate()):$toast.warning(t.msg)}).fail(function(e){$toast.error(e)})}});n.validate(o),n.formDisable(!1),$("#p_taskNo").attr("disabled","true"),$("#p_stcd").attr("disabled","true"),$("#p_stnm").attr("disabled","true"),$("#p_serviceType").attr("disabled","true"),$("#p_addvcd").attr("disabled","true"),$("#p_content").attr("disabled","true"),N(a)})}else $toast.warning(t.msg),e.modal("hide")})},A=function(e,a,n,i,o){var s=$msg.dialog("taskInfo",function(e,t){return!1},{title:"维修单详情",modalClassName:"modal-lg",buttons:{success:{label:"确定",className:"btn-info"}}}),d=$api.get({loading:!1,url:$cfg.baseUrl+"/task/load/"+n.taskNo});$.when(s,d,$dict.get("station")).then(function(e,a){if(a.success){var i=e.find("form.info-left"),o=e.find("form.info-right"),s=-1,d=function(){var a=$api.get({loading:!1,url:$cfg.baseUrl+"/taskProcess/loadAll/"+n.taskNo});$.when(a).done(function(a){if(a.success){a&&a.data&&a.data.length>0&&(s=a.data[a.data.length-1].id);var n=o.find(".task-timeline");$cfg.picUrl&&$.each(a.data,function(e,t){$.each(t.basTaskDealNodes,function(e,t){t.url=$cfg.picUrl+t.url})});var d=t.compile(r)(a);n.html(d),n.imagesLoaded(function(){i.height(Math.max(i.height(),o.height())),e.resize()})}else $toast.warning(a.msg),e.modal("hide")}).fail(function(e){$toast.error(e)})};D(function(){var e=$dict.getItem("station","stionId",a.data.stionId);i.formData($.extend({},O,a.data,{serviceType:e.serviceType,stcd:e.stcd,helpPersonnel:(a.data.helpPersonnel||"").split(","),stnm:e.stnm})),$.updateTextFields(),i.formDisable(!1),$("#p_taskNo").attr("disabled","true"),$("#p_taskStatus").attr("disabled","true"),$("#p_stcd").attr("disabled","true"),$("#p_stnm").attr("disabled","true"),$("#p_serviceType").attr("disabled","true"),$("#p_addvcd").attr("disabled","true"),$("#p_content").attr("disabled","true"),$("#p_priorityStatus").attr("disabled","true"),$("#p_createTime").attr("disabled","true"),$("#p_maintUserId").attr("disabled","true"),$("#p_helpPersonnel").attr("disabled","true");var t={ignore:".ignore",errorPlacement:function(e,t){e.appendTo(t.parents(".form-group"))},rules:{content:{required:!0}},messages:{content:{required:"内容不能为空"}}},r=$.extend({},t,{submitHandler:function(e){var t={},a=o.formData();$.extend(t,a,{taskNo:n.taskNo,dealType:1,procId:s});var i=$api.post({url:$cfg.baseUrl+"/taskDealNode/addJournal",data:$opt.paramFilter(t)});$.when(i).done(function(e){e.success?($toast.success(e.msg),o.get(0).reset(),d()):$toast.warning(e.msg)}).fail(function(e){$toast.error(e)})}});o.validate(r),d()})}else $toast.warning(a.msg),e.modal("hide")})},B=function(e,t,a,n,i){var r=$api.post({loading:!1,url:$cfg.baseUrl+"/message/addUpdate",data:{message:"[报修提醒]你有新的任务单"+a.stnm+"测站24小时未上报",type:1,state:0,taskNo:a.taskNo,level:2}});$.when(r).done(function(e){e.success?($toast.success("提醒成功！"),q()):$toast.warning(e.msg)}).fail(function(e){$toast.error(e)})},H=function(e,t,a,n,i){var r=$msg.dialog("historyAdd",function(e,t){return!0},{title:"站点历史维修单",modalClassName:"modal-lg",buttons:{success:{label:"确定",className:"btn-info"}}});$.when(r).then(function(e){m&&m.fnDestroy();var t=$.extend({},$plugin.datatable_server,{fnServerData:function(e,t,n){var i=$.extend({},$opt.paramConvert(t),$opt.paramFilter({stionId:a.stionId,taskStatus:60})),r=$api.get({url:$cfg.baseUrl+"/task/history",data:i});$.when(r).done(function(e){e.success?n($opt.dataConvert(e)):$toast.warning(e.msg)}).fail(function(e){$toast.error(e)})},aaSorting:[[0,"desc"]],columns:[{title:"测站名称",data:"stionId",class:"text-center",fnCreatedCell:function(e,t,a,n,i){$dict.get("station").then(function(a){$.each(a,function(a,n){n.stionId===t&&$(e).html(n.stnm)})})}},{title:"维修区域",data:"addvcd",class:"text-center",fnCreatedCell:function(e,t,a,n,i){$dict.get("addvcd").then(function(a){$.each(a,function(a,n){n.addvcd===t&&$(e).html(n.addvnm)})})}},{title:"创建时间",data:"createTime",class:"text-center"},{title:"响应/修复",data:"taskStatus",class:"text-center",fnCreatedCell:function(e,t,a,n,i){var r="",o=moment(a.reciveTime).diff(moment(a.createTime),"hours"),s=moment(a.finishTime).diff(moment(a.dealTime),"hours");r+=t>10?'<div>响应<span class="text-red">'+o+"</span>小时</div>\n":"<div>未响应</div>\n",r+=t>30?'<div>修复<span class="text-red">'+s+"</span>小时</div>":"<div>未修复</div>",$(e).html(r)}},{title:"状态",data:"taskStatus",class:"text-center",fnCreatedCell:function(e,t,a,n,i){var r={0:"mt-5 badge bg-red",10:"mt-5 badge bg-dutch",20:"mt-5 badge bg-blue",30:"mt-5 badge bg-orange",40:"mt-5 badge bg-amethyst",50:"mt-5 badge bg-red",60:"mt-5 badge bg-green"};$dict.get("statusCode").then(function(a){$.each(a,function(a,n){n.value===t&&$(e).html('<div class="'+r[n.value]+'">'+n.name+"</div>")})})}},{title:"维修人员",data:"maintUserId",class:"text-center",fnCreatedCell:function(e,t,a,n,i){$(e).html(""),$dict.get("maintainer").then(function(a){$.each(a,function(a,n){n.id===t&&$(e).html(n.name)})})}},{title:"联系电话",data:"maintUserId",class:"text-center",fnCreatedCell:function(e,t,a,n,i){$dict.get("maintainer").then(function(a){var n="";$.each(a,function(e,a){a.id===t&&a.phone&&(n='<a><i class="fa fa-phone-square text-success ml-5"></i> '+a.phone+"</a>")}),$(e).html(n)})}},{title:"操作",data:"taskStatus",bSortable:!1,fnCreatedCell:function(e,t,a,n,i){var r=$('<a class="btn btn-info btn-xs ml-5"><i class="fa fa-file-o"></i>详情</a>');r.on("click",function(){A(e,t,a,n,i)}),$(e).html("").append(r)}}]});m=$(e).find(".table").dataTable(t)})},W=function(){var e,a=$("#c_addvcd").val()||"";e="0000"===a.slice(-4)?[{elem:$("#p_panel_1").get(0),data:{title:"故障站点统计"},initFunc:L},{elem:$("#p_panel_2").get(0),data:{title:"全省任务及人员信息统计"},initFunc:U},{elem:$("#p_panel_3").get(0),data:{title:"各市畅通率统计"},initFunc:F}]:[{elem:$("#p_panel_4").get(0),data:{title:"市級故障站点统计"},initFunc:P},{elem:$("#p_panel_5").get(0),data:{title:"故障站点信息详情"},initFunc:Y}];var n=$(".slidebar-content");n.html(""),$.map(e,function(e){var a=e.html||e.elem.innerHTML.replace(/\[\[/g,"{{").replace(/]]/g,"}}"),i=t.compile(a)(e.data||{}),r=$(i);r.on("refresh",function(){$.isFunction(e.initFunc)&&(r.trigger("loading.show"),e.initFunc.apply(e,[r]))}),n.append(r),$.isFunction(e.initFunc)&&(e.attach=!1,e.initFunc.apply(e,[r]))})},q=function(){var e=$api.get({loading:!1,url:$cfg.baseUrl+"/message/select",data:{page:"false",orderdir:"desc",order:"createTime"}});$.when(e).done(function(e){if(e.success){var a=$("#p_info").get(0).innerHTML.replace(/\[\[/g,"{{").replace(/]]/g,"}}"),n=t.compile(a)({data:e.data});$(".txtMarquee").html(n).slide({mainCell:"ul",autoPlay:!0,effect:"leftMarquee",vis:2,interTime:50})}else $toast.warning(e.msg)}).fail(function(e){$toast.error(e)})},j=0,R=function(){q(),j=setInterval(q,3e5),$(".txtMarquee").on("click","li",function(){var e=$(this).attr("data-taskNo"),t=$(this).attr("data-type");"1"!==t&&"2"!==t||!e||A(null,null,{taskNo:e},null,null)})};return{data:{},init:function(e){console.log(e+":init"),_(),S(),R()},dispose:function(e){console.log(e+":dispose"),clearInterval(j)}}});