define(["datatables","bootstrap-datetimepickerCN"],function(){var e,t={ignore:".ignore",errorPlacement:function(e,t){e.appendTo(t.parents(".form-group"))},rules:{loginId:{required:!0},name:{required:!0},roleId:{required:!0},addvcd:{required:!0}},messages:{loginId:{required:"请填写登录ID"},name:{required:"请填写用户名称"},roleId:{required:"请选择用户角色"},addvcd:{required:"请选择管理区域"}}},a=function(){$dict.init({name:"addvcd",url:$cfg.baseUrl+"/addvcd/loadAll/"}),$dict.init({name:"role",url:$cfg.baseUrl+"/role/loadAll/"}),$dict.init({name:"user",url:$cfg.baseUrl+"/users/loadAll/"})},n=function(){i(),$("#b_refresh,#b_search").on("click",function(){i()}),$("#b_add").on("click",function(){c()})},i=function(){e&&e.fnDestroy();var t=$.extend({},$plugin.datatable_server,{fnServerData:function(e,t,a){var n=$.extend({},$opt.paramConvert(t),$opt.paramFilter({loginId:$("#c_loginId").val(),name:$("#c_name").val(),phone:$("#c_phone").val()})),i=$api.get({url:$cfg.baseUrl+"/users/select",data:n});$.when(i).done(function(e){e.success?a($opt.dataConvert(e)):$toast.warning(e.msg)}).fail(function(e){$toast.error(e)})},aaSorting:[[0,"desc"]],columns:[{title:"登录ID",data:"loginId",class:"text-center"},{title:"用户名称",data:"name",class:"text-center"},{title:"手机",data:"phone",class:"text-center"},{title:"角色",data:"roleId",class:"text-center",fnCreatedCell:function(e,t,a,n,i){$dict.get("role").then(function(a){$.each(a,function(a,n){n.id===t&&$(e).html(n.name)})})}},{title:"创建时间",data:"createTime",class:"text-center"},{title:"管理区域",data:"addvcd",class:"text-center",fnCreatedCell:function(e,t,a,n,i){$dict.get("addvcd").then(function(a){var n=(t||"").split(","),i=[];$.each(a,function(e,t){n.indexOf(t.addvcd)>-1&&i.push(t.addvnm)}),$(e).html(i.join(","))})}},{title:"直属市局",data:"directlyUnder",class:"text-center",fnCreatedCell:function(e,t,a,n,i){$dict.get("addvcd").then(function(a){var n=(t||"").split(","),i=[];$.each(a,function(e,t){n.indexOf(t.addvcd)>-1&&i.push(t.addvnm)}),$(e).html(i.join(","))})}},{title:"是否有效",data:"isEnable",class:"text-center",render:function(e,t,a){return 1===e?"是":"否"}},{title:"是否app用户",data:"isApp",class:"text-center",render:function(e,t,a){return 1===e?"是":"否"}},{title:"操作",data:"id",bSortable:!1,fnCreatedCell:function(e,t,a,n,i){var s=$('<a class="btn btn-warning btn-xs ml-5"><i class="fa fa-edit"></i>修改</a>'),r=$('<a class="btn btn-danger btn-xs ml-5"><i class="fa fa-trash-o"></i>删除</a>'),c=$('<a class="btn btn-info btn-xs ml-5"><i class="fa fa-file-o"></i>查看</a>'),f=$('<a class="btn btn-success btn-xs ml-5"><i class="fa fa-key"></i>修改密码</a>');s.on("click",function(){o(e,t,a,n,i)}),r.on("click",function(){l(e,t,a,n,i)}),c.on("click",function(){u(e,t,a,n,i)}),f.on("click",function(){d(e,t,a,n,i)}),$(e).html("").append(s).append(r).append(c).append(f)}}]});e=$("#t_sysuser").dataTable(t)},s=function(e){var t,a=[];t=$dict.initOptions({elem:"#p_addvcd",dict:"addvcd",propText:"addvnm",propId:"addvcd",filter:function(e,t){var a=$.userData.addvcd,n=$.userData.role;return("0000"===a.slice(-4)||"00"===a.slice(-2)&&e.addvcd.slice(0,-2)===a.slice(0,-2)||a===e.addvcd)&&"00"===e.addvcd.slice(-2)||"provincial"===n.distinguish}}),a.push(t);var n={maintainer:0,manager:1,municipal:2,provincial:3};t=$dict.initOptions({elem:"#p_roleId",dict:"role",propText:"name",propId:"id",filter:function(e,t){var a=$.userData.role,i=n[a.distinguish];return n[e.distinguish]<i||"provincial"===a.distinguish}}),a.push(t),t=$dict.initOptions({elem:"#p_createUserId",dict:"user",propText:"name",propId:"id"}),a.push(t),t=$dict.initOptions({s2s:!0,elem:"#p_directlyUnder",dict:"addvcd",propText:"addvnm",propId:"addvcd",filter:function(e,t){var a=$.userData.addvcd;return("0000"===a.slice(-4)||"00"===a.slice(-2)&&e.addvcd.slice(0,-2)===a.slice(0,-2)||a===e.addvcd)&&"00"===e.addvcd.slice(-2)}}),a.push(t),$.when.apply($,a).done(function(){$.isFunction(e)&&e()})},r={isEnable:1,isApp:0},d=function(e,t,a,n,i){var s={ignore:".ignore",errorPlacement:function(e,t){e.appendTo(t.parents(".form-group"))},rules:{newPass:{required:!0},comfirmPass:{required:!0,equalTo:"#p_newPass"},currentPass:{required:!0}},messages:{newPass:{required:"请填写新密码"},comfirmPass:{required:"请填写确认密码",equalTo:"确认密码与新密码不一致"},currentPass:{required:"请填写当前用户密码"}}},r=$msg.dialog("changePwd",function(e,t){return $(t).find("form").submit(),!1},{title:"修改密码"});$.when(r).then(function(e){var t=e.find("form");t.formData({name:a.name}),$.updateTextFields();var n=$.extend({},s,{submitHandler:function(n){var i={},s=t.formData();$.extend(i,s,{newPass:$.md5(s.newPass),currentPass:$.md5(s.currentPass),comfirmPass:$.md5(s.comfirmPass)}),delete i.name,delete i.comfirmPass;var r=$api.post({url:$cfg.baseUrl+"/users/updatePass/"+a.id,data:$opt.paramFilter(i)});$.when(r).done(function(t){t.success?($toast.success(t.msg),e.modal("hide"),$cfg.webInfo.user.id===a.id&&($api.get({url:$cfg.baseUrl+"/me/logout"}),$msg.warning("修改当前用户密码需要重新登录",{buttons:{success:{label:"确定",className:"btn-success",callback:function(){location.href="login.html"}}}}))):$toast.warning(t.msg)}).fail(function(e){$toast.error(e)})}});t.validate(n),t.formDisable(!1),$("#p_name").attr("disabled","true")})},c=function(){var a=$msg.dialog("sysuserAdd",function(e,t){return $(t).find("form").submit(),!1},{title:"新增用户",modalClassName:"modal-lg"});$.when(a).then(function(a){var n=a.find("form");s(function(){n.formData(r),$.updateTextFields(),$("#p_createUserId").parents(".col-md-6").remove(),$("#p_createTime").parents(".col-md-6").remove();var i=$.extend({},t,{submitHandler:function(t){var i={},s=n.formData();$.extend(i,s);var r=$api.post({url:$cfg.baseUrl+"/users/add",data:$opt.paramFilter(i)});$.when(r).done(function(t){t.success?($toast.success(t.msg),a.modal("hide"),$dict.remove("user"),$dict.remove("maintainer"),e.fnUpdate()):$toast.warning(t.msg)}).fail(function(e){$toast.error(e)})}});n.validate(i),n.formDisable(!1)})})},o=function(a,n,i,d,c){var o=$msg.dialog("sysuserAdd",function(e,t){return $(t).find("form").submit(),!1},{title:"修改用户信息",modalClassName:"modal-lg"}),l=$api.get({url:$cfg.baseUrl+"/users/load/"+i.id});$.when(o,l).then(function(a,n){var i=a.find("form");s(function(){$("#p_createUserId").parents(".col-md-6").remove(),$("#p_createTime").parents(".col-md-6").remove();var s=$.extend({},t,{submitHandler:function(t){var n={},s=i.formData();$.extend(n,s);var r=$api.put({url:$cfg.baseUrl+"/users/update/",data:$opt.paramFilter(n)});$.when(r).done(function(t){t.success?($toast.success(t.msg),a.modal("hide"),$dict.remove("user"),$dict.remove("maintainer"),e.fnUpdate()):$toast.warning(t.msg)}).fail(function(e){$toast.error(e)})}});i.validate(s),n.success?($toast.success(n.msg),n.data.addvcd=(n.data.addvcd||"").split(","),i.formData($.extend({},r,n.data)),$.updateTextFields(),i.formDisable(!1),$("#p_loginId").attr("disabled","true")):($toast.warning(n.msg),a.modal("hide"))})})},l=function(t,a,n,i,s){$msg.confirm("是否删除该记录?",function(){var t=$api.del({url:$cfg.baseUrl+"/users/delete/"+n.id});$.when(t).done(function(t){t.success?($toast.success(t.msg),$dict.remove("user"),$dict.remove("maintainer"),e.fnUpdate()):$toast.warning(t.msg)}).fail(function(e){$toast.error(e)})})},u=function(e,t,a,n,i){var d=$msg.dialog("sysuserAdd",function(e,t){},{title:"用户信息",modalClassName:"modal-lg",buttons:{success:{label:"确定",className:"btn-info"}}}),c=$api.get({url:$cfg.baseUrl+"/users/load/"+a.id});$.when(d,c).then(function(e,t){var a=e.find("form");s(function(){a.formDisable(!0),t.success?($toast.success(t.msg),t.data.addvcd=(t.data.addvcd||"").split(","),a.formData($.extend({},r,t.data)),$.updateTextFields(),a.formDisable(!0)):($toast.warning(t.msg),e.modal("hide"))})})};return{data:{model:[{icon:"fa fa-key",title:"权限管理"},{icon:"",title:"系统用户管理"}]},init:function(e){console.log(e+":init"),a(),n()},dispose:function(e){console.log(e+":dispose")}}});