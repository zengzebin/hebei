define(["datatables","bootstrap-datetimepickerCN","jstree"],function(){var e,t={ignore:".ignore",errorPlacement:function(e,t){e.appendTo(t.parents(".form-group"))},rules:{name:{required:!0}},messages:{name:{required:"请填写角色名称"}}},n=function(){$dict.init({name:"user",url:$cfg.baseUrl+"/users/loadAll/"}),$dict.init({name:"menu",url:$cfg.baseUrl+"/menu/loadAll/"})},a=function(){$("#b_refresh,#b_search").on("click",function(){s()}),$("#b_add").on("click",function(){i()}),s()},s=function(){e&&e.fnDestroy();var t=$.extend({},$plugin.datatable_server,{fnServerData:function(e,t,n){var a=$.extend({},$opt.paramConvert(t),$opt.paramFilter({name:$("#c_name").val()})),s=$api.get({url:$cfg.baseUrl+"/role/select",data:a});$.when(s).done(function(e){e.success?n($opt.dataConvert(e)):$toast.warning(e.msg)}).fail(function(e){$toast.error(e)})},aaSorting:[[0,"desc"]],columns:[{title:"角色名称",data:"name",class:"text-center"},{title:"角色首页",data:"indexUrl",class:"text-center"},{title:"是否维修角色",data:"isOperation",class:"text-center",render:function(e,t,n){return 1===e?"是":"否"}},{title:"创建人",data:"createUserId",class:"text-center",fnCreatedCell:function(e,t,n,a,s){$dict.get("user").then(function(n){$.each(n,function(n,a){a.id===t&&$(e).html(a.name)})})}},{title:"创建时间",data:"createTime",class:"text-center"},{title:"操作",data:"id",bSortable:!1,fnCreatedCell:function(e,t,n,a,s){var o=$('<a class="btn btn-warning btn-xs ml-5"><i class="fa fa-edit"></i>修改</a>'),r=$('<a class="btn btn-danger btn-xs ml-5"><i class="fa fa-trash-o"></i>删除</a>'),i=$('<a class="btn btn-info btn-xs ml-5"><i class="fa fa-file-o"></i>查看</a>'),u=$('<a class="btn btn-success btn-xs ml-5"><i class="fa fa-key"></i>权限</a>');o.on("click",function(){c(e,t,n,a,s)}),r.on("click",function(){d(e,t,n,a,s)}),i.on("click",function(){l(e,t,n,a,s)}),u.on("click",function(){f(e,t,n,a,s)}),$(e).html("").append(o).append(r).append(i).append(u)}}]});e=$("#t_sysrole").dataTable(t)},o=function(e){var t,n=[];t=$dict.initOptions({elem:"#p_createUserId",dict:"user",propText:"name",propId:"id"}),n.push(t),$.when.apply($,n).done(function(){$.isFunction(e)&&e()})},r={},i=function(){var n=$msg.dialog("sysroleAdd",function(e,t){return $(t).find("form").submit(),!1},{title:"新增角色"});$.when(n).then(function(n){var a=n.find("form");o(function(){a.formData(r),$.updateTextFields(),$("#p_createUserId").parents(".form-group").parent().remove(),$("#p_createTime").parents(".form-group").parent().remove();var s=$.extend({},t,{submitHandler:function(t){var s={},o=a.formData();$.extend(s,o);var r=$api.post({url:$cfg.baseUrl+"/role/add",data:$opt.paramFilter(s)});$.when(r).done(function(t){t.success?($toast.success(t.msg),n.modal("hide"),$dict.remove("role"),e.fnUpdate()):$toast.warning(t.msg)}).fail(function(e){$toast.error(e)})}});a.validate(s),a.formDisable(!1)})})},c=function(n,a,s,i,c){var d=$msg.dialog("sysroleAdd",function(e,t){return $(t).find("form").submit(),!1},{title:"修改角色信息"}),l=$api.get({url:$cfg.baseUrl+"/role/load/"+s.id});$.when(d,l).then(function(n,a){var i=n.find("form");o(function(){$("#p_createUserId").parents(".form-group").parent().remove(),$("#p_createTime").parents(".form-group").parent().remove();var o=$.extend({},t,{submitHandler:function(t){var a={},o=i.formData();$.extend(a,o);var r=$api.put({url:$cfg.baseUrl+"/role/update/"+s.id,data:$opt.paramFilter(a)});$.when(r).done(function(t){t.success?($toast.success(t.msg),n.modal("hide"),$dict.remove("role"),e.fnUpdate()):$toast.warning(t.msg)}).fail(function(e){$toast.error(e)})}});i.validate(o),a.success?($toast.success(a.msg),i.formData($.extend({},r,a.data)),$.updateTextFields(),i.formDisable(!1)):($toast.warning(a.msg),n.modal("hide"))})})},d=function(t,n,a,s,o){$msg.confirm("是否删除该记录?",function(){var t=$api.del({url:$cfg.baseUrl+"/role/delete/"+a.id});$.when(t).done(function(t){t.success?($toast.success(t.msg),$dict.remove("role"),e.fnUpdate()):$toast.warning(t.msg)}).fail(function(e){$toast.error(e)})})},l=function(e,t,n,a,s){var i=$msg.dialog("sysroleAdd",function(e,t){},{title:"角色信息",buttons:{success:{label:"确定",className:"btn-info"}}}),c=$api.get({url:$cfg.baseUrl+"/role/load/"+n.id});$.when(i,c).then(function(e,t){var n=e.find("form");o(function(){n.formDisable(!0),t.success?($toast.success(t.msg),n.formData($.extend({},r,t.data)),$.updateTextFields(),n.formDisable(!0)):($toast.warning(t.msg),e.modal("hide"))})})},f=function(e,t,n,a,s){var o=$msg.dialog("permissionAdd",function(e,t){var a=t.find("#treeCheckbox").jstree("get_bottom_checked"),s={roleId:n.id,menuIds:a.join(",")},o=$api.post({url:$cfg.baseUrl+"/role/addPermission/",data:s});$.when(o).done(function(e){e.success?($toast.success(e.msg),t.modal("hide")):($toast.warning(e.msg),t.modal("hide"))}).fail(function(e){$toast.error(e),t.modal("hide")})},{title:"角色权限"});$.when(o).then(function(e){var t={roleId:n.id},a=$api.get({url:$cfg.baseUrl+"/role/getPermission/",data:t});$.when(a,$dict.get("menu")).done(function(t,n){if(t.success){$toast.success(t.msg);var a=[],s=$.map(t.data,function(e){return e.menuId});$.each(n,function(e,t){var n={id:t.menuId,parent:0===t.parentId?"#":t.parentId,text:t.menuText,state:{opened:!0,selected:s.indexOf(t.menuId)>-1}};a.push(n)}),e.find("#treeCheckbox").jstree({core:{themes:{responsive:!0},data:a},types:{default:{icon:"fa fa-cubes"}},plugins:["types","checkbox"]}).on("loaded.jstree",function(){e.resize()})}else $toast.warning(t.msg),e.modal("hide")}).fail(function(t){$toast.error(t),e.modal("hide")})})};return{data:{model:[{icon:"fa fa-key",title:"权限管理"},{icon:"",title:"角色权限管理"}]},init:function(e){console.log(e+":init"),n(),a()},dispose:function(e){console.log(e+":dispose")}}});