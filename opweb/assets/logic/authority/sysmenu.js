define(["datatables","bootstrap-datetimepickerCN"],function(){var e,t={ignore:".ignore",errorPlacement:function(e,t){e.appendTo(t.parents(".form-group"))},rules:{menuText:{required:!0}},messages:{menuText:{required:"请填写菜单名称"}}},n=function(){$dict.init({name:"menu",url:$cfg.baseUrl+"/menu/loadAll/"})},a=function(){var e,t=[];e=$dict.initOptions({elem:"#c_parentId",dict:"menu",propText:"menuText",propId:"menuId",filter:function(e){return 1===e.haveChild},append:[{id:"-1",text:"全部"}]}),t.push(e),$.when.apply($,t).done(function(){i()}),$("#b_refresh,#b_search").on("click",function(){i()}),$("#b_add").on("click",function(){r()})},i=function(){e&&e.fnDestroy();var t=$.extend({},$plugin.datatable_server,{fnServerData:function(e,t,n){var a=$.extend({},$opt.paramConvert(t),$opt.paramFilter({menuText:$("#c_menuText").val(),parentId:$("#c_parentId").val()})),i=$api.get({url:$cfg.baseUrl+"/menu/select",data:a});$.when(i).done(function(e){e.success?n($opt.dataConvert(e)):$toast.warning(e.msg)}).fail(function(e){$toast.error(e)})},aaSorting:[[0,"desc"]],columns:[{title:"菜单名称",data:"menuText",class:"text-center"},{title:"菜单图标",data:"menuIcon",class:"text-center"},{title:"菜单url",data:"menuHref",class:"text-center"},{title:"父级菜单",data:"parentId",class:"text-center",fnCreatedCell:function(e,t,n,a,i){0===t&&$(e).html(""),$dict.get("menu").then(function(n){$.each(n,function(n,a){a.menuId===t&&$(e).html(a.menuText)})})}},{title:"是否包含子菜单",data:"haveChild",class:"text-center",render:function(e,t,n){return 1===e?"是":"否"}},{title:"排序",data:"sort",class:"text-center"},{title:"操作",data:"menuId",bSortable:!1,fnCreatedCell:function(e,t,n,a,i){var o=$('<a class="btn btn-warning btn-xs ml-5"><i class="fa fa-edit"></i>修改</a>'),s=$('<a class="btn btn-danger btn-xs ml-5"><i class="fa fa-trash-o"></i>删除</a>'),r=$('<a class="btn btn-info btn-xs ml-5"><i class="fa fa-file-o"></i>查看</a>');o.on("click",function(){c(e,t,n,a,i)}),s.on("click",function(){d(e,t,n,a,i)}),r.on("click",function(){l(e,t,n,a,i)}),$(e).html("").append(o).append(s).append(r)}}]});e=$("#t_sysmenu").dataTable(t)},o=function(e){var t,n=[];t=$dict.initOptions({elem:"#p_parentId",dict:"menu",propText:"menuText",propId:"menuId",filter:function(e){return 1===e.haveChild},append:[{id:"0",text:"无"}]}),n.push(t),$.when.apply($,n).done(function(){$.isFunction(e)&&e()})},s={haveChild:0},r=function(){var n=$msg.dialog("sysmenuAdd",function(e,t){return $(t).find("form").submit(),!1},{title:"新增菜单",modalClassName:"modal-lg"});$.when(n).then(function(n){var a=n.find("form");o(function(){a.formData(s),$.updateTextFields();var i=$.extend({},t,{submitHandler:function(t){var i={},o=a.formData();$.extend(i,o);var s=$api.post({url:$cfg.baseUrl+"/menu/add",data:$opt.paramFilter(i)});$.when(s).done(function(t){t.success?($toast.success(t.msg),n.modal("hide"),$dict.remove("menu"),e.fnUpdate()):$toast.warning(t.msg)}).fail(function(e){$toast.error(e)})}});a.validate(i),a.formDisable(!1)})})},c=function(n,a,i,r,c){var d=$msg.dialog("sysmenuAdd",function(e,t){return $(t).find("form").submit(),!1},{title:"修改菜单信息",modalClassName:"modal-lg"}),l=$api.get({url:$cfg.baseUrl+"/menu/load/"+i.menuId});$.when(d,l).then(function(n,a){var r=n.find("form");o(function(){var o=$.extend({},t,{submitHandler:function(t){var a={},o=r.formData();$.extend(a,o);var s=$api.put({url:$cfg.baseUrl+"/menu/update/"+i.menuId,data:$opt.paramFilter(a)});$.when(s).done(function(t){t.success?($toast.success(t.msg),n.modal("hide"),$dict.remove("menu"),e.fnUpdate()):$toast.warning(t.msg)}).fail(function(e){$toast.error(e)})}});r.validate(o),a.success?($toast.success(a.msg),r.formData($.extend({},s,a.data)),$.updateTextFields(),r.formDisable(!1)):($toast.warning(a.msg),n.modal("hide"))})})},d=function(t,n,a,i,o){$msg.confirm("是否删除该记录?",function(){var t=$api.del({url:$cfg.baseUrl+"/menu/delete/"+a.menuId});$.when(t).done(function(t){t.success?($toast.success(t.msg),$dict.remove("menu"),e.fnUpdate()):$toast.warning(t.msg)}).fail(function(e){$toast.error(e)})})},l=function(e,t,n,a,i){var r=$msg.dialog("sysmenuAdd",function(e,t){},{title:"菜单信息",modalClassName:"modal-lg",buttons:{success:{label:"确定",className:"btn-info"}}}),c=$api.get({url:$cfg.baseUrl+"/menu/load/"+n.menuId});$.when(r,c).then(function(e,t){var n=e.find("form");o(function(){n.formDisable(!0),t.success?($toast.success(t.msg),n.formData($.extend({},s,t.data)),$.updateTextFields(),n.formDisable(!0)):($toast.warning(t.msg),e.modal("hide"))})})};return{data:{model:[{icon:"fa fa-key",title:"权限管理"},{icon:"",title:"菜单模块管理"}]},init:function(e){console.log(e+":init"),n(),a()},dispose:function(e){console.log(e+":dispose")}}});