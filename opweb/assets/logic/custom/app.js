define(["common","handlebars","html!!header"],function(e,n,t){$dict.init({name:"menu",url:$cfg.baseUrl+"/menu/loadAll/"}),$dict.init({name:"role",url:$cfg.baseUrl+"/role/loadAll/"});var r=function(e){var n={ignore:".ignore",errorPlacement:function(e,n){e.appendTo(n.parents(".form-group"))},rules:{newPass:{required:!0},comfirmPass:{required:!0,equalTo:"#p_newPass"},currentPass:{required:!0}},messages:{newPass:{required:"请填写新密码"},comfirmPass:{required:"请填写确认密码",equalTo:"确认密码与新密码不一致"},currentPass:{required:"请填写当前用户密码"}}},t=$msg.dialog("changePwd",function(e,n){return $(n).find("form").submit(),!1},{title:"修改密码"});$.when(t).then(function(t){var r=t.find("form");r.formData({name:e.name}),$.updateTextFields();var i=$.extend({},n,{submitHandler:function(n){var i={},o=r.formData();$.extend(i,o,{newPass:$.md5(o.newPass),currentPass:$.md5(o.currentPass),comfirmPass:$.md5(o.comfirmPass)}),delete i.name,delete i.comfirmPass;var l=$api.post({url:$cfg.baseUrl+"/users/updatePass/"+e.id,data:$opt.paramFilter(i)});$.when(l).done(function(e){e.success?($toast.success(e.msg),t.modal("hide"),$api.get({url:$cfg.baseUrl+"/me/logout"}),$msg.warning("修改当前用户密码需要重新登录",{buttons:{success:{label:"确定",className:"btn-success",callback:function(){location.href="login.html"}}}})):$toast.warning(e.msg)}).fail(function(e){$toast.error(e)})}});r.validate(i),r.formDisable(!1),$("#p_name").attr("disabled","true")})};$cfg.webInfo={};var i,o=function(e){$cfg.webInfo=e;var i=n.compile(t)(e);$("#header").html(i),$(".slidebar").hasClass("on")?$(".header-right").css("position","fixed"):$(".header-right").css("position",""),s(),$("#modpwd").on("click",function(){r(e.user)}),$("#logout").on("click",function(){var e=$api.get({url:$cfg.baseUrl+"/me/logout"});$.when(e).done(function(e){location.href="login.html"}).fail(function(e){$toast.error(e)})})},l=function(){if(!0===$cfg.dev){o({title:"自动测报系统运维管理平台",menu:[{icon:"fa fa-desktop",title:"运维监控",url:"#!dashboard",sort:100},{icon:"fa fa-wrench",title:"运维管理",url:"#!operation",sort:200},{icon:"fa fa-user",title:"个人考勤",url:"#attendance",sort:300},{icon:"fa fa-users",title:"人员管理",url:"#!infomanage",sort:400},{icon:"fa fa-pencil-square-o",title:"工作考核",url:null,sort:500,children:[{icon:null,title:"管理业务工作考核",url:"#!servicerating",sort:401},{icon:null,title:"运维人员工作考核",url:"#!peoplerating",sort:402}]},{icon:"fa fa-server",title:"运维助理",url:null,sort:600,children:[{icon:null,title:"运维课堂",url:"#!classroom",sort:601},{icon:null,title:"站点查询",url:"#!search",sort:602},{icon:null,title:"运维知识库",url:"#!repository",sort:603}]},{icon:"fa fa-cube",title:"备件管理",url:null,sort:700,children:[{icon:null,title:"仓库管理",url:"#!storemanagement",sort:701},{icon:null,title:"物品管理",url:"#!itemmanagement",sort:702}]},{icon:"fa fa-key",title:"权限管理",url:null,sort:800,children:[{icon:null,title:"系统用户管理",url:"#!sysuser",sort:801},{icon:null,title:"角色权限管理",url:"#!sysrole",sort:802},{icon:null,title:"菜单模块管理",url:"#!sysmenu",sort:803}]},{icon:"fa fa-cog",title:"系统管理",url:null,sort:900,children:[{icon:null,title:"站点设备配置",url:"#!device",sort:901},{icon:null,title:"站点信息管理",url:"#!station",sort:902}]},{icon:"fa fa-globe",title:"支撑服务",url:null,sort:1e3,children:[{icon:null,title:"短信服务",url:"#!sms",sort:1001},{icon:null,title:"数据同步",url:"#!synchronous",sort:1002},{icon:null,title:"异常值监控",url:"#!outlier",sort:1003}]},{icon:"fa fa-bar-chart",title:"报表统计",url:"#!reportstatistics",sort:1100},{icon:"fa fa-search",title:"运维百度",url:"#!river",sort:1200}],user:{id:100,roleId:1,loginId:"admin",name:"测试用户",roleName:"管理员",role:{}}})}else{var e=$api.get({url:$cfg.baseUrl+"/me/curuser"});$.when(e).done(function(e){if(e.success){var n=e.data,t=$api.get({url:$cfg.baseUrl+"/role/getPermission",data:{roleId:n.roleId}});$.when(t,$dict.get("menu"),$dict.get("role")).done(function(e,t,r){if(e.success){var i=$.map(e.data,function(e){return e.menuId}),l=[],s=function(e){$.each(t,function(n,t){e.indexOf(t.menuId)>-1&&0!==t.parentId&&l.indexOf(t.parentId)<0&&(l.push(t.parentId),s([t.parentId]))})};s(i),i=i.concat(l);var a={};a[0]={children:[]},$.each(t,function(e,n){i.indexOf(n.menuId)>-1&&(a[n.menuId]={icon:n.menuIcon,title:n.menuText,url:n.menuHref,sort:n.sort,children:1===n.haveChild?[]:void 0})}),$.each(t,function(e,n){i.indexOf(n.menuId)>-1&&a[n.parentId].children&&(a[n.parentId].children.push(a[n.menuId]),a[n.parentId].children=a[n.parentId].children.sort(function(e,n){return e.sort-n.sort}))}),i=a[0].children,i=(i||[]).sort(function(e,n){return e.sort-n.sort});var u=$.map(r,function(e){if(e.id===n.roleId)return e});n.roleName=u&&u.length>0?u[0].name:"???",n.role=u&&u.length>0?u[0]:{};var c=n.imageUrl;c?$cfg.picUrl&&(c=$cfg.picUrl+c):c="assets/img/uikits/photo.png",n.photo=c,$.userData=n,o({title:"自动测报系统运维管理平台",menu:i,user:n})}else $toast.warning(e.msg)}).fail(function(e){$toast.error(e)})}else $toast.error("登录出错！"),location.href="login.html"}).fail(function(){$toast.error("登录出错!"),location.href="login.html"})}},s=function(){$("#nav li").removeClass("on"),$('#nav a[href="#!'+i+'"]').parents("li").addClass("on"),$("#nav").slide({type:"menu",titCell:".nLi",targetCell:".sub",effect:"slideDown",delayTime:300,triggerTime:0,returnDefault:!0})},a=function(){var e=$(window).height()-75-40;$("#container").css("minHeight",e+"px")};return{initFirst:function(n){console.log(n+":initFirst"),l(),e.initFirst(n),$(window).on("resize",a)},initContent:function(n){console.log(n+":initContent"),i=n,s(),e.initContent(n),a()},disposeContent:function(n){console.log(n+":disposeContent"),e.disposeContent(n)}}});