define(["handlebars","html!!taskLine","html!!planLine","datatables","imagesloaded","bootstrap-datetimepickerCN","jquery-uploadPreviewer"],function(t,e,a){var i,n,s=function(){$dict.init({name:"addvcd",url:$cfg.baseUrl+"/addvcd/loadAll/"}),$dict.init({name:"priority",url:$cfg.baseUrl+"/OptionSelect/com-ssxt-op-priority/"}),$dict.init({name:"maintainer",url:$cfg.baseUrl+"/users/loadAll/?isOperation=1"}),$dict.init({name:"statusCode",url:$cfg.baseUrl+"/OptionSelect/statusCode"}),$dict.init({name:"deviceType",url:$cfg.baseUrl+"/OptionSelect/deviceType/"}),$dict.init({name:"station",url:$cfg.baseUrl+"/stinfo/loadAll/"}),$dict.init({name:"serviceType",url:$cfg.baseUrl+"/OptionSelect/com-ssxt-op-serviceType/"})},d=function(){var t,e=[];t=$dict.initOptions({s2s:!0,elem:"#c_addvcd",dict:"addvcd",propText:"addvnm",propId:"addvcd",filter:function(t,e){var a=$.userData.addvcd;return"0000"===a.slice(-4)||"00"===a.slice(-2)&&t.addvcd.slice(0,-2)===a.slice(0,-2)||a===t.addvcd}}),e.push(t),t=$dict.initOptions({elem:"#c_taskStatus",dict:"statusCode",propText:"name",propId:"value",append:[{id:"-1",text:"全部"}]}),e.push(t),t=$dict.initOptions({elem:"#c_priorityStatus",dict:"priority",propText:"showValue",propId:"trueValue",append:[{id:"-1",text:"全部"}]}),e.push(t),t=$dict.initOptions({elem:"#c_serviceType",dict:"serviceType",propText:"showValue",propId:"trueValue",append:[{id:"-1",text:"全部"}]}),e.push(t),$.when.apply($,e).done(function(){r()}),$("#b_refresh,#b_search").on("click",function(){r()})},r=function(){i&&i.fnDestroy();var t=$.extend({},$plugin.datatable_server,{fnServerData:function(t,e,a){var i=$.extend({},$opt.paramConvert(e),$opt.paramFilter({taskStatus:$("#c_taskStatus").val(),priorityStatus:$("#c_priorityStatus").val(),addvcd:$("#c_addvcd").val(),serviceType:$("#c_serviceType").val()}));n=i.taskStatus;var s=$api.get({url:$cfg.baseUrl+"/task/related",data:i});$.when(s).done(function(t){t.success?a($opt.dataConvert(t)):$toast.warning(t.msg)}).fail(function(t){$toast.error(t)})},aaSorting:[[0,"desc"]],columns:[{title:"测站名称",data:"stionId",class:"text-center",fnCreatedCell:function(t,e,a,i,n){$dict.get("station").then(function(a){$.each(a,function(a,i){i.stionId===e&&$(t).html(i.stnm)})})}},{title:"业务类型",data:"stionId",class:"text-center",fnCreatedCell:function(t,e,a,i,n){$.when($dict.get("station"),$dict.get("serviceType")).then(function(a){$.each(a,function(a,i){if(i.stionId===e){var n=$dict.getItem("serviceType","trueValue",i.serviceType);$(t).html(n.showValue)}})})}},{title:"创建时间",data:"createTime",class:"text-center"},{title:"响应/修复",data:"taskStatus",class:"text-center",fnCreatedCell:function(t,e,a,i,n){var s="",d=moment(a.reciveTime).diff(moment(a.createTime),"hours"),r=moment(a.finishTime).diff(moment(a.dealTime),"hours");s+=e>10&&70!==e?'<div>响应<span class="text-red">'+d+"</span>小时</div>\n":"<div>未响应</div>\n",s+=e>30&&70!==e?'<div>修复<span class="text-red">'+r+"</span>小时</div>":"<div>未修复</div>",$(t).html(s)}},{title:"状态",data:"taskStatus",class:"text-center",fnCreatedCell:function(t,e,a,i,n){var s={0:"mt-5 badge bg-red",10:"mt-5 badge bg-dutch",20:"mt-5 badge bg-blue",30:"mt-5 badge bg-orange",40:"mt-5 badge bg-amethyst",50:"mt-5 badge bg-red",60:"mt-5 badge bg-green",70:"mt-5 badge bg-gray"};$dict.get("statusCode").then(function(a){$.each(a,function(a,i){i.value===e&&$(t).html('<div class="'+s[i.value]+'">'+i.name+"</div>")})})}},{title:"维修人员",data:"maintUserId",class:"text-center",fnCreatedCell:function(t,e,a,i,n){$(t).html(""),$dict.get("maintainer").then(function(a){$.each(a,function(a,i){i.id===e&&$(t).html(i.name)})})}},{title:"联系电话",data:"maintUserId",class:"text-center",fnCreatedCell:function(t,e,a,i,n){$dict.get("maintainer").then(function(a){var i="";$.each(a,function(t,a){a.id===e&&a.phone&&(i='<a><i class="fa fa-phone-square text-success ml-5"></i> '+a.phone+"</a>")}),$(t).html(i)})}},{title:"协助人员",data:"helpPersonnel",class:"text-center",fnCreatedCell:function(t,e,a,i,n){$(t).html(""),$dict.get("maintainer").then(function(a){var i=[],n=(e||"").split(",");$.each(a,function(t,e){n.indexOf(e.id.toString())>-1&&i.push(e.name)}),$(t).html(i.join(","))})}},{title:"操作",data:"taskStatus",bSortable:!1,fnCreatedCell:function(t,e,a,i,n){$.userData.role,$.userData;$(t).html("");var s=$('<a class="btn btn-info btn-xs ml-5"><i class="fa fa-file-o"></i>详情</a>');s.on("click",function(){o(t,e,a,i,n)}),$(t).append(s)}}]});i=$("#t_deal").dataTable(t)},c=function(t){var e,a=[];e=$dict.initOptions({s2s:!0,elem:"#p_addvcd",dict:"addvcd",propText:"addvnm",propId:"addvcd",filter:function(t,e){var a=$.userData.addvcd;return"0000"===a.slice(-4)||"00"===a.slice(-2)&&t.addvcd.slice(0,-2)===a.slice(0,-2)||a===t.addvcd}}),a.push(e),e=$dict.initOptions({elem:"#p_maintUserId",dict:"maintainer",propText:"name",propId:"id"}),a.push(e),e=$dict.initOptions({elem:"#p_helpPersonnel",dict:"maintainer",propText:"name",propId:"id"}),a.push(e),e=$dict.initOptions({elem:"#p_deviceTypeId",dict:"deviceType",propText:"name",propId:"id"}),a.push(e),e=$dict.initOptions({elem:"#p_priorityStatus",dict:"priority",propText:"showValue",propId:"trueValue"}),a.push(e),e=$dict.initOptions({elem:"#p_taskStatus",dict:"statusCode",propText:"name",propId:"value"}),a.push(e),e=$dict.initOptions({elem:"#p_serviceType",dict:"serviceType",propText:"showValue",propId:"trueValue"}),a.push(e),$.when.apply($,a).done(function(){$.isFunction(t)&&t()}),$("#p_file").uploadPreviewer({buttonText:'<i class="fa fa-plus-circle"></i>选择图片'})},l={},o=function(a,i,n,s,d){var r=$msg.dialog("taskInfo",function(t,e){return!1},{title:"维修单详情",modalClassName:"modal-lg",buttons:{success:{label:"确定",className:"btn-info"}}}),o=$api.get({loading:!1,url:$cfg.baseUrl+"/task/load/"+n.taskNo});$.when(r,o,$dict.get("station")).then(function(a,i){var s=a.find("form.info-left"),d=a.find("form.info-right"),r=-1,o=function(){var i=$api.get({url:$cfg.baseUrl+"/taskProcess/loadAll/"+n.taskNo});$.when(i).done(function(i){if(i.success){i&&i.data&&i.data.length>0&&(r=i.data[i.data.length-1].id);var n=d.find(".task-timeline");$cfg.picUrl&&$.each(i.data,function(t,e){$.each(e.basTaskDealNodes,function(t,e){e.url=$cfg.picUrl+e.url})});var c=t.compile(e)(i);n.html(c),n.imagesLoaded(function(){s.height(Math.max(s.height(),d.height())),a.resize()})}else $toast.warning(i.msg),a.modal("hide")}).fail(function(t){$toast.error(t)})};c(function(){var t=$dict.getItem("station","stionId",i.data.stionId);s.formData($.extend({},l,i.data,{serviceType:t.serviceType,stcd:t.stcd,helpPersonnel:(i.data.helpPersonnel||"").split(","),stnm:t.stnm})),$.updateTextFields(),s.formDisable(!1),$("#p_taskNo").attr("disabled","true"),$("#p_taskStatus").attr("disabled","true"),$("#p_stcd").attr("disabled","true"),$("#p_stnm").attr("disabled","true"),$("#p_serviceType").attr("disabled","true"),$("#p_addvcd").attr("disabled","true"),$("#p_content").attr("disabled","true"),$("#p_priorityStatus").attr("disabled","true"),$("#p_createTime").attr("disabled","true"),$("#p_maintUserId").attr("disabled","true"),$("#p_helpPersonnel").attr("disabled","true");var e={ignore:".ignore",errorPlacement:function(t,e){t.appendTo(e.parents(".form-group"))},rules:{content:{required:!0}},messages:{content:{required:"内容不能为空"}}},a=$.extend({},e,{submitHandler:function(t){var e={},a=d.formData();$.extend(e,a,{taskNo:n.taskNo,dealType:1,procId:r});var i=$api.post({url:$cfg.baseUrl+"/taskDealNode/addJournal",data:$opt.paramFilter(e)});$.when(i).done(function(t){t.success?($toast.success(t.msg),d.get(0).reset(),o()):$toast.warning(t.msg)}).fail(function(t){$toast.error(t)})}});d.validate(a),o()})})},p=function(){var e=$api.get({loading:!1,url:$cfg.baseUrl+"/message/select",data:{page:"false",orderdir:"desc",order:"createTime"}});$.when(e).done(function(e){if(e.success){var a=$("#p_info").get(0).innerHTML.replace(/\[\[/g,"{{").replace(/]]/g,"}}"),i=t.compile(a)({data:e.data});$(".txtMarquee").html(i).slide({mainCell:"ul",autoPlay:!0,effect:"leftMarquee",vis:2,interTime:50})}else $toast.warning(e.msg)}).fail(function(t){$toast.error(t)})},u=0,f=function(){p(),u=setInterval(p,3e5),$(".txtMarquee").on("click","li",function(){var t=$(this).attr("data-taskNo"),e=$(this).attr("data-type");"1"!==e&&"2"!==e||!t||o(null,null,{taskNo:t},null,null)})};return{data:{model:[{icon:"fa fa-wrench",title:"协助管理"},{icon:"",title:"运维处理"}]},init:function(t){console.log(t+":init"),s(),d(),f()},dispose:function(t){console.log(t+":dispose"),clearInterval(u)}}});