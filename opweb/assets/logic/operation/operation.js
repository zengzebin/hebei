define(["handlebars","html!!taskLine","html!!planLine","datatables","imagesloaded","bootstrap-datetimepickerCN","jquery-uploadPreviewer"],function(t,e,a){var n,i,s,r={ignore:".ignore",errorPlacement:function(t,e){t.appendTo(e.parents(".form-group"))},rules:{content:{required:!0}},messages:{content:{required:"内容不能为空"}}},d=function(){$dict.init({name:"addvcd",url:$cfg.baseUrl+"/addvcd/loadAll/"}),$dict.init({name:"priority",url:$cfg.baseUrl+"/OptionSelect/com-ssxt-op-priority/"}),$dict.init({name:"maintainer",url:$cfg.baseUrl+"/users/loadAll/?isOperation=1"}),$dict.init({name:"statusCode",url:$cfg.baseUrl+"/OptionSelect/statusCode"}),$dict.init({name:"deviceType",url:$cfg.baseUrl+"/OptionSelect/deviceType/"}),$dict.init({name:"station",url:$cfg.baseUrl+"/stinfo/loadAll/"}),$dict.init({name:"serviceType",url:$cfg.baseUrl+"/OptionSelect/com-ssxt-op-serviceType/"})},o=function(){var t,e=[];t=$dict.initOptions({s2s:!0,elem:"#c_addvcd",dict:"addvcd",propText:"addvnm",propId:"addvcd",filter:function(t,e){var a=$.userData.addvcd;return"0000"===a.slice(-4)||"00"===a.slice(-2)&&t.addvcd.slice(0,-2)===a.slice(0,-2)||a===t.addvcd}}),e.push(t),t=$dict.initOptions({elem:"#c_taskStatus",dict:"statusCode",propText:"name",propId:"value",append:[{id:"-1",text:"全部"}]}),e.push(t),t=$dict.initOptions({elem:"#c_priorityStatus",dict:"priority",propText:"showValue",propId:"trueValue",append:[{id:"-1",text:"全部"}]}),e.push(t),t=$dict.initOptions({elem:"#c_serviceType",dict:"serviceType",propText:"showValue",propId:"trueValue",append:[{id:"-1",text:"全部"}]}),e.push(t),$.when.apply($,e).done(function(){h(),v()}),$("#b_refresh,#b_search").on("click",function(){h(),v()})},c=function(t){var e=$opt.paramFilter({priorityStatus:$("#c_priorityStatus").val(),addvcd:$("#c_addvcd").val(),serviceType:$("#c_serviceType").val()}),a=$api.get({loading:!1,url:$cfg.baseUrl+"/task/statisticsState",data:e});$.when(a).done(function(e){if(t.trigger("loading.hide"),e.success){var a="",n={0:{imgurl:"assets/img/uikits/index/dzp.png",numclass:"text-info",spantext:"待指派站点",num:0},10:{imgurl:"assets/img/uikits/index/djs.png",numclass:"text-orange",spantext:"待接收站点",num:0},20:{imgurl:"assets/img/uikits/index/dwx.png",numclass:"text-red",spantext:"待维修站点",num:0},30:{imgurl:"assets/img/uikits/index/wxz.png",numclass:"text-blue",spantext:"维修中站点",num:0},60:{imgurl:"assets/img/uikits/index/ywx.png",numclass:"text-green",spantext:"维修完成站点",num:0}};$.each(e.data,function(t,e){n[e.taskStatus]&&(n[e.taskStatus].num=e.num)}),$.map(n,function(t,e){a+=' <div class="row mb-10"><div class="col-xs-6 text-right pt-5"><a class="go-search cursor-pointer" data-status="'+e+'"><b class="text-dark">'+t.spantext+'</b></a></div><div class="col-xs-2"><img src="'+t.imgurl+'"></div><div class="col-xs-4 pt-5"><b class="'+t.numclass+'">'+t.num+"</b></div></div>"}),t.find(".station-stateinfo").html(a),t.find(".station-stateinfo").on("click",".go-search",function(){var t=$(this).data("status");$("#c_taskStatus").val(t).change(),$("#c_priorityStatus").val("-1").change(),$("#b_search").trigger("click")})}else $toast.warning(e.msg)}).fail(function(e){t.trigger("loading.hide"),$toast.error(e)})},l=function(t){i&&i.fnDestroy();var e=$.extend({},$plugin.datatable_server,{fnServerData:function(e,a,n){var i=$.extend({},$opt.paramConvert(a)),s=$api.get({loading:!1,url:$cfg.baseUrl+"/taskPaln/select",data:i});$.when(s).done(function(e){t.trigger("loading.hide"),e.success?n($opt.dataConvert(e)):$toast.warning(e.msg)}).fail(function(e){t.trigger("loading.hide"),$toast.error(e)})},aaSorting:[[0,"desc"]],iDisplayLength:5,autoWidth:!1,info:"",columns:[{title:"巡检区域",data:"endTime",class:"text-center",fnCreatedCell:function(t,e,a,n,i){$dict.get("addvcd").then(function(e){$.each(e,function(e,n){if(n.addvcd===a.addvcd){var i=n.addvnm+"<br/>("+moment(a.startTime).format("YYYY-MM-DD")+"~"+moment(a.endTime).format("YYYY-MM-DD")+")";$(t).html(i)}})})}},{title:"操作",data:"status",bSortable:!1,fnCreatedCell:function(t,e,a,n,i){var s;s=a.maintUserId===$.userData.id?$('<a class="btn btn-info btn-xs ml-5"><i class="fa fa-file-o"></i>详情</a>'):$('<a class="btn btn-info btn-xs ml-5 btn-orange"><i class="fa fa-file-o"></i>详情</a>'),s.on("click",function(){u(t,e,a,n,i)}),$(t).html("").append(s)}}]});i=t.find(".table").dataTable(e),this.attach||(t.on("click",".box-add",g),this.attach=!0)},u=function(e,n,i,s,r){var d=$msg.dialog("planInfo",function(t,e){return!1},{title:"巡检计划详情",modalClassName:"modal-lg",buttons:{success:{label:"确定",className:"btn-info"}}});$.when(d,$dict.get("station")).then(function(e){var n=e.find("form.info-left"),s=e.find("form.info-right"),r=s.find(".task-planline"),d=0,o=!1,c=function(){var e=$api.get({loading:!1,url:$cfg.baseUrl+"/taskPaln/load/"+i.id});$.when(e).done(function(e){if(e.success){n.formData($.extend({},m,e.data)),$.updateTextFields(),n.formDisable(!0);var i=$.extend({},e.data,{isOpt:$.userData.id===e.data.maintUserId}),s=t.compile(a)(i);r.html(s),r.height(n.height()-30),r.niceScroll({styler:"fb",cursorcolor:"#509fed",cursorwidth:"6",cursorborderradius:"15px",background:"#404040",cursorborder:"",zindex:"9990"}),i.isOpt&&10===e.data.status||r.find("input").attr("disabled","true"),d=i.status,o=i.isOpt}else $toast.warning(e.msg)}).fail(function(t){$toast.error(t)})};p(function(){c(),r.on("click",".badge[data-state]",function(){if(10!==d||!o)return!1;$(this).parents("li").find(".badge").removeClass("on"),$(this).addClass("on")}),r.on("click",".tools .btn",function(){var t=$(this).parents(".panel"),e=new FormData;t.find("li").map(function(t,a){var n=$(a).data("id"),i=$(a).find(".badge.on").data("state"),s=$(a).find(".error-msg input").val();e.append("devices["+t+"].id",n),e.append("devices["+t+"].state",i),e.append("devices["+t+"].content",s)});var a=$api.post({contentType:!1,processData:!1,url:$cfg.baseUrl+"/taskPaln/updateDevice",data:e});$.when(a).done(function(t){t.success?($toast.success(t.msg),c()):$toast.warning(t.msg)}).fail(function(t){$toast.error(t)})}),r.on("click",".btn-start",function(){$msg.confirm("是否开始运维计划"+i.id+"?",function(){var t=$api.put({url:$cfg.baseUrl+"/taskPaln/update",data:{id:i.id,status:10}});$.when(t).done(function(t){t.success?($toast.success(t.msg),c()):$toast.warning(t.msg)}).fail(function(t){$toast.error(t)})})}),r.on("click",".btn-end",function(){$msg.confirm("是否结束运维计划"+i.id+"?",function(){var t=$api.put({url:$cfg.baseUrl+"/taskPaln/update",data:{id:i.id,status:20,reflect:e.find("#p_content2").val()}});$.when(t).done(function(t){t.success?($toast.success(t.msg),c()):$toast.warning(t.msg)}).fail(function(t){$toast.error(t)})})})})})},p=function(t){var e,a=[];e=$dict.initOptions({elem:"#p_stcds",dict:"station",propText:function(t){return t.stcd+" "+t.stnm},propId:"stcd"}),a.push(e),e=$dict.initOptions({elem:"#p_serviceType",dict:"serviceType",propText:"showValue",propId:"trueValue",append:[{id:"-1",text:"全部"}]}),a.push(e),e=$dict.initOptions({elem:"#p_maintUserId",dict:"maintainer",propText:"name",propId:"id"}),a.push(e),e=$dict.initOptions({s2s:!0,elem:"#p_addvcd",dict:"addvcd",propText:"addvnm",propId:"addvcd",filter:function(t,e){var a=$.userData.addvcd;return"0000"===a.slice(-4)||"00"===a.slice(-2)&&t.addvcd.slice(0,-2)===a.slice(0,-2)}}),a.push(e),$("#p_startTime").datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:!0,todayBtn:!0,pickerPosition:"bottom-left"}),$("#p_endTime").datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:!0,todayBtn:!0,pickerPosition:"bottom-left"});var n=function(){var t=$("#p_addvcd").val()||"",e=$("#p_serviceType").val()||"";$("#p_stcds").val(""),$dict.initOptions({elem:"#p_stcds",dict:"station",propText:function(t){return t.stcd+" "+t.stnm},propId:"stcd",filter:function(a,n){var i="0000"===t.slice(-4)||"00"===t.slice(-2)&&a.addvcd.slice(0,-2)===t.slice(0,-2)||t===a.addvcd;return i=i&&("-1"===e||a.serviceType===e)}})};$("#p_addvcd").on("change",function(){n()}),$("#p_serviceType").on("change",function(){n()}),$.when.apply($,a).done(function(){$.isFunction(t)&&t()})},f={ignore:".ignore",errorPlacement:function(t,e){t.appendTo(e.parents(".form-group"))},rules:{addvcd:{required:!0},stcds:{required:!0},content:{required:!0},startTime:{required:!0},endTime:{required:!0},maintUserId:{required:!0}},messages:{addvcd:{required:"请选择区域"},stcds:{required:"请选择巡检测站"},content:{required:"计划内容不能为空"},startTime:{required:"计划开始时间不能为空"},endTime:{required:"计划结束时间不能为空"},maintUserId:{required:"指派维修人员不能为空"}}},m={},g=function(){var t=$msg.dialog("planAdd",function(t,e){return $(e).find("form").submit(),!1},{title:"新增巡检计划"});$.when(t).then(function(t){var e=t.find("form");p(function(){e.formData(m),$.updateTextFields();var a=$.extend({},f,{submitHandler:function(a){var n={status:0},s=e.formData();$.extend(n,s);var r=$api.post({url:$cfg.baseUrl+"/taskPaln/add",data:$opt.paramFilter(n)});$.when(r).done(function(e){e.success?($toast.success(e.msg),t.modal("hide"),i.fnUpdate()):$toast.warning(e.msg)}).fail(function(t){$toast.error(t)})}});e.validate(a),e.formDisable(!1)})})},v=function(){var e=[{elem:$("#p_panel_1").get(0),data:{title:"工单统计"},initFunc:c},{elem:$("#p_panel_3").get(0),data:{title:"巡检管理"},initFunc:l}],a=$(".panel-list");a.html(""),$.map(e,function(e){var n=e.html||e.elem.innerHTML.replace(/\[\[/g,"{{").replace(/]]/g,"}}"),i=t.compile(n)(e.data||{}),s=$(i);s.on("refresh",function(){$.isFunction(e.initFunc)&&(s.trigger("loading.show"),e.initFunc.apply(e,[s]))}),a.append(s),$.isFunction(e.initFunc)&&(e.attach=!1,e.initFunc.apply(e,[s]))})},h=function(){n&&n.fnDestroy();var t=$.extend({},$plugin.datatable_server,{fnServerData:function(t,e,a){var n=$.extend({},$opt.paramConvert(e),$opt.paramFilter({taskStatus:$("#c_taskStatus").val(),priorityStatus:$("#c_priorityStatus").val(),addvcd:$("#c_addvcd").val(),serviceType:$("#c_serviceType").val()}));s=n.taskStatus;var i=$api.get({url:$cfg.baseUrl+"/task/dealTask",data:n});$.when(i).done(function(t){t.success?a($opt.dataConvert(t)):$toast.warning(t.msg)}).fail(function(t){$toast.error(t)})},aaSorting:[[0,"desc"]],columns:[{title:"测站名称",data:"stionId",class:"text-center",fnCreatedCell:function(t,e,a,n,i){$dict.get("station").then(function(a){$.each(a,function(a,n){n.stionId===e&&$(t).html(n.stnm)})})}},{title:"业务类型",data:"stionId",class:"text-center",fnCreatedCell:function(t,e,a,n,i){$.when($dict.get("station"),$dict.get("serviceType")).then(function(a){$.each(a,function(a,n){if(n.stionId===e){var i=$dict.getItem("serviceType","trueValue",n.serviceType);$(t).html(i.showValue)}})})}},{title:"创建时间",data:"createTime",class:"text-center"},{title:"响应/修复",data:"taskStatus",class:"text-center",fnCreatedCell:function(t,e,a,n,i){var s="",r=moment(a.reciveTime).diff(moment(a.createTime),"hours"),d=moment(a.finishTime).diff(moment(a.dealTime),"hours");s+=e>10&&70!==e?'<div>响应<span class="text-red">'+r+"</span>小时</div>\n":"<div>未响应</div>\n",s+=e>30&&70!==e?'<div>修复<span class="text-red">'+d+"</span>小时</div>":"<div>未修复</div>",$(t).html(s)}},{title:"优先级",data:"priorityStatus",class:"text-center",fnCreatedCell:function(t,e,a,n,i){var s={1:"mt-5 br-0 badge bg-dutch",2:"mt-5 br-0 badge bg-orange",3:"mt-5 br-0 badge bg-red"};$dict.get("priority").then(function(a){$.each(a,function(a,n){n.trueValue===(e||"").toString()&&$(t).html('<div class="'+s[n.trueValue]+'">'+n.showValue+"</div>")})})}},{title:"状态",data:"taskStatus",class:"text-center",fnCreatedCell:function(t,e,a,n,i){var s={0:"mt-5 badge bg-red",10:"mt-5 badge bg-dutch",20:"mt-5 badge bg-blue",30:"mt-5 badge bg-orange",40:"mt-5 badge bg-amethyst",50:"mt-5 badge bg-red",60:"mt-5 badge bg-green",70:"mt-5 badge bg-gray"};$dict.get("statusCode").then(function(a){$.each(a,function(a,n){n.value===e&&$(t).html('<div class="'+s[n.value]+'">'+n.name+"</div>")})})}},{title:"维修人员",data:"maintUserId",class:"text-center",fnCreatedCell:function(t,e,a,n,i){$(t).html(""),$dict.get("maintainer").then(function(a){$.each(a,function(a,n){n.id===e&&$(t).html(n.name)})})}},{title:"联系电话",data:"maintUserId",class:"text-center",fnCreatedCell:function(t,e,a,n,i){$dict.get("maintainer").then(function(a){var n="";$.each(a,function(t,a){a.id===e&&a.phone&&(n='<a><i class="fa fa-phone-square text-success ml-5"></i> '+a.phone+"</a>")}),$(t).html(n)})}},{title:"协助人员",data:"helpPersonnel",class:"text-center",fnCreatedCell:function(t,e,a,n,i){$(t).html(""),$dict.get("maintainer").then(function(a){var n=[],i=(e||"").split(",");$.each(a,function(t,e){i.indexOf(e.id.toString())>-1&&n.push(e.name)}),$(t).html(n.join(","))})}},{title:"操作",data:"taskStatus",bSortable:!1,fnCreatedCell:function(t,e,a,n,i){var s=$.userData.role,r=$.userData;if($(t).html(""),"maintainer"!==s.distinguish){if(0===e){var d=$('<a class="btn btn-success btn-xs ml-5"><i class="fa fa-edit"></i>派单</a>');d.on("click",function(){T(t,e,a,n,i)}),$(t).append(d)}else if(10===e){var d=$('<a class="btn btn-success btn-xs ml-5"><i class="fa fa-edit"></i>重新派单</a>');d.on("click",function(){T(t,e,a,n,i)}),$(t).append(d)}if(e<30){var o=$('<a class="btn btn-danger btn-xs ml-5"><i class="fa fa-edit"></i>撤回</a>');o.on("click",function(){I(t,e,a,n,i)}),$(t).append(o)}}if(s.isOperation&&r.id===a.maintUserId)if(10===e){var c=$('<a class="btn btn-success btn-xs ml-5"><i class="fa fa-edit"></i>接单</a>');c.on("click",function(){_(t,e,a,n,i)}),$(t).append(c)}else if(20===e||50===e){var l=$('<a class="btn btn-success btn-xs ml-5"><i class="fa fa-edit"></i>开始维修</a>');l.on("click",function(){y(t,e,a,n,i)}),$(t).append(l)}else if(30===e){var d=$('<a class="btn btn-info btn-xs ml-5"><i class="fa fa-edit"></i>维修操作</a>'),u=$('<a class="btn btn-warning btn-xs ml-5"><i class="fa fa-edit"></i>结束维修</a>');d.on("click",function(){N(t,e,a,n,i)}),u.on("click",function(){w(t,e,a,n,i)}),$(t).append(d).append(u)}var p=$('<a class="btn btn-info btn-xs ml-5"><i class="fa fa-file-o"></i>详情</a>');p.on("click",function(){D(t,e,a,n,i)}),$(t).append(p)}}]});n=$("#t_deal").dataTable(t)},b=function(t){var e,a=[];e=$dict.initOptions({s2s:!0,elem:"#p_addvcd",dict:"addvcd",propText:"addvnm",propId:"addvcd",filter:function(t,e){var a=$.userData.addvcd;return"0000"===a.slice(-4)||"00"===a.slice(-2)&&t.addvcd.slice(0,-2)===a.slice(0,-2)||a===t.addvcd}}),a.push(e),e=$dict.initOptions({elem:"#p_maintUserId",dict:"maintainer",propText:"name",propId:"id"}),a.push(e),e=$dict.initOptions({elem:"#p_helpPersonnel",dict:"maintainer",propText:"name",propId:"id"}),a.push(e),e=$dict.initOptions({elem:"#p_deviceTypeId",dict:"deviceType",propText:"name",propId:"id"}),a.push(e),e=$dict.initOptions({elem:"#p_priorityStatus",dict:"priority",propText:"showValue",propId:"trueValue"}),a.push(e),e=$dict.initOptions({elem:"#p_taskStatus",dict:"statusCode",propText:"name",propId:"value"}),a.push(e),e=$dict.initOptions({elem:"#p_serviceType",dict:"serviceType",propText:"showValue",propId:"trueValue",append:[{id:"-1",text:"全部"}]}),a.push(e),$.when.apply($,a).done(function(){$.isFunction(t)&&t()}),$("#p_file").uploadPreviewer({buttonText:'<i class="fa fa-plus-circle"></i>选择图片'})},x={},k=function(t){var e=$api.get({url:$cfg.baseUrl+"/maintGps/distance/",data:{stionId:t.stionId}});$.when(e).done(function(e){if(e.success){var a=$.map(e.data,function(e){if(e.id===t.repairId)return $.extend({type:"自动指派",state:e.state,taskNo:e.taskNo},$dict.getItem("maintainer","id",e.id))}),n=[],i=[];$.each(e.data,function(t,e){1===e.exist&&e.distance<10?n.push($.extend({type:"距故障站<10km",state:e.state,taskNo:e.taskNo},$dict.getItem("maintainer","id",e.id))):i.push($.extend({type:"其他",state:e.state,taskNo:e.taskNo},$dict.getItem("maintainer","id",e.id)))}),$dict.add("gps_maint",a.concat(n).concat(i)),$dict.initOptions({s2s:"user",elem:"#p_maintUserId",dict:"gps_maint",propText:"name",propId:"id",templateResult:function(t){if(t.data){var e=3;0===t.data.state&&(e=t.data.taskNo?2:1);var a='<span class="select2-results-item"><img src="assets/img/map/p'+e+'.png"><b>'+t.text+"</b></span>";return $(a).get(0)}return t.text},propData:function(t){return t}}),$("#p_maintUserId").val(t.maintUserId).change()}else $toast.warning(e.msg)}).fail(function(t){$toast.error(t)})},T=function(t,e,a,i,s){var r={ignore:".ignore",errorPlacement:function(t,e){t.appendTo(e.parents(".form-group"))},rules:{maintUserId:{required:!0},priorityStatus:{required:!0}},messages:{maintUserId:{required:"请选择维修人员"},priorityStatus:{required:"请选择优先级"}}},d=$msg.dialog("dispatchAdd",function(t,e){return $(e).find("form").submit(),!1},{title:"运维派单"});$.when(d,$dict.get("station")).then(function(t){var e=t.find("form");b(function(){var i=$dict.getItem("station","stionId",a.stionId);e.formData($.extend({},x,a,{serviceType:i.serviceType,stcd:i.stcd,helpPersonnel:(a.helpPersonnel||"").split(","),stnm:i.stnm})),$.updateTextFields();var s=$.extend({},r,{submitHandler:function(i){var s={},r=e.formData();$.extend(s,r,{taskStatus:10});var d=$api.put({url:$cfg.baseUrl+"/task/update/"+a.taskNo,data:$opt.paramFilter(s)});$.when(d).done(function(e){e.success?($toast.success(e.msg),t.modal("hide"),n.fnUpdate()):$toast.warning(e.msg)}).fail(function(t){$toast.error(t)})}});e.validate(s),e.formDisable(!1),$("#p_taskNo").attr("disabled","true"),$("#p_stcd").attr("disabled","true"),$("#p_stnm").attr("disabled","true"),$("#p_serviceType").attr("disabled","true"),$("#p_addvcd").attr("disabled","true"),$("#p_content").attr("disabled","true"),k(a)})})},_=function(t,e,a,i,s){$msg.confirm("是否接收维修单"+a.taskNo+"?",function(){var t=$api.post({url:$cfg.baseUrl+"/taskProcess/taskOperate",data:{taskNo:a.taskNo,operate:"Maintenance"}});$.when(t).done(function(t){t.success?($toast.success(t.msg),n.fnUpdate()):$toast.warning(t.msg)}).fail(function(t){$toast.error(t)})})},y=function(t,e,a,i,s){$msg.confirm("是否开始维修单"+a.taskNo+"?",function(){var r=$api.post({url:$cfg.baseUrl+"/taskProcess/taskOperate",data:{taskNo:a.taskNo,operate:"execute"}});$.when(r).done(function(r){r.success?($toast.success(r.msg),n.fnUpdate(),N(t,e,a,i,s)):$toast.warning(r.msg)}).fail(function(t){$toast.error(t)})})},w=function(t,e,a,i,s){$msg.confirm("是否结束维修单"+a.taskNo+"?",function(){var t=$api.post({url:$cfg.baseUrl+"/taskProcess/taskOperate",data:{taskNo:a.taskNo,operate:"end"}});$.when(t).done(function(t){t.success?($toast.success(t.msg),n.fnUpdate()):$toast.warning(t.msg)}).fail(function(t){$toast.error(t)})})},I=function(t,e,a,i,s){$msg.confirm("是否撤回维修单"+a.taskNo+"?",function(){var t=$api.post({url:$cfg.baseUrl+"/taskProcess/taskOperate",data:{taskNo:a.taskNo,operate:"cancle"}});$.when(t).done(function(t){t.success?($toast.success(t.msg),n.fnUpdate()):$toast.warning(t.msg)}).fail(function(t){$toast.error(t)})})},U={ignore:".ignore",errorPlacement:function(t,e){t.appendTo(e.parents(".form-group"))},rules:{},messages:{}},N=function(a,i,s,d,o){var c=$msg.dialog("dealAdd",function(t,e){return w(a,i,s,d,o),!1},{title:"新增维修单记录",modalClassName:"modal-lg"}),l=$api.get({loading:!1,url:$cfg.baseUrl+"/WareHouse/repairSurplus",data:{userId:s.maintUserId}});$.when(c,l).then(function(a,i){if(i.success){var d=a.find("form.info-left"),o=a.find("div.info-right"),c=a.find("form.info-right1"),l=a.find("form.info-right2"),u=-1,p=0,f=function(){var n=$api.get({url:$cfg.baseUrl+"/taskProcess/loadAll/"+s.taskNo});$.when(n).done(function(n){if(n.success){n&&n.data&&n.data.length>0&&(u=n.data[n.data.length-1].id);var i=o.find(".task-timeline");$cfg.picUrl&&$.each(n.data,function(t,e){$.each(e.basTaskDealNodes,function(t,e){e.url=$cfg.picUrl+e.url})});var s=t.compile(e)(n);i.html(s),i.imagesLoaded(function(){d.height(Math.max(p,o.height())),a.resize()})}else $toast.warning(n.msg),a.modal("hide")}).fail(function(t){$toast.error(t)})};b(function(){d.formData($.extend({},x,s,{helpPersonnel:(s.helpPersonnel||"").split(",")})),c.formData({operate:""}),$.updateTextFields(),p=d.height(),a.find("#p_file").on("file-preview:changed",function(){a.resize(),d.height(Math.max(p,o.height()))}),d.formDisable(!1),$("#p_taskNo").attr("disabled","true"),$("#p_taskStatus").attr("disabled","true"),$("#p_stcd").attr("disabled","true"),$("#p_stnm").attr("disabled","true"),$("#p_addvcd").attr("disabled","true"),$("#p_content").attr("disabled","true"),$("#p_priorityStatus").attr("disabled","true"),$("#p_createTime").attr("disabled","true"),$("#p_maintUserId").attr("disabled","true"),$("#p_helpPersonnel").attr("disabled","true");var t=$.extend({},r,{submitHandler:function(t){var e=[],a={},i=c.formData();$.extend(a,i,{taskNo:s.taskNo,dealType:1,procId:u});var r=$api.post({url:$cfg.baseUrl+"/taskDealNode/addJournal",data:$opt.paramFilter(a)});e.push(r);var d=c.find("#p_file").data("file-preview"),o=d.fileList();Object.keys(o).length>0&&(a=new FormData,$.each(o,function(t,e){a.append("file["+t+"]",e)}),a.append("taskNo",s.taskNo),a.append("dealType",2),a.append("procId",u),r=$api.post({contentType:!1,processData:!1,url:$cfg.baseUrl+"/taskDealNode/addMedia",data:a}),e.push(r)),$.when.apply($,e).done(function(t){t.success?($toast.success(t.msg),d.clearFileList(),c.get(0).reset(),f(),n.fnUpdate()):$toast.warning(t.msg)}).fail(function(t){$toast.error(t)})}});c.validate(t),a.find('a[data-toggle="tab"]').on("shown.bs.tab",function(t){a.resize(),d.height(Math.max(p,o.height()))}),f(),setTimeout(function(){a.find('a[href="#record"]').trigger("click")},100);var e,m=i.data||[],g=function(){var t=(l.find("#p_deviceTypeId").val()||"").toString(),e=(l.find("#p_state").val()||"").toString(),a=(l.find("#p_model").val()||"").toString(),n=0;$.each(m,function(i,s){t===s.deviceTypeId.toString()&&e===s.state.toString()&&a===s.model.toString()&&(n=s.num)}),l.find("#p_count").html(n)};l.find("#p_deviceTypeId").on("change",function(){g()}),l.find("#p_state").on("change",function(){g()}),l.find("#p_model").on("change",function(){g()}),function(){var t={},a=$.map(m,function(e){if(1!==t[e.model])return t[e.model]=1,'<option value="'+e.model+'">'+e.model+"</option>"});l.find("#p_model").css("width","100%").removeClass("select2-hidden-accessible"),e&&clearTimeout(e),e=setTimeout(function(){l.find("#p_model").html(a).select2(),g()},500)}(),l.find("#btn_add").on("click",function(){var t=l.find("#p_list"),e=t.data("device")||{},n=l.find("#p_deviceTypeId").val(),i=l.find("#p_deviceTypeId option:selected").text(),r=l.find("#p_state").val(),c=l.find("#p_state option:selected").text(),u=l.find("#p_model").val(),f=l.find("#p_num").val(),m=l.find("#p_count").text();l.find("#p_wareHouseId").val();if(!(f>0&&isNum(f)))return $toast.warning("数量必须大于0"),"";if(parseInt(f,10)>parseInt(m,10))return $toast.warning("数量不能大于大于当前数量"),"";e[n+"-"+u+"-"+r]={taskNo:s.taskNo,stionId:s.stionId,id:n,name:i,state:r,stateText:c,model:u,num:f};var g="<ul>";$.each(e,function(t,e){g+="<li>"+e.name+"【"+e.model+"】【"+e.stateText+"】 x "+e.num+'<a class="btn btn-danger btn-xs ml-5" data-id="'+e.id+'">删除</a></li>'}),g+="</ul>",t.html(g),t.data("device",e),a.resize(),d.height(Math.max(p,o.height()))}),l.find("#p_list").on("click",".btn",function(){var t=$(this).data("id"),e=l.find("#p_list"),a=e.data("device")||{};delete a[t],$(this).parents("li").remove(),e.data("device",a),d.height(Math.max(p,o.height()))});var t=$.extend({},U,{submitHandler:function(t){var e=l.find("#p_list"),a=e.data("device")||{};if(0===Object.keys(a).length)return void $toast.warning("申请设备不能为空");var i=(l.formData(),new FormData),r=0;$.each(a,function(t,e){i.append("deviceUse["+r+"].taskNo",e.taskNo),i.append("deviceUse["+r+"].stionId",e.stionId),i.append("deviceUse["+r+"].deviceTypeId",e.id),i.append("deviceUse["+r+"].model",e.model),i.append("deviceUse["+r+"].state",e.state),i.append("deviceUse["+r+"].num",e.num),r++});var d=$api.post({contentType:!1,processData:!1,url:$cfg.baseUrl+"/warehouseDevice/repairUse",data:i});$.when(d).done(function(t){if(t.success){var i=$.map(a,function(t){return t.name+"【"+t.model+"】【"+t.stateText+"】 x "+t.num}).join(";"),r=$api.post({url:$cfg.baseUrl+"/taskDealNode/addJournal",data:{taskNo:s.taskNo,dealType:1,procId:u,content:"使用备件："+i}});$.when(r).done(function(t){t.success?($toast.success(t.msg),e.html(""),e.data("device",{}),l.get(0).reset(),f(),n.fnUpdate()):$toast.warning(t.msg)}).fail(function(t){$toast.error(t)})}else $toast.warning(t.msg)}).fail(function(t){$toast.error(t)})}});l.validate(t)})}else $toast.warning(i.msg),a.modal("hide")})},D=function(a,n,i,s,r){var d=$msg.dialog("taskInfo",function(t,e){return!1},{title:"维修单详情",modalClassName:"modal-lg",buttons:{success:{label:"确定",className:"btn-info"}}}),o=$api.get({loading:!1,url:$cfg.baseUrl+"/task/load/"+i.taskNo});$.when(d,o,$dict.get("station")).then(function(a,n){var s=a.find("form.info-left"),r=a.find("form.info-right"),d=-1,o=function(){var n=$api.get({url:$cfg.baseUrl+"/taskProcess/loadAll/"+i.taskNo});$.when(n).done(function(n){if(n.success){n&&n.data&&n.data.length>0&&(d=n.data[n.data.length-1].id);var i=r.find(".task-timeline");$cfg.picUrl&&$.each(n.data,function(t,e){$.each(e.basTaskDealNodes,function(t,e){e.url=$cfg.picUrl+e.url})});var o=t.compile(e)(n);i.html(o),i.imagesLoaded(function(){s.height(Math.max(s.height(),r.height())),a.resize()})}else $toast.warning(n.msg),a.modal("hide")}).fail(function(t){$toast.error(t)})};b(function(){var t=$dict.getItem("station","stionId",n.data.stionId);s.formData($.extend({},x,n.data,{serviceType:t.serviceType,stcd:t.stcd,helpPersonnel:(n.data.helpPersonnel||"").split(","),stnm:t.stnm})),$.updateTextFields(),s.formDisable(!1),$("#p_taskNo").attr("disabled","true"),$("#p_taskStatus").attr("disabled","true"),$("#p_stcd").attr("disabled","true"),$("#p_stnm").attr("disabled","true"),$("#p_serviceType").attr("disabled","true"),$("#p_addvcd").attr("disabled","true"),$("#p_content").attr("disabled","true"),$("#p_priorityStatus").attr("disabled","true"),$("#p_createTime").attr("disabled","true"),$("#p_maintUserId").attr("disabled","true"),$("#p_helpPersonnel").attr("disabled","true");var e={ignore:".ignore",errorPlacement:function(t,e){t.appendTo(e.parents(".form-group"))},rules:{content:{required:!0}},messages:{content:{required:"内容不能为空"}}},a=$.extend({},e,{submitHandler:function(t){var e={},a=r.formData();$.extend(e,a,{taskNo:i.taskNo,dealType:1,procId:d});var n=$api.post({url:$cfg.baseUrl+"/taskDealNode/addJournal",data:$opt.paramFilter(e)});$.when(n).done(function(t){t.success?($toast.success(t.msg),r.get(0).reset(),o()):$toast.warning(t.msg)}).fail(function(t){$toast.error(t)})}});r.validate(a),o()})})},S=function(){var e=$api.get({loading:!1,url:$cfg.baseUrl+"/message/select",data:{page:"false",orderdir:"desc",order:"createTime"}});$.when(e).done(function(e){if(e.success){var a=$("#p_info").get(0).innerHTML.replace(/\[\[/g,"{{").replace(/]]/g,"}}"),n=t.compile(a)({data:e.data});$(".txtMarquee").html(n).slide({mainCell:"ul",autoPlay:!0,effect:"leftMarquee",vis:2,interTime:50})}else $toast.warning(e.msg)}).fail(function(t){$toast.error(t)})},C=0,O=function(){S(),C=setInterval(S,3e5),$(".txtMarquee").on("click","li",function(){var t=$(this).attr("data-taskNo"),e=$(this).attr("data-type");"1"!==e&&"2"!==e||!t||D(null,null,{taskNo:t},null,null)})};return{data:{model:[{icon:"fa fa-wrench",title:"运维管理"},{icon:"",title:"运维处理"}]},init:function(t){console.log(t+":init"),d(),o(),O()},dispose:function(t){console.log(t+":dispose"),clearInterval(C)}}});