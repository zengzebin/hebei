define(["datatables","jquery-uploadPreviewer"],function(){var t,e={ignore:".ignore",errorPlacement:function(t,e){t.appendTo(e.parents(".form-group"))},rules:{stcd:{required:!0}},messages:{stcd:{required:"请填写测站编码"}}},a=function(){$dict.init({name:"stcdType",url:$cfg.baseUrl+"/OptionSelect/com-ssxt-op-stcdType/"}),$dict.init({name:"addvcd",url:$cfg.baseUrl+"/addvcd/loadAll/"}),$dict.init({name:"maintainer",url:$cfg.baseUrl+"/users/loadAll/?isOperation=1"}),$dict.init({name:"serviceType",url:$cfg.baseUrl+"/OptionSelect/com-ssxt-op-serviceType/"})},n=function(){var t,e=[];t=$dict.initOptions({elem:"#c_sttp",dict:"stcdType",propText:"showValue",propId:"trueValue",append:[{id:"-1",text:"全部"}]}),e.push(t),t=$dict.initOptions({elem:"#c_serviceType",dict:"serviceType",propText:"showValue",propId:"trueValue",append:[{id:"-1",text:"全部"}]}),e.push(t),t=$dict.initOptions({s2s:!0,elem:"#c_addvcd",dict:"addvcd",propText:"addvnm",propId:"addvcd",append:[{id:"-1",text:"全部"}],filter:function(t,e){var a=$.userData.addvcd;return"0000"===a.slice(-4)||"00"===a.slice(-2)&&t.addvcd.slice(0,-2)===a.slice(0,-2)||a===t.addvcd}}),e.push(t),$.when.apply($,e).done(function(){c()}),$("#b_refresh,#b_search").on("click",function(){c()}),$("#b_add").on("click",function(){l()}),$("#b_export").on("click",function(){s()}),$("#b_import").uploadPreviewer({buttonText:"导入"}),$("#b_import").on("file-preview:changed",function(){i()}),$("#b_import").parents(".file-preview-button,.file-preview-shadow").addClass("w-100p"),$("#file-preview-table").addClass("hide")},i=function(){var e=$("#b_import").data("file-preview"),a=e.fileList();if(Object.keys(a).length>0){var n=new FormData;$.each(a,function(t,e){n.append("file["+t+"]",e)});var i=$api.post({contentType:!1,processData:!1,url:$cfg.baseUrl+"/stinfo/upload",data:n});$.when(i).done(function(a){a.success?(t.fnUpdate(),e.clearFileList(),$toast.success(a.msg)):$toast.warning(a.msg)}).fail(function(t){$toast.error(t)})}},s=function(){var t=$.extend({},$opt.paramFilter({stcd:$("#c_stcd").val(),stnm:$("#c_stnm").val(),sttp:$("#c_sttp").val(),serviceType:$("#c_serviceType").val(),addvcd:$("#c_addvcd").val()})),e="";$.each(t,function(t,a){e+="&"+t+"="+a});var a=$("#c_stcd").val()?"编码:"+$("#c_stcd").val()+"-":"",n=$("#c_stnm").val()?"名称:"+$("#c_stnm").val()+"-":"",i=$("#c_sttp").find("option:selected").text(),s=$("#c_serviceType").find("option:selected").text(),c=$("#c_addvcd").find("option:selected").text();e+="&fileName=测站信息("+a+n+("全部"===i?"全部类型":i)+"-"+("全部"===s?"全部业务":s)+"-"+("全部"===c?"全部区域":c)+")",$opt.downloadFile($cfg.baseUrl+"/stinfo/export?"+e.substr(1))},c=function(){t&&t.fnDestroy();var e=$.extend({},$plugin.datatable_server,{fnServerData:function(t,e,a){var n=$.extend({},$opt.paramConvert(e),$opt.paramFilter({stcd:$("#c_stcd").val(),stnm:$("#c_stnm").val(),sttp:$("#c_sttp").val(),serviceType:$("#c_serviceType").val(),addvcd:$("#c_addvcd").val()})),i=$api.get({url:$cfg.baseUrl+"/stinfo/select",data:n});$.when(i).done(function(t){t.success?a($opt.dataConvert(t)):$toast.warning(t.msg)}).fail(function(t){$toast.error(t)})},aaSorting:[[0,"desc"]],columns:[{title:"测站ID",data:"stionId",class:"text-center"},{title:"测站编码",data:"stcd",class:"text-center"},{title:"测站名称",data:"stnm",class:"text-center"},{title:"测站位置",data:"stlc",class:"text-center"},{title:"所属区域",data:"addvcd",class:"text-center",fnCreatedCell:function(t,e,a,n,i){$dict.get("addvcd").then(function(a){$.each(a,function(a,n){n.addvcd===e&&$(t).html(n.addvnm)})})}},{title:"业务类型",data:"serviceType",class:"text-center",fnCreatedCell:function(t,e,a,n,i){$dict.get("serviceType").then(function(a){$.each(a,function(a,n){n.trueValue===e&&$(t).html(n.showValue)})})}},{title:"测站类型",data:"sttp",class:"text-center",fnCreatedCell:function(t,e,a,n,i){$dict.get("stcdType").then(function(a){$.each(a,function(a,n){n.trueValue===e&&$(t).html(n.showValue)})})}},{title:"归属维修人员",data:"repairId",class:"text-center",fnCreatedCell:function(t,e,a,n,i){$dict.get("maintainer").then(function(a){$.each(a,function(a,n){n.id===e&&$(t).html(n.name)})})}},{title:"联系电话",data:"repairId",class:"text-center",fnCreatedCell:function(t,e,a,n,i){$dict.get("maintainer").then(function(a){var n="";$.each(a,function(t,a){a.id===e&&a.phone&&(n='<a><i class="fa fa-phone-square text-success ml-5"></i> '+a.phone+"</a>")}),$(t).html(n)})}},{title:"监测",data:"valid",class:"text-center",bSortable:!1,fnCreatedCell:function(t,e,a,n,i){if(1===e)var s=$('<input checked="checked" type="checkbox"/>');else var s=$('<input type="checkbox"/>');s.on("click",function(){$(this).val(a.valid),r(t,e,a,n,i)}),$(t).html("").append(s)}},{title:"操作",data:"stcd",bSortable:!1,fnCreatedCell:function(t,e,a,n,i){var s=$('<a class="btn btn-warning btn-xs ml-5"><i class="fa fa-edit mr-5"></i>修改</a>'),c=$('<a class="btn btn-danger btn-xs ml-5"><i class="fa fa-trash-o mr-5"></i>删除</a>'),d=$('<a class="btn btn-info btn-xs ml-5"><i class="fa fa-file-o mr-5"></i>查看</a>'),o=$('<a class="btn btn-green btn-xs ml-5"><i class="fa fa-picture-o mr-5"></i>图片</a>');s.on("click",function(){f(t,e,a,n,i)}),c.on("click",function(){u(t,e,a,n,i)}),d.on("click",function(){p(t,e,a,n,i)}),o.on("click",function(){m(t,e,a,n,i)}),$(t).html("").append(s).append(c).append(d).append(o)}}]});t=$("#t_station").dataTable(e)},d=function(t){var e,a=[];e=$dict.initOptions({elem:"#p_serviceType",dict:"serviceType",propText:"showValue",propId:"trueValue"}),a.push(e),e=$dict.initOptions({elem:"#p_sttp",dict:"stcdType",propText:"showValue",propId:"trueValue"}),a.push(e),e=$dict.initOptions({s2s:!0,elem:"#p_addvcd",dict:"addvcd",propText:"addvnm",propId:"addvcd",filter:function(t,e){var a=$.userData.addvcd;return"0000"===a.slice(-4)||"00"===a.slice(-2)&&t.addvcd.slice(0,-2)===a.slice(0,-2)||a===t.addvcd}}),a.push(e),e=$dict.initOptions({elem:"#p_repairId",dict:"maintainer",propText:"name",propId:"id"}),a.push(e),$.when.apply($,a).done(function(){$.isFunction(t)&&t()})},o={},r=function(t,e,a,n,i){if(a.valid)var s=0;else var s=1;var c={valid:s},d=$api.put({url:$cfg.baseUrl+"/stinfo/update/"+a.stionId,data:$opt.paramFilter(c)});$.when(d).done(function(t){t.success?$toast.success(t.msg):$toast.warning(t.msg)}).fail(function(t){$toast.error(t)})},l=function(){var a=$msg.dialog("stationAdd",function(t,e){return $(e).find("form").submit(),!1},{title:"新增测站",modalClassName:"modal-lg"});$.when(a,$dict.get("maintainer")).then(function(a,n){var i=a.find("form");d(function(){i.formData(o),$.updateTextFields();var s=$.extend({},e,{submitHandler:function(e){var n={},s=i.formData();$.extend(n,s);var c=$api.post({url:$cfg.baseUrl+"/stinfo/add",data:$opt.paramFilter(n)});$.when(c).done(function(e){e.success?($toast.success(e.msg),a.modal("hide"),$dict.remove("station"),t.fnUpdate()):$toast.warning(e.msg)}).fail(function(t){$toast.error(t)})}});i.validate(s),i.formDisable(!1);var c,d=function(){var t=a.find("#p_addvcd").val(),e=$.map(n,function(e){var a=!1,n=e.directlyUnder||"";if("0000"===t.slice(-4)?t.slice(0,2)===n.slice(0,2)&&(a=!0):"00"===t.slice(-2)?t.slice(0,4)===n.slice(0,4)&&(a=!0):t===n&&(a=!0),a)return'<option value="'+e.id+'">'+e.name+"</option>"});a.find("#p_repairId").css("width","100%").removeClass("select2-hidden-accessible"),c&&clearTimeout(c),c=setTimeout(function(){a.find("#p_repairId").html(e).select2()},100)};a.find("#p_addvcd").on("change",function(){d()}),d()})})},f=function(a,n,i,s,c){var r=$msg.dialog("stationAdd",function(t,e){return $(e).find("form").submit(),!1},{title:"修改测站信息",modalClassName:"modal-lg"}),l=$api.get({url:$cfg.baseUrl+"/stinfo/load/"+i.stionId});$.when(r,l,$dict.get("maintainer")).then(function(a,n,s){var c=a.find("form");d(function(){var d=$.extend({},e,{submitHandler:function(e){var n={},s=c.formData();$.extend(n,s);var d=$api.put({url:$cfg.baseUrl+"/stinfo/update/"+i.stionId,data:$opt.paramFilter(n)});$.when(d).done(function(e){e.success?($toast.success(e.msg),a.modal("hide"),$dict.remove("station"),t.fnUpdate()):$toast.warning(e.msg)}).fail(function(t){$toast.error(t)})}});if(c.validate(d),n.success){$toast.success(n.msg);var r,l=!0,f=function(t){var e=a.find("#p_addvcd").val(),n=$.map(s,function(t){var a=!1,n=t.directlyUnder||"";if("0000"===e.slice(-4)?e.slice(0,2)===n.slice(0,2)&&(a=!0):"00"===e.slice(-2)?e.slice(0,4)===n.slice(0,4)&&(a=!0):e===n&&(a=!0),a)return'<option value="'+t.id+'">'+t.name+"</option>"});a.find("#p_repairId").css("width","100%").removeClass("select2-hidden-accessible"),r&&clearTimeout(r),r=setTimeout(function(){var t=a.find("#p_repairId").val();a.find("#p_repairId").html(n).select2(),l&&(l=!1,a.find("#p_repairId").val(t).change())},100)};a.find("#p_addvcd").on("change",function(){f()}),c.formData($.extend({},o,n.data)),$.updateTextFields(),c.formDisable(!1),$("#p_stcd").attr("disabled","true")}else $toast.warning(n.msg),a.modal("hide")})})},u=function(e,a,n,i,s){$msg.confirm("是否删除该记录?",function(){var e=$api.del({url:$cfg.baseUrl+"/stinfo/delete/"+n.stionId});$.when(e).done(function(e){e.success?($toast.success(e.msg),$dict.remove("station"),t.fnUpdate()):$toast.warning(e.msg)}).fail(function(t){$toast.error(t)})})},p=function(t,e,a,n,i){var s=$msg.dialog("stationAdd",function(t,e){},{title:"测站信息",modalClassName:"modal-lg",buttons:{success:{label:"确定",className:"btn-info"}}}),c=$api.get({url:$cfg.baseUrl+"/stinfo/load/"+a.stionId});$.when(s,c).then(function(t,e){var a=t.find("form");d(function(){a.formDisable(!0),e.success?($toast.success(e.msg),a.formData($.extend({},o,e.data)),$.updateTextFields(),a.formDisable(!0)):($toast.warning(e.msg),t.modal("hide"))})})},m=function(t,a,n,i,s){var c=$msg.dialog("stationPicAdd",function(t,e){return!1},{title:"测站图片",buttons:{success:{label:"确定",className:"btn-info"}}});$.when(c).then(function(t){var a=function(){var e=$api.get({url:$cfg.baseUrl+"/stinfo/stcdImage/"+n.stcd});$.when(e).then(function(e){if(e.success){var a="";$cfg.picUrl&&$.each(e.data,function(t,e){e.url=$cfg.picUrl+e.url}),$.each(e.data,function(t,e){a+='<li><div class="col-md-11"><img src="'+e.url+'"></div><div class="col-md-1"><button class="btn btn-danger" type="button" target="'+e.id+'">×</button></div></li>'}),t.find(".picture-list").html(a),t.find(".picture-list").on("click",".btn-danger",function(){var t=$(this).attr("target"),e=$(this).parents("li");$msg.confirm("是否删除该图片?",function(){var a=$api.del({url:$cfg.baseUrl+"/stinfo/deleteImage/"+t});$.when(a).done(function(t){t.success?($toast.success(t.msg),e.remove()):$toast.warning(t.msg)}).fail(function(t){$toast.error(t)})})}),setTimeout(function(){t.resize()},100)}else $toast.warning(e.msg)}).fail(function(t){$toast.error(t)})};a();var i=t.find("form");t.find("#p_file").uploadPreviewer({buttonText:'<i class="fa fa-plus-circle mr-5"></i>新增图片'}),t.find("#p_file").on("file-preview:changed",function(){t.resize()});var s=$.extend({},e,{submitHandler:function(t){var e=i.find("#p_file").data("file-preview"),s=e.fileList();if(Object.keys(s).length>0){var c=new FormData;$.each(s,function(t,e){c.append("file["+t+"]",e)});var d=$api.post({contentType:!1,processData:!1,url:$cfg.baseUrl+"/stinfo/uploadImage/"+n.stcd,data:c});$.when(d).done(function(t){t.success?(a(),e.clearFileList(),$toast.success(t.msg)):$toast.warning(t.msg)}).fail(function(t){$toast.error(t)})}else $toast.warning("请添加上传文件")}});i.validate(s)})};return{data:{model:[{icon:"fa fa-cog",title:"系统管理"},{icon:"",title:"站点信息管理"}]},init:function(t){console.log(t+":init"),a(),n()},dispose:function(t){console.log(t+":dispose")}}});