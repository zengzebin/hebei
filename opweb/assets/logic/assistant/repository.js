define(["handlebars","html!!problemInfoAdd","datatables","bootstrap-datetimepickerCN"],function(t,e){var a,n,i,r,o={ignore:".ignore",errorPlacement:function(t,e){t.appendTo(e.parents(".form-group"))},rules:{loginId:{required:!0},name:{required:!0},roleId:{required:!0},addvcd:{required:!0}},messages:{loginId:{required:"请填写登录ID"},name:{required:"请填写用户名称"},roleId:{required:"请选择用户角色"},addvcd:{required:"请选择管理区域"}}},l=function(){$dict.init({name:"addvcd",url:$cfg.baseUrl+"/addvcd/loadAll/"}),$dict.init({name:"role",url:$cfg.baseUrl+"/role/loadAll/"}),$dict.init({name:"user",url:$cfg.baseUrl+"/users/loadAll/"}),$dict.init({name:"maintainer",url:$cfg.baseUrl+"/users/loadAll/?isOperation=1"})},s=function(){p(),m(),$("#b_refresh,#b_search").on("click",function(){p(),m()}),$("#b_add").on("click",function(){h()})},c=function(t){var e=$api.get({url:$cfg.baseUrl+"/problem/info"});$.when(e).done(function(e){if(e.success){var a=e.data[0];t.find("#p_problem").html(a.problemNum),t.find("#p_answer").html(a.answerNum),t.find("#p_level").html(a.grade),t.trigger("loading.hide")}else $toast.warning(e.msg),t.trigger("loading.hide")}).fail(function(e){$toast.error(e),t.trigger("loading.hide")}),this.attach||(this.attach=!0)},d=function(t){n&&n.fnDestroy();var e=$.extend({},$plugin.datatable_server,{fnServerData:function(e,a,n){var i=$.extend({},$opt.paramConvert(a),$opt.paramFilter({})),r=$api.get({loading:!1,url:$cfg.baseUrl+"/problem/relevant",data:i});$.when(r).done(function(e){t.trigger("loading.hide"),e.success?n($opt.dataConvert(e)):$toast.warning(e.msg)}).fail(function(e){t.trigger("loading.hide"),$toast.error(e)})},aaSorting:[[0,"desc"]],iDisplayLength:5,autoWidth:!1,info:"",columns:[{title:"标题",data:"title",class:"text-center"},{title:"提问时间",data:"createTime",class:"text-center"},{title:"操作",data:"id",bSortable:!1,fnCreatedCell:function(t,e,a,n,i){var r=$('<a class="btn btn-info btn-xs ml-5"><i class="fa fa-file-o"></i>查看</a>');r.on("click",function(){x(t,e,a,n,i)}),$(t).html("").append(r)}}]});n=t.find(".table").dataTable(e),this.attach||(this.attach=!0)},f=function(t){i&&i.fnDestroy();var e=$.extend({},$plugin.datatable_server,{fnServerData:function(e,a,n){var i=$.extend({},$opt.paramConvert(a),$opt.paramFilter({})),r=$api.get({loading:!1,url:$cfg.baseUrl+"/problem/select",data:i});$.when(r).done(function(e){t.trigger("loading.hide"),e.success?n($opt.dataConvert(e)):$toast.warning(e.msg)}).fail(function(e){t.trigger("loading.hide"),$toast.error(e)})},aaSorting:[[1,"desc"]],iDisplayLength:5,autoWidth:!1,info:"",columns:[{title:"标题",data:"title",class:"text-center"},{title:"查看",data:"clickNum",class:"text-center hide"},{title:"提问时间",data:"createTime",class:"text-center"},{title:"操作",data:"id",bSortable:!1,fnCreatedCell:function(t,e,a,n,i){var r=$('<a class="btn btn-info btn-xs ml-5"><i class="fa fa-file-o"></i>查看</a>');r.on("click",function(){x(t,e,a,n,i)}),$(t).html("").append(r)}}]});i=t.find(".table").dataTable(e),this.attach||(this.attach=!0)},u=function(t){r&&r.fnDestroy();var e=$.extend({},$plugin.datatable_server,{fnServerData:function(e,a,n){var i=$.extend({},$opt.paramConvert(a),$opt.paramFilter({})),r=$api.get({loading:!1,url:$cfg.baseUrl+"/problem/select",data:i});$.when(r).done(function(e){t.trigger("loading.hide"),e.success?n($opt.dataConvert(e)):$toast.warning(e.msg)}).fail(function(e){t.trigger("loading.hide"),$toast.error(e)})},aaSorting:[[1,"desc"]],iDisplayLength:5,autoWidth:!1,info:"",columns:[{title:"标题",data:"title",class:"text-center"},{title:"提问时间",data:"createTime",class:"text-center"},{title:"操作",data:"id",bSortable:!1,fnCreatedCell:function(t,e,a,n,i){var r=$('<a class="btn btn-info btn-xs ml-5"><i class="fa fa-file-o"></i>查看</a>');r.on("click",function(){x(t,e,a,n,i)}),$(t).html("").append(r)}}]});r=t.find(".table").dataTable(e),this.attach||(this.attach=!0)},m=function(){var e=[{elem:$("#p_panel_2").get(0),data:{title:"我的信息"},initFunc:c},{elem:$("#p_panel_1").get(0),data:{title:"与我相关"},initFunc:d},{elem:$("#p_panel_1").get(0),data:{title:"热门话题"},initFunc:f},{elem:$("#p_panel_1").get(0),data:{title:"最新提问"},initFunc:u}],a=$(".panel-list");a.html(""),$.map(e,function(e){var n=e.html||e.elem.innerHTML.replace(/\[\[/g,"{{").replace(/]]/g,"}}"),i=t.compile(n)(e.data||{}),r=$(i);r.on("refresh",function(){$.isFunction(e.initFunc)&&(r.trigger("loading.show"),e.initFunc.apply(e,[r]))}),a.append(r),$.isFunction(e.initFunc)&&(e.attach=!1,e.initFunc.apply(e,[r]))})},p=function(){a&&a.fnDestroy();var t=$.extend({},$plugin.datatable_server,{fnServerData:function(t,e,a){var n=$.extend({},$opt.paramConvert(e),$opt.paramFilter({CreateUserId:$.userData.id})),i=$api.get({url:$cfg.baseUrl+"/problem/select",data:n});$.when(i).done(function(t){t.success?a($opt.dataConvert(t)):$toast.warning(t.msg)}).fail(function(t){$toast.error(t)})},aaSorting:[[0,"desc"]],columns:[{title:"标题",data:"title",class:"text-center"},{title:"查看 / 回复",data:"id",class:"text-center",fnCreatedCell:function(t,e,a,n,i){$(t).html("查看"+a.clickNum+"次 / "+a.answerNum+"个回复")}},{title:"提问人",data:"createUserId",class:"text-center",fnCreatedCell:function(t,e,a,n,i){$dict.get("user").then(function(a){$.each(a,function(a,n){n.id===e&&$(t).html(n.name)})})}},{title:"提问时间",data:"createTime",class:"text-center"},{title:"操作",data:"id",bSortable:!1,fnCreatedCell:function(t,e,a,n,i){var r=$('<a class="btn btn-danger btn-xs ml-5"><i class="fa fa-trash-o"></i>删除</a>'),o=$('<a class="btn btn-info btn-xs ml-5"><i class="fa fa-file-o"></i>查看</a>');r.on("click",function(){v(t,e,a,n,i)}),o.on("click",function(){x(t,e,a,n,i)}),$(t).html("").append(o).append(r)}}]});a=$("#t_sysuser").dataTable(t)},g=function(t){var e,a=[];e=$dict.initOptions({elem:"#p_createUserId",dict:"user",propText:"name",propId:"id"}),a.push(e),$.when.apply($,a).done(function(){$.isFunction(t)&&t()})},b={},h=function(){var t=$msg.dialog("problemAdd",function(t,e){return $(e).find("form").submit(),!1},{title:"新增问题"});$.when(t).then(function(t){var e=t.find("form");g(function(){e.formData(b),$.updateTextFields(),$("#p_createUserId").parents(".col-md-12").remove(),$("#p_createTime").parents(".col-md-12").remove();var n=$.extend({},o,{submitHandler:function(n){var i={},r=e.formData();$.extend(i,r);var o=$api.post({url:$cfg.baseUrl+"/problem/add",data:$opt.paramFilter(i)});$.when(o).done(function(e){e.success?($toast.success(e.msg),t.modal("hide"),a.fnUpdate(),m()):$toast.warning(e.msg)}).fail(function(t){$toast.error(t)})}});e.validate(n),e.formDisable(!1)})})},v=function(t,e,n,i,r){$msg.confirm("是否删除该记录?",function(){var t=$api.del({url:$cfg.baseUrl+"/problem/delete/"+n.id});$.when(t).done(function(t){t.success?($toast.success(t.msg),a.fnUpdate(),m()):$toast.warning(t.msg)}).fail(function(t){$toast.error(t)})})},x=function(n,i,r,l,s){var c=$msg.dialog("problemPanelAdd",function(t,e){},{title:"问题详情",modalClassName:"modal-lg",buttons:{success:{label:"确定",className:"btn-info"}}}),d=$api.get({url:$cfg.baseUrl+"/problem/read/"+r.id});$.when(c,d).then(function(n){var i=function(){var a=$api.get({url:$cfg.baseUrl+"/problem/load/"+r.id});$.when(a,$dict.get("user")).done(function(a){if(a.success){var i=$dict.getItem("user","id",a.data.createUserId),a=$.extend({},a.data,{createUserName:i?i.name:"",basProblemAnswers:$.map(a.data.basProblemAnswers,function(t){return i=$dict.getItem("user","id",t.createUserId),t.createUserName=i?i.name:"",t}).sort(function(t,e){return moment(t.createTime).format("X")>moment(e.createTime).format("X")})}),r=t.compile(e)(a);$(n).find(".problem-container").html(r),n.resize()}else $toast.warning(a.msg)}).fail(function(t){$toast.error(t)})};i();var l=n.find("form"),s=$.extend({},o,{submitHandler:function(t){var e={},n=l.formData();$.extend(e,n);var o=$api.post({url:$cfg.baseUrl+"/problem/answer",data:$.extend({},$opt.paramFilter(e),{problemId:r.id})});$.when(o).done(function(t){t.success?($toast.success(t.msg),a.fnUpdate(),m(),l.get(0).reset(),i()):$toast.warning(t.msg)}).fail(function(t){$toast.error(t)})}});l.validate(s)})};return{data:{model:[{icon:"fa fa-server",title:"运维助理"},{icon:"fa fa-certificate",title:"运维知识库"}]},init:function(t){console.log(t+":init"),l(),s()},dispose:function(t){console.log(t+":dispose")}}});