define(["datatables","jquery-uploadPreviewer"],function(){var e,a={ignore:".ignore",errorPlacement:function(e,a){e.appendTo(a.parents(".form-group"))},rules:{name:{required:!0},author:{required:!0}},messages:{name:{required:"请填写文件名称"},author:{required:"请填写文件名称"}}},t=function(){$dict.init({name:"stcdType",url:$cfg.baseUrl+"/OptionSelect/com-ssxt-op-stcdType/"}),$dict.init({name:"addvcd",url:$cfg.baseUrl+"/addvcd/loadAll/"}),$dict.init({name:"maintainer",url:$cfg.baseUrl+"/users/loadAll/?isOperation=1"}),$dict.init({name:"serviceType",url:$cfg.baseUrl+"/OptionSelect/com-ssxt-op-serviceType/"})},n=function(){var e=[];$.when.apply($,e).done(function(){i()}),$("#b_refresh,#b_search").on("click",function(){i()}),$("#b_add").on("click",function(){r()})},i=function(){e&&e.fnDestroy();var a=$.extend({},$plugin.datatable_server,{fnServerData:function(e,a,t){var n=$.extend({},$opt.paramConvert(a),$opt.paramFilter({name:$("#c_name").val()})),i=$api.get({url:$cfg.baseUrl+"/classRoom/select",data:n});$.when(i).done(function(e){e.success?t($opt.dataConvert(e)):$toast.warning(e.msg)}).fail(function(e){$toast.error(e)})},aaSorting:[[0,"desc"]],columns:[{title:"名称",data:"name",class:"text-center"},{title:"作者/来源",data:"author",class:"text-center"},{title:"上传时间",data:"modifyTime",class:"text-center"},{title:"格式",data:"type",class:"text-center"},{title:"点击次数",data:"clickNum",class:"text-center"},{title:"操作",data:"id",bSortable:!1,fnCreatedCell:function(a,t,n,i,o){var s=$('<a class="btn btn-warning btn-xs ml-5"><i class="fa fa-edit"></i>修改</a>'),r=$('<a class="btn btn-danger btn-xs ml-5"><i class="fa fa-trash-o"></i>删除</a>'),f=$('<a class="btn btn-info btn-xs ml-5"><i class="fa fa-file-o"></i>下载查看</a>');s.on("click",function(){c(a,t,n,i,o)}),r.on("click",function(){l(a,t,n,i,o)}),f.on("click",function(){$opt.downloadFile($cfg.baseUrl+"/classRoom/download/"+t,n.fileName),e.fnUpdate()}),$(a).html("").append(s).append(r).append(f)}}]});e=$("#t_classroom").dataTable(a)},o=function(e){var a=[];$("#p_file").uploadPreviewer({buttonText:'<i class="fa fa-plus-circle mr-5"></i>选择文件'}),$.when.apply($,a).done(function(){$.isFunction(e)&&e()})},s={},r=function(){var t=$msg.dialog("classroomAdd",function(e,a){return $(a).find("form").submit(),!1},{title:"新增文件"});$.when(t).then(function(t){var n=t.find("form");o(function(){n.formData(s),$.updateTextFields(),t.find("#p_file").on("file-preview:changed",function(){t.resize()});var i=$.extend({},a,{submitHandler:function(a){var i=n.find("#p_file").data("file-preview"),o=i.fileList();if(Object.keys(o).length>0){var s={},r=n.formData();$.extend(s,r);var c=$api.post({url:$cfg.baseUrl+"/classRoom/add",data:$opt.paramFilter(s)});$.when(c).done(function(a){if(a.success){var n=a.data.id;s=new FormData,$.each(o,function(e,a){s.append("file["+e+"]",a)});var i=$api.post({contentType:!1,processData:!1,url:$cfg.baseUrl+"/classRoom/uploadImage/"+n,data:s});$.when(i).done(function(a){a.success?(t.modal("hide"),e.fnUpdate(),$toast.success(a.msg)):$toast.warning(a.msg)}).fail(function(e){$toast.error(e)})}else $toast.warning(a.msg)}).fail(function(e){$toast.error(e)})}else $toast.warning("请添加上传文件")}});n.validate(i),n.formDisable(!1)})})},c=function(t,n,i,r,c){var l=$msg.dialog("classroomAdd",function(e,a){return $(a).find("form").submit(),!1},{title:"修改文件"});$.when(l).then(function(t){var n=t.find("form");o(function(){n.formData($.extend({},s,i)),$.updateTextFields(),t.find("#p_file").on("file-preview:changed",function(){t.resize()});var o=$.extend({},a,{submitHandler:function(a){var o=n.find("#p_file").data("file-preview"),s={},r=n.formData();$.extend(s,r);var c=$api.put({url:$cfg.baseUrl+"/classRoom/update",data:$opt.paramFilter(s)});$.when(c).done(function(a){if(a.success){var n=o.fileList();if(Object.keys(n).length>0){var s=new FormData;$.each(n,function(e,a){s.append("file["+e+"]",a)});var r=$api.post({contentType:!1,processData:!1,url:$cfg.baseUrl+"/classRoom/uploadImage/"+i.id,data:s});$.when(r).done(function(a){a.success?(t.modal("hide"),e.fnUpdate(),$toast.success(a.msg)):$toast.warning(a.msg)}).fail(function(e){$toast.error(e)})}else $toast.success(a.msg),t.modal("hide"),e.fnUpdate()}else $toast.warning(a.msg)}).fail(function(e){$toast.error(e)})}});n.validate(o),n.formDisable(!1)})})},l=function(a,t,n,i,o){$msg.confirm("是否删除该记录?",function(){var a=$api.del({url:$cfg.baseUrl+"/classRoom/delete/"+n.id});$.when(a).done(function(a){a.success?($toast.success(a.msg),e.fnUpdate()):$toast.warning(a.msg)}).fail(function(e){$toast.error(e)})})};return{data:{model:[{icon:"fa fa-server",title:"运维助理"},{icon:"",title:"运维课堂"}]},init:function(e){console.log(e+":init"),t(),n()},dispose:function(e){console.log(e+":dispose")}}});