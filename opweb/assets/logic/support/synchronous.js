define(["handlebars","highcharts","datatables","bootstrap-datetimepickerCN"],function(t){var e,n,a=function(){$dict.init({name:"priority",url:$cfg.baseUrl+"/OptionSelect/com-ssxt-op-priority/"}),$dict.init({name:"serviceType",url:$cfg.baseUrl+"/OptionSelect/com-ssxt-op-serviceType/"}),$dict.init({name:"addvcd",url:$cfg.baseUrl+"/addvcd/loadAll/"}),$dict.init({name:"device",url:$cfg.baseUrl+"/device/loadAll/"}),$dict.init({name:"station",url:$cfg.baseUrl+"/stinfo/loadAll/"}),$dict.init({name:"stcdType",url:$cfg.baseUrl+"/OptionSelect/com-ssxt-op-stcdType/"}),$dict.init({name:"maintainer",url:$cfg.baseUrl+"/users/loadAll/?isOperation=1"}),$dict.init({name:"statusCode",url:$cfg.baseUrl+"/OptionSelect/statusCode"})},i=function(t){if(!this.attach){t.find("#c_startTime").datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:!0,todayBtn:!0,pickerPosition:"bottom-left"}),t.find("#c_endTime").datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:!0,todayBtn:!0,pickerPosition:"bottom-left"});var n=[],a=this;return $.when.apply($,n).done(function(){t.find("#c_startTime").attr("disabled","true"),t.find("#c_endTime").attr("disabled","true"),t.find("#c_startTime").val(moment().format("YYYY-MM-DD")).change(),t.find("#c_endTime").val(moment().format("YYYY-MM-DD")).change(),a.attach=!0,a.initFunc.apply(a,[t])}),t.find("#c_time").on("change",function(){var e=t.find(this).val().toString();t.find("#c_startTime").attr("disabled","true"),t.find("#c_endTime").attr("disabled","true"),"1"===e?(t.find("#c_startTime").val(moment().format("YYYY-MM-DD")).change(),t.find("#c_endTime").val(moment().format("YYYY-MM-DD")).change()):"2"===e?(t.find("#c_startTime").val(moment().add(-6,"d").format("YYYY-MM-DD")).change(),t.find("#c_endTime").val(moment().format("YYYY-MM-DD")).change()):"3"===e?(t.find("#c_startTime").val(moment().add(1,"d").add(-1,"M").format("YYYY-MM-DD")).change(),t.find("#c_endTime").val(moment().format("YYYY-MM-DD")).change()):"4"===e&&(t.find("#c_startTime").val("").change(),t.find("#c_endTime").val("").change(),t.find("#c_startTime").removeAttr("disabled").trigger("attr.update"),t.find("#c_endTime").removeAttr("disabled").trigger("attr.update"))}),t.find(".box-setting").on("click",function(){r()}),void(this.attach=!0)}var i=t.find("#c_startTime").val(),d=t.find("#c_endTime").val();if(!i||!d)return $toast.warning("开始时间或结束时间不能为空"),void t.trigger("loading.hide");e&&e.fnDestroy();var c=$.extend({},$plugin.datatable_server,{fnServerData:function(e,n,a){var r=$api.get({loading:!1,url:$cfg.baseUrl+"/server/synchronization",data:{startTime:i,endTime:d}});$.when(r,$dict.get("addvcd")).done(function(e){t.trigger("loading.hide"),e.success?a($opt.dataConvert(e)):$toast.warning(e.msg)}).fail(function(e){t.trigger("loading.hide"),$toast.error(e)})},bPaginate:!1,ordering:!1,autoWidth:!1,info:"",columns:[{title:"服务器名",data:"name",class:"text-center"},{title:"所属市",data:"addvcd",class:"text-center",render:function(t,e,n){return $dict.getItem("addvcd","addvcd",t.slice(0,-2)+"00").addvnm}},{title:"所属县",data:"addvnm",class:"text-center"},{title:"畅通率",data:"rate",class:"text-center",render:function(t,e,n){return(100*parseFloat(t)).toFixed(0)+"%"}}]});e=t.find(".table").dataTable(c)},d=function(){var e=[{elem:$("#p_panel_1").get(0),target:$(".panel-content").get(0),data:{title:"山洪县级预警平台数据同步情况"},initFunc:i}],n=$(".panel-content");$.map(e,function(e){e.target&&(n=$(e.target));var a=e.html||e.elem.innerHTML.replace(/\[\[/g,"{{").replace(/]]/g,"}}"),i=t.compile(a)(e.data||{}),d=$(i),r=d.hasClass("panel")?d:d.find(".panel");d.on("refresh",function(){$.isFunction(e.initFunc)&&(r.trigger("loading.show"),e.initFunc.apply(e,[r]))}),n.append(d),$.isFunction(e.initFunc)&&(e.attach=!1,e.initFunc.apply(e,[r]))})},r=function(){var t=$msg.dialog("synchronousAdd",function(t,e){return!0},{title:"服务器地址设置",modalClassName:"modal-lg",buttons:{success:{label:"确定",className:"btn-info"}}});$.when(t).then(function(t){$(t).find("#b_add").on("click",function(){l()}),n&&n.fnDestroy();var e=$.extend({},$plugin.datatable_server,{fnServerData:function(t,e,n){var a=$api.get({loading:!1,url:$cfg.baseUrl+"/server/select"});$.when(a,$dict.get("addvcd")).done(function(t){t.success?n($opt.dataConvert(t)):$toast.warning(t.msg)}).fail(function(t){$toast.error(t)})},bPaginate:!1,ordering:!1,autoWidth:!1,info:"",columns:[{title:"服务器名",data:"name",class:"text-center"},{title:"服务器IP地址",data:"ip",class:"text-center"},{title:"服务器端口",data:"port",class:"text-center"},{title:"所属县",data:"addvcd",class:"text-center",render:function(t,e,n){return $dict.getItem("addvcd","addvcd",t).addvnm}},{title:"操作",data:"id",bSortable:!1,fnCreatedCell:function(t,e,n,a,i){var d=$('<a class="btn btn-warning btn-xs ml-5"><i class="fa fa-edit mr-5"></i>修改</a>'),r=$('<a class="btn btn-danger btn-xs ml-5"><i class="fa fa-trash-o mr-5"></i>删除</a>');d.on("click",function(){f(t,e,n,a,i)}),r.on("click",function(){m(t,e,n,a,i)}),$(t).html("").append(d).append(r)}}]});n=$(t).find(".table").dataTable(e)})},c={ignore:".ignore",errorPlacement:function(t,e){t.appendTo(e.parents(".form-group"))},rules:{name:{required:!0},ip:{required:!0},port:{required:!0},addvcd:{required:!0}},messages:{name:{required:"请填写服务器名称"},ip:{required:"请填写服务器IP地址"},port:{required:"请填写服务器端口"},addvcd:{required:"请选择归属区域"}}},o=function(t){var e,n=[];e=$dict.initOptions({s2s:!0,elem:"#p_addvcd",dict:"addvcd",propText:"addvnm",propId:"addvcd",filter:function(t,e){var n=$.userData.addvcd;return"0000"===n.slice(-4)||"00"===n.slice(-2)&&t.addvcd.slice(0,-2)===n.slice(0,-2)||n===t.addvcd}}),n.push(e),$.when.apply($,n).done(function(){$.isFunction(t)&&t()})},s={},l=function(){var t=$msg.dialog("serverAdd",function(t,e){return $(e).find("form").submit(),!1},{title:"新增服务器信息"});$.when(t).then(function(t){var e=t.find("form");o(function(){e.formData(s),$.updateTextFields();var a=$.extend({},c,{submitHandler:function(a){var i={},d=e.formData();$.extend(i,d);var r=$api.post({url:$cfg.baseUrl+"/server/add",data:$opt.paramFilter(i)});$.when(r).done(function(e){e.success?($toast.success(e.msg),t.modal("hide"),n.fnUpdate()):$toast.warning(e.msg)}).fail(function(t){$toast.error(t)})}});e.validate(a),e.formDisable(!1)})})},f=function(t,e,a,i,d){var r=$msg.dialog("serverAdd",function(t,e){return $(e).find("form").submit(),!1},{title:"修改服务器信息"});$.when(r).then(function(t){var e=t.find("form");o(function(){var i=$.extend({},c,{submitHandler:function(a){var i={},d=e.formData();$.extend(i,d);var r=$api.put({url:$cfg.baseUrl+"/server/update",data:$opt.paramFilter(i)});$.when(r).done(function(e){e.success?($toast.success(e.msg),t.modal("hide"),n.fnUpdate()):$toast.warning(e.msg)}).fail(function(t){$toast.error(t)})}});e.validate(i),e.formData($.extend({},s,a)),$.updateTextFields(),e.formDisable(!1)})})},m=function(t,e,a,i,d){$msg.confirm("是否删除该记录?",function(){var t=$api.del({url:$cfg.baseUrl+"/server/delete/"+a.id});$.when(t).done(function(t){t.success?($toast.success(t.msg),n.fnUpdate()):$toast.warning(t.msg)}).fail(function(t){$toast.error(t)})})};return{data:{model:[{icon:"fa fa-globe",title:"支撑服务"},{icon:"",title:"数据同步"}]},init:function(t){console.log(t+":init"),a(),d()},dispose:function(t){console.log(t+":dispose")}}});