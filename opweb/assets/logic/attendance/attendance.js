define(["handlebars","datatables","bootstrap-datetimepickerCN","fullcalendarCN"],function(e){var t,a,n,r,i,d={ignore:".ignore",errorPlacement:function(e,t){e.appendTo(t.parents(".form-group"))},rules:{loginId:{required:!0},name:{required:!0},roleId:{required:!0},addvcd:{required:!0}},messages:{loginId:{required:"请填写登录ID"},name:{required:"请填写用户名称"},roleId:{required:"请选择用户角色"},addvcd:{required:"请选择管理区域"}}},o=function(){$dict.init({name:"addvcd",url:$cfg.baseUrl+"/addvcd/loadAll/"}),$dict.init({name:"role",url:$cfg.baseUrl+"/role/loadAll/"}),$dict.init({name:"user",url:$cfg.baseUrl+"/users/loadAll/"}),$dict.init({name:"maintainer",url:$cfg.baseUrl+"/users/loadAll/?isOperation=1"})},s=function(){p(),f(),$("#b_refresh,#b_search").on("click",function(){p()}),$("#b_add").on("click",function(){h()})},c=function(e){a&&a.fnDestroy();var t=$.extend({},$plugin.datatable_server,{fnServerData:function(t,a,n){var r=$.extend({},$opt.paramConvert(a),$opt.paramFilter({type:1,userId:$.userData.id})),i=$api.get({loading:!1,url:$cfg.baseUrl+"/work/vacationTravel",data:r});$.when(i).done(function(t){e.trigger("loading.hide"),t.success?n($opt.dataConvert(t)):$toast.warning(t.msg)}).fail(function(t){e.trigger("loading.hide"),$toast.error(t)})},aaSorting:[[0,"desc"]],iDisplayLength:5,autoWidth:!1,info:"",columns:[{title:"姓名",data:"name",class:"text-center"},{title:"开始时间",data:"startTime",class:"text-center",render:function(e,t,a){return moment(e).format("YYYY-MM-DD")}},{title:"结束时间",data:"endTime",class:"text-center",render:function(e,t,a){return moment(e).format("YYYY-MM-DD")}},{title:"原因",data:"reason",class:"text-center"},{title:"状态",data:"state",bSortable:!1,fnCreatedCell:function(e,t,a,n,r){var i={0:"bg-orange",10:"bg-red",20:"bg-green"},d={0:"待审批",10:"审批不通过",20:"审批通过"};$(e).html('<div class="mt-5 badge '+i[t]+'">'+d[t]+"</div>")}}]});a=e.find(".table").dataTable(t),this.attach||(e.on("click",".box-add",function(){y(1)}),this.attach=!0)},l=function(e){n&&n.fnDestroy();var t=$.extend({},$plugin.datatable_server,{fnServerData:function(t,a,n){var r=$.extend({},$opt.paramConvert(a),$opt.paramFilter({type:2,userId:$.userData.id})),i=$api.get({loading:!1,url:$cfg.baseUrl+"/work/vacationTravel",data:r});$.when(i).done(function(t){e.trigger("loading.hide"),t.success?n($opt.dataConvert(t)):$toast.warning(t.msg)}).fail(function(t){e.trigger("loading.hide"),$toast.error(t)})},aaSorting:[[0,"desc"]],iDisplayLength:5,autoWidth:!1,info:"",columns:[{title:"姓名",data:"name",class:"text-center"},{title:"开始时间",data:"startTime",class:"text-center",render:function(e,t,a){return moment(e).format("YYYY-MM-DD")}},{title:"结束时间",data:"endTime",class:"text-center",render:function(e,t,a){return moment(e).format("YYYY-MM-DD")}},{title:"原因",data:"reason",class:"text-center"},{title:"状态",data:"state",bSortable:!1,fnCreatedCell:function(e,t,a,n,r){var i={0:"bg-orange",10:"bg-red",20:"bg-green"},d={0:"待审批",10:"审批不通过",20:"审批通过"};$(e).html('<div class="mt-5 badge '+i[t]+'">'+d[t]+"</div>")}}]});n=e.find(".table").dataTable(t),this.attach||(e.on("click",".box-add",function(){y(2)}),this.attach=!0)},u=function(e){r&&r.fnDestroy();var t=$.extend({},$plugin.datatable_server,{fnServerData:function(t,a,n){var r=$.extend({},$opt.paramConvert(a),$opt.paramFilter({userId:$.userData.id})),i=$api.get({loading:!1,url:$cfg.baseUrl+"/users/quit",data:r});$.when(i).done(function(t){e.trigger("loading.hide"),t.success?n($opt.dataConvert(t)):$toast.warning(t.msg)}).fail(function(t){e.trigger("loading.hide"),$toast.error(t)})},aaSorting:[[0,"desc"]],iDisplayLength:5,autoWidth:!1,info:"",columns:[{title:"姓名",data:"name",class:"text-center"},{title:"离职时间",data:"quitTime",class:"text-center",render:function(e,t,a){return moment(e).format("YYYY-MM-DD")}},{title:"原因",data:"reason",class:"text-center"},{title:"状态",data:"state",bSortable:!1,fnCreatedCell:function(e,t,a,n,r){var i={0:"bg-orange",10:"bg-red",20:"bg-green"},d={0:"待审批",10:"审批不通过",20:"审批通过"};$(e).html('<div class="mt-5 badge '+i[t]+'">'+d[t]+"</div>")}}]});r=e.find(".table").dataTable(t),this.attach||(e.on("click",".box-add",q),this.attach=!0)},m=function(e){i&&i.fnDestroy();var t=$.extend({},$plugin.datatable_server,{fnServerData:function(t,a,n){var r=$.extend({},$opt.paramConvert(a),$opt.paramFilter({userId:$.userData.id})),i=$api.get({loading:!1,url:$cfg.baseUrl+"/work/temporary",data:r});$.when(i).done(function(t){e.trigger("loading.hide"),t.success?n($opt.dataConvert(t)):$toast.warning(t.msg)}).fail(function(t){e.trigger("loading.hide"),$toast.error(t)})},aaSorting:[[0,"desc"]],iDisplayLength:5,autoWidth:!1,info:"",columns:[{title:"被代班人",data:"temporaryUserId",class:"text-center",fnCreatedCell:function(e,t,a,n,r){$dict.get("user").then(function(a){$.each(a,function(a,n){n.id===t&&$(e).html(n.name)})})}},{title:"代班人",data:"userId",class:"text-center",fnCreatedCell:function(e,t,a,n,r){$dict.get("user").then(function(a){$.each(a,function(a,n){n.id===t&&$(e).html(n.name)})})}},{title:"开始时间",data:"startTime",class:"text-center",render:function(e,t,a){return moment(e).format("YYYY-MM-DD")}},{title:"结束时间",data:"endTime",class:"text-center",render:function(e,t,a){return moment(e).format("YYYY-MM-DD")}},{title:"原因",data:"reason",class:"text-center"},{title:"操作",data:"id",bSortable:!1,fnCreatedCell:function(e,t,a,n,r){var i=$('<a class="btn btn-danger btn-xs ml-5"><i class="fa fa-trash-o"></i>删除</a>');i.on("click",function(){C(e,t,a,n,r)}),$(e).html("").append(i)}}]});i=e.find(".table").dataTable(t),this.attach||(e.on("click",".box-add",k),this.attach=!0)},f=function(){var t=[{elem:$("#p_panel_1").get(0),data:{title:"我的休假申请"},initFunc:c},{elem:$("#p_panel_1").get(0),data:{title:"我的出差申请"},initFunc:l},{elem:$("#p_panel_1").get(0),data:{title:"我的离职申请"},initFunc:u},{elem:$("#p_panel_1").get(0),data:{title:"我的代班申请"},initFunc:m}],a=$(".panel-list");a.html(""),$.map(t,function(t){var n=t.html||t.elem.innerHTML.replace(/\[\[/g,"{{").replace(/]]/g,"}}"),r=e.compile(n)(t.data||{}),i=$(r);i.on("refresh",function(){$.isFunction(t.initFunc)&&(i.trigger("loading.show"),t.initFunc.apply(t,[i]))}),a.append(i),$.isFunction(t.initFunc)&&(t.attach=!1,t.initFunc.apply(t,[i]))})},p=function(){$("#calendar").fullCalendar({themeSystem:"bootstrap4",locale:"zh-cn",height:600,defaultDate:moment().format("YYYY-MM-DD"),editable:!1,eventLimit:!0,events:[]});var e=function(){var e=$("#calendar").data("fullCalendar").currentDate.format("YYYY-MM"),t=moment(e).add(-1,"month").startOf("month").format("YYYY-MM-DD"),a=moment(e).add(1,"month").endOf("month").format("YYYY-MM-DD"),n=$api.get({url:$cfg.baseUrl+"/work/attendance",data:{startTime:t,endTime:a,userId:$.userData.id}});$.when(n).done(function(e){if(e.success){var t=$.map(e.data,function(e){if(e.toWork||e.state>0){var t=["green","red","orange"];return{title:["签到","请假","出差"][e.state],color:t[e.state],start:0===e.state?e.toWork:e.date}}});$("#calendar").fullCalendar("removeEventSources"),$("#calendar").fullCalendar("addEventSource",t)}else $toast.warning(e.msg)}).fail(function(e){$toast.error(e)})};e(),$("#calendar").on("click",".fc-prev-button",function(){e()}),$("#calendar").on("click",".fc-next-button",function(){e()}),$("#calendar .fc-today-button").on("click",function(){e()})},g=function(e){var t,a=[];t=$dict.initOptions({s2s:!0,elem:"#p_directlyUnder",dict:"addvcd",propText:"addvnm",propId:"addvcd",filter:function(e,t){var a=$.userData.addvcd;return("0000"===a.slice(-4)||"00"===a.slice(-2)&&e.addvcd.slice(0,-2)===a.slice(0,-2)||a===e.addvcd)&&"00"===e.addvcd.slice(-2)}}),a.push(t),t=$dict.initOptions({s2s:!0,elem:"#p_addvcd",dict:"addvcd",propText:"addvnm",propId:"addvcd",filter:function(e,t){var a=$.userData.addvcd;return("0000"===a.slice(-4)||"00"===a.slice(-2)&&e.addvcd.slice(0,-2)===a.slice(0,-2)||a===e.addvcd)&&"00"===e.addvcd.slice(-2)}}),a.push(t),t=$dict.initOptions({elem:"#p_roleId",dict:"role",propText:"name",propId:"id"}),a.push(t),t=$dict.initOptions({elem:"#p_createUserId",dict:"user",propText:"name",propId:"id"}),a.push(t),$.when.apply($,a).done(function(){$.isFunction(e)&&e()})},v={isEnable:1,isApp:0},h=function(){var e=$msg.dialog("peopleAdd",function(e,t){return $(t).find("form").submit(),!1},{title:"新增用户",modalClassName:"modal-lg"});$.when(e).then(function(e){var a=e.find("form");g(function(){a.formData(v),$.updateTextFields(),$("#p_createUserId").parents(".col-md-6").remove(),$("#p_createTime").parents(".col-md-6").remove();var n=$.extend({},d,{submitHandler:function(n){var r={},i=a.formData();$.extend(r,i);var d=$api.post({url:$cfg.baseUrl+"/users/add",data:$opt.paramFilter(r)});$.when(d).done(function(a){a.success?($toast.success(a.msg),e.modal("hide"),$dict.remove("user"),$dict.remove("maintainer"),t.fnUpdate()):$toast.warning(a.msg)}).fail(function(e){$toast.error(e)})}});a.validate(n),a.formDisable(!1)})})},b=function(e){var t,a=[];t=$dict.initOptions({elem:"#p_userId",dict:"maintainer",propText:"name",propId:"id"}),a.push(t),$("#p_startTime").datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:!0,todayBtn:!0,pickerPosition:"bottom-left"}),$("#p_endTime").datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:!0,todayBtn:!0,pickerPosition:"bottom-left"}),$.when.apply($,a).done(function(){$.isFunction(e)&&e()})},T={ignore:".ignore",errorPlacement:function(e,t){e.appendTo(t.parents(".form-group"))},rules:{userId:{required:!0},reason:{required:!0},startTime:{required:!0,startTime:"#p_endTime"},endTime:{required:!0,endTime:"#p_startTime"}},messages:{userId:{required:"请选择申请人"},reason:{required:"原因不能为空"},startTime:{required:"开始时间不能为空",startTime:"开始时间不能大于结束时间"},endTime:{required:"结束时间不能为空",endTime:"结束时间不能小于开始时间"}}},D={userId:$.userData.id},y=function(e){var t=$msg.dialog("vacationAdd",function(e,t){return $(t).find("form").submit(),!1},{title:1===e?"新增请假申请":"新增出差申请"});$.when(t).then(function(t){var r=t.find("form");b(function(){r.formData(D),$.updateTextFields();var i=$.extend({},T,{submitHandler:function(i){var d={type:e,state:0,userId:$.userData.id},o=r.formData();$.extend(d,o);var s=$api.post({url:$cfg.baseUrl+"/work/vacationTravel",data:$opt.paramFilter(d)});$.when(s).done(function(r){r.success?($toast.success(r.msg),t.modal("hide"),1===e?a.fnUpdate():n.fnUpdate()):$toast.warning(r.msg)}).fail(function(e){$toast.error(e)})}});r.validate(i),r.formDisable(!1),r.find("#p_userId").attr("disabled",!0)})})},x=function(e){var t,a=[];t=$dict.initOptions({elem:"#p_userId",dict:"maintainer",propText:"name",propId:"id"}),a.push(t),$("#p_quitTime").datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:!0,todayBtn:!0,pickerPosition:"bottom-left"}),$.when.apply($,a).done(function(){$.isFunction(e)&&e()})},I={ignore:".ignore",errorPlacement:function(e,t){e.appendTo(t.parents(".form-group"))},rules:{userId:{required:!0},reason:{required:!0},quitTime:{required:!0}},messages:{userId:{required:"请选择申请人"},reason:{required:"原因不能为空"},quitTime:{required:"离职时间不能为空"}}},Y={userId:$.userData.id},q=function(){var e=$msg.dialog("quitAdd",function(e,t){return $(t).find("form").submit(),!1},{title:"新增离职申请"});$.when(e).then(function(e){var t=e.find("form");x(function(){t.formData(Y),$.updateTextFields();var n=$.extend({},I,{submitHandler:function(n){var r={type:1,state:0,userId:$.userData.id},i=t.formData();$.extend(r,i);var d=$api.post({url:$cfg.baseUrl+"/users/quit",data:$opt.paramFilter(r)});$.when(d).done(function(t){t.success?($toast.success(t.msg),e.modal("hide"),a.fnUpdate()):$toast.warning(t.msg)}).fail(function(e){$toast.error(e)})}});t.validate(n),t.formDisable(!1),t.find("#p_userId").attr("disabled",!0)})})},w=function(e){var t,a=[];t=$dict.initOptions({elem:"#p_temporaryUserId",dict:"maintainer",propText:"name",propId:"id"}),a.push(t),t=$dict.initOptions({elem:"#p_userId",dict:"maintainer",propText:"name",propId:"id"}),a.push(t),$("#p_startTime").datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:!0,todayBtn:!0,pickerPosition:"bottom-left"}),$("#p_endTime").datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:!0,todayBtn:!0,pickerPosition:"bottom-left"}),$.when.apply($,a).done(function(){$.isFunction(e)&&e()})},_={ignore:".ignore",errorPlacement:function(e,t){e.appendTo(t.parents(".form-group"))},rules:{temporaryUserId:{required:!0},userId:{required:!0,unequalTo:"#p_temporaryUserId"},reason:{required:!0},startTime:{required:!0,startTime:"#p_endTime"},endTime:{required:!0,endTime:"#p_startTime"}},messages:{temporaryUserId:{required:"请选择被代班人"},userId:{required:"请选择代班人",unequalTo:"代班人不能是被代班人"},reason:{required:"原因不能为空"},startTime:{required:"开始时间不能为空",startTime:"开始时间不能大于结束时间"},endTime:{required:"结束时间不能为空",endTime:"结束时间不能小于开始时间"}}},U={temporaryUserId:$.userData.id},k=function(){var e=$msg.dialog("proxyAdd",function(e,t){return $(t).find("form").submit(),!1},{title:"新增代班记录"});$.when(e).then(function(e){var t=e.find("form");w(function(){t.formData(U),$.updateTextFields();var a=$.extend({},_,{submitHandler:function(a){var n={temporaryUserId:$.userData.id},r=t.formData();$.extend(n,r);var d=$api.post({url:$cfg.baseUrl+"/work/temporary",data:$opt.paramFilter(n)});$.when(d).done(function(t){t.success?($toast.success(t.msg),e.modal("hide"),i.fnUpdate()):$toast.warning(t.msg)}).fail(function(e){$toast.error(e)})}});t.validate(a),t.formDisable(!1),t.find("#p_temporaryUserId").attr("disabled",!0)})})},C=function(e,t,a,n,r){$msg.confirm("是否删除该记录?",function(){var e=$api.del({url:$cfg.baseUrl+"/work/temporary/"+a.id});$.when(e).done(function(e){e.success?($toast.success(e.msg),i.fnUpdate()):$toast.warning(e.msg)}).fail(function(e){$toast.error(e)})})};return{data:{model:[{icon:"fa fa-user",title:"个人考勤"}]},init:function(e){console.log(e+":init"),o(),s()},dispose:function(e){console.log(e+":dispose")}}});