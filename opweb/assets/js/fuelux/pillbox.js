!function(t){"function"==typeof define&&define.amd?define(["jquery","fuelux/dropdown-autoflip"],t):"object"==typeof exports?module.exports=t(require("jquery"),require("./dropdown-autoflip")):t(jQuery)}(function(t){if(!t.fn.dropdownautoflip)throw new Error("Fuel UX pillbox control requires dropdown-autoflip.");var e=t.fn.pillbox,i=function(e,i){this.$element=t(e),this.$moreCount=this.$element.find(".pillbox-more-count"),this.$pillGroup=this.$element.find(".pill-group"),this.$addItem=this.$element.find(".pillbox-add-item"),this.$addItemWrap=this.$addItem.parent(),this.$suggest=this.$element.find(".suggest"),this.$pillHTML='<li class="btn btn-default pill">\t<span></span>\t<span class="glyphicon glyphicon-close">\t\t<span class="sr-only">Remove</span>\t</span></li>',this.options=t.extend({},t.fn.pillbox.defaults,i),-1===this.options.readonly?void 0!==this.$element.attr("data-readonly")&&this.readonly(!0):this.options.readonly&&this.readonly(!0),this.acceptKeyCodes=this._generateObject(this.options.acceptKeyCodes),this.$element.on("click.fu.pillbox",".pill-group > .pill",t.proxy(this.itemClicked,this)),this.$element.on("click.fu.pillbox",t.proxy(this.inputFocus,this)),this.$element.on("keydown.fu.pillbox",".pillbox-add-item",t.proxy(this.inputEvent,this)),this.options.onKeyDown&&this.$element.on("mousedown.fu.pillbox",".suggest > li",t.proxy(this.suggestionClick,this)),this.options.edit&&(this.$element.addClass("pills-editable"),this.$element.on("blur.fu.pillbox",".pillbox-add-item",t.proxy(this.cancelEdit,this)))};i.prototype={constructor:i,destroy:function(){return this.$element.remove(),this.$element[0].outerHTML},items:function(){var e=this;return this.$pillGroup.children(".pill").map(function(){return e.getItemData(t(this))}).get()},itemClicked:function(e){var i,l=t(e.target);if(e.preventDefault(),e.stopPropagation(),this._closeSuggestions(),l.hasClass("pill"))i=l;else if(i=l.parent(),void 0===this.$element.attr("data-readonly")){if(l.hasClass("glyphicon-close"))return this.options.onRemove?this.options.onRemove(this.getItemData(i,{el:i}),t.proxy(this._removeElement,this)):this._removeElement(this.getItemData(i,{el:i})),!1;if(this.options.edit){if(i.find(".pillbox-list-edit").length)return!1;this.openEdit(i)}}this.$element.trigger("clicked.fu.pillbox",this.getItemData(i))},readonly:function(t){t?this.$element.attr("data-readonly","readonly"):this.$element.removeAttr("data-readonly"),this.options.truncate&&this.truncate(t)},suggestionClick:function(e){var i=t(e.currentTarget),l={text:i.html(),value:i.data("value")};e.preventDefault(),this.$addItem.val(""),i.data("attr")&&(l.attr=JSON.parse(i.data("attr"))),l.data=i.data("data"),this.addItems(l,!0),this._closeSuggestions()},itemCount:function(){return this.$pillGroup.children(".pill").length},addItems:function(){var e,i,l,s=this;!isFinite(String(arguments[0]))||arguments[0]instanceof Array?(e=[].slice.call(arguments).slice(0),l=e[1]&&!e[1].text):(e=[].slice.call(arguments).slice(1),i=arguments[0]),e[0]instanceof Array&&(e=e[0]),e.length&&(t.each(e,function(t,i){var l={text:i.text,value:i.value?i.value:i.text,el:s.$pillHTML};i.attr&&(l.attr=i.attr),i.data&&(l.data=i.data),e[t]=l}),this.options.edit&&this.currentEdit&&(e[0].el=this.currentEdit.wrap("<div></div>").parent().html()),l&&e.pop(1),s.options.onAdd&&l?this.options.edit&&this.currentEdit?s.options.onAdd(e[0],t.proxy(s.saveEdit,this)):s.options.onAdd(e[0],t.proxy(s.placeItems,this)):this.options.edit&&this.currentEdit?s.saveEdit(e):i?s.placeItems(i,e):s.placeItems(e,l))},removeItems:function(t,e){var i,l,s=this;if(t)for(e=e||1,i=0;i<e&&(l=s.$pillGroup.find("> .pill:nth-child("+t+")"));i++)l.remove();else this.$pillGroup.find(".pill").remove(),this._removePillTrigger({method:"removeAll"})},placeItems:function(){var e,i,l,s,n=[];!isFinite(String(arguments[0]))||arguments[0]instanceof Array?(e=[].slice.call(arguments).slice(0),s=e[1]&&!e[1].text):(e=[].slice.call(arguments).slice(1),i=arguments[0]),e[0]instanceof Array&&(e=e[0]),e.length&&(t.each(e,function(e,i){var l=t(i.el);l.attr("data-value",i.value),l.find("span:first").html(i.text),i.attr&&t.each(i.attr,function(t,e){"cssClass"===t||"class"===t?l.addClass(e):l.attr(t,e)}),i.data&&l.data("data",i.data),n.push(l)}),this.$pillGroup.children(".pill").length>0?i?(l=this.$pillGroup.find(".pill:nth-child("+i+")"),l.length?l.before(n):this.$pillGroup.children(".pill:last").after(n)):this.$pillGroup.children(".pill:last").after(n):this.$pillGroup.prepend(n),s&&this.$element.trigger("added.fu.pillbox",{text:e[0].text,value:e[0].value}))},inputEvent:function(t){var e,i,l,s,n=this,a=this.$addItem.val();if(this.acceptKeyCodes[t.keyCode])return this.options.onKeyDown&&this._isSuggestionsOpen()&&(s=this.$suggest.find(".pillbox-suggest-sel"),s.length&&(a=s.html(),e=s.data("value"),i=s.data("attr"))),(a.replace(/[ ]*\,[ ]*/,"").match(/\S/)||this.options.allowEmptyPills&&a.length)&&(this._closeSuggestions(),this.$addItem.hide(),i?this.addItems({text:a,value:e,attr:JSON.parse(i)},!0):this.addItems({text:a,value:e},!0),setTimeout(function(){n.$addItem.show().val("").attr({size:10})},0)),t.preventDefault(),!0;if(8===t.keyCode||46===t.keyCode){if(!a.length)return t.preventDefault(),this.options.edit&&this.currentEdit?(this.cancelEdit(),!0):(this._closeSuggestions(),l=this.$pillGroup.children(".pill:last"),l.hasClass("pillbox-highlight")?this._removeElement(this.getItemData(l,{el:l})):l.addClass("pillbox-highlight"),!0)}else a.length>10&&this.$addItem.width()<this.$pillGroup.width()-6&&this.$addItem.attr({size:a.length+3});if(this.$pillGroup.find(".pill").removeClass("pillbox-highlight"),this.options.onKeyDown){if(9===t.keyCode||38===t.keyCode||40===t.keyCode)return this._isSuggestionsOpen()&&this._keySuggestions(t),!0;this.callbackId=t.timeStamp,this.options.onKeyDown({event:t,value:a},function(e){n._openSuggestions(t,e)})}},openEdit:function(t){var e=t.index()+1,i=this.$addItemWrap.detach().hide();this.$pillGroup.find(".pill:nth-child("+e+")").before(i),this.currentEdit=t.detach(),i.addClass("editing"),this.$addItem.val(t.find("span:first").html()),i.show(),this.$addItem.focus().select()},cancelEdit:function(t){var e;if(!this.currentEdit)return!1;this._closeSuggestions(),t&&this.$addItemWrap.before(this.currentEdit),this.currentEdit=!1,e=this.$addItemWrap.detach(),e.removeClass("editing"),this.$addItem.val(""),this.$pillGroup.append(e)},saveEdit:function(){var e=arguments[0][0]?arguments[0][0]:arguments[0];this.currentEdit=t(e.el),this.currentEdit.data("value",e.value),this.currentEdit.find("span:first").html(e.text),this.$addItemWrap.hide(),this.$addItemWrap.before(this.currentEdit),this.currentEdit=!1,this.$addItem.val(""),this.$addItemWrap.removeClass("editing"),this.$pillGroup.append(this.$addItemWrap.detach().show()),this.$element.trigger("edited.fu.pillbox",{value:e.value,text:e.text})},removeBySelector:function(){var e=[].slice.call(arguments).slice(0),i=this;t.each(e,function(t,e){i.$pillGroup.find(e).remove()}),this._removePillTrigger({method:"removeBySelector",removedSelectors:e})},removeByValue:function(){var e=[].slice.call(arguments).slice(0),i=this;t.each(e,function(t,e){i.$pillGroup.find('> .pill[data-value="'+e+'"]').remove()}),this._removePillTrigger({method:"removeByValue",removedValues:e})},removeByText:function(){var e=[].slice.call(arguments).slice(0),i=this;t.each(e,function(t,e){i.$pillGroup.find('> .pill:contains("'+e+'")').remove()}),this._removePillTrigger({method:"removeByText",removedText:e})},truncate:function(e){var i,l,s,n,a,o=this;this.$element.removeClass("truncate"),this.$addItemWrap.removeClass("truncated"),this.$pillGroup.find(".pill").removeClass("truncated"),e&&(this.$element.addClass("truncate"),i=this.$element.width(),l=!1,s=0,n=this.$pillGroup.find(".pill").length,a=0,this.$pillGroup.find(".pill").each(function(){var e=t(this);l?e.addClass("truncated"):(s++,o.$moreCount.text(n-s),a+e.outerWidth(!0)+o.$addItemWrap.outerWidth(!0)<=i?a+=e.outerWidth(!0):(o.$moreCount.text(n-s+1),e.addClass("truncated"),l=!0))}),s===n&&this.$addItemWrap.addClass("truncated"))},inputFocus:function(t){this.$element.find(".pillbox-add-item").focus()},getItemData:function(e,i){return t.extend({text:e.find("span:first").html()},e.data(),i)},_removeElement:function(t){t.el.remove(),delete t.el,this.$element.trigger("removed.fu.pillbox",t)},_removePillTrigger:function(t){this.$element.trigger("removed.fu.pillbox",t)},_generateObject:function(e){var i={};return t.each(e,function(t,e){i[e]=!0}),i},_openSuggestions:function(e,i){var l=t("<ul>");if(this.callbackId!==e.timeStamp)return!1;i.data&&i.data.length&&(t.each(i.data,function(e,i){var s=i.value?i.value:i.text,n=t('<li data-value="'+s+'">'+i.text+"</li>");i.attr&&n.data("attr",JSON.stringify(i.attr)),i.data&&n.data("data",i.data),l.append(n)}),this.$suggest.html("").append(l.children()),t(document.body).trigger("suggested.fu.pillbox",this.$suggest))},_closeSuggestions:function(){this.$suggest.html("").parent().removeClass("open")},_isSuggestionsOpen:function(){return this.$suggest.parent().hasClass("open")},_keySuggestions:function(t){var e,i=this.$suggest.find("li.pillbox-suggest-sel"),l=38===t.keyCode;t.preventDefault(),i.length?(e=l?i.prev():i.next(),e.length||(e=l?this.$suggest.find("li:last"):this.$suggest.find("li:first")),e&&(e.addClass("pillbox-suggest-sel"),i.removeClass("pillbox-suggest-sel"))):(i=this.$suggest.find("li:first"),i.addClass("pillbox-suggest-sel"))}},i.prototype.getValue=i.prototype.items,t.fn.pillbox=function(e){var l,s=Array.prototype.slice.call(arguments,1),n=this.each(function(){var n=t(this),a=n.data("fu.pillbox"),o="object"==typeof e&&e;a||n.data("fu.pillbox",a=new i(this,o)),"string"==typeof e&&(l=a[e].apply(a,s))});return void 0===l?n:l},t.fn.pillbox.defaults={onAdd:void 0,onRemove:void 0,onKeyDown:void 0,edit:!1,readonly:-1,truncate:!1,acceptKeyCodes:[13,188],allowEmptyPills:!1},t.fn.pillbox.Constructor=i,t.fn.pillbox.noConflict=function(){return t.fn.pillbox=e,this},t(document).on("mousedown.fu.pillbox.data-api","[data-initialize=pillbox]",function(e){var i=t(e.target).closest(".pillbox");i.data("fu.pillbox")||i.pillbox(i.data())}),t(function(){t("[data-initialize=pillbox]").each(function(){var e=t(this);e.data("fu.pillbox")||e.pillbox(e.data())})})});